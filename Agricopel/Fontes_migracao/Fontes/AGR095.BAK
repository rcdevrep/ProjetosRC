#INCLUDE "AP5MAIL.CH"
#INCLUDE "rwmake.ch"
#INCLUDE "TOPCONN.CH"
#INCLUDE "FWPrintSetup.ch"
#include "TOTVS.CH"   
#INCLUDE "TBICONN.CH"
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±ºPrograma   ³AGR095    ?Autor ?Jean Sérgio Vieira ?Data ? 25/11/03   º±?
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descricao  ?Gerar arquivo texto para emissao de boleto  Banco Brasil   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±?Uso       ?Generico                                                   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Arquivos   ? SA1 - SE1 - SA6                                           ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Alteracoes ?                                                           ³±?
±±³Necessarias?                                                           ³±?
±±?          ?                                                           ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
User Function AGR095
	LOCAL cString := "TRB"
	LOCAL aStru   := {}
	LOCAL cNomCli := space(40)
	LOCAL oXagCon := XagConexao():New()
	
	PRIVATE cBanco,cAgencia,xConteudo
	PRIVATE cPerg     := ""
	PRIVATE nHdlBco   := 0
	PRIVATE nHdlSaida := 0
	PRIVATE nSeq      := 0
	PRIVATE nSomaValor:= 0
	PRIVATE aRotina   := { {OemToAnsi("Imprimir Boleto") , "U_A095Gera" , 0 , 0 },;
						   {OemToAnsi("Boleto por e-mail") , "U_A095Mail(.F.,'')" , 0 , 0 } }  // "Gerar Arquivo"   
	PRIVATE nBorderos := 0
	PRIVATE xBuffer,nLidos := 0
	PRIVATE nTotCnab2 := 0 // Contador de Lay-out nao deletar
	PRIVATE nLinha 	:= 0 // Contador de Linhas nao deletar 
	PRIVATE nNossoNum	:= 0 // Contador de Linhas nao deletar 
	PRIVATE nNossoNumE1 := 0 // Contador de Linhas nao deletar
	PRIVATE cCartei     := ''
	PRIVATE cTipoBol    := ""  
	PRIVATE NqtdBol		:= 0  
	PRIVATE lGerabol    := .T.
	
	DbSelectArea("SM0")
	
	cPerg := "AGR95"+xFilial('SA6')
	/*If cEmpant == "01"
		Do Case
			// Se for Filial Agricopel Matriz/Mime Distrib.
			Case alltrim(cFilAnt) == "01" .OR. alltrim(cFilAnt) == "06"
				cPerg := "AGR95A"
			// Se for Filial Agricopel Pien
			Case alltrim(cFilAnt) == "02"
				cPerg := "AGR95B"
			// Se for Filial Agricopel Filial II 
			Case alltrim(cFilAnt) == "03"
				cPerg := "AGR95C"				
		EndCase	
	Else
		cPerg := "AGR95X"		
	EndIf	
	*/
	
	PRIVATE cCadastro := OemToAnsi("Impressão de Boleto Bancário")  
	
	aRegistros := {}
	AADD(aRegistros,{cPerg,"01","Serie De          ","mv_ch1","C",3,0,0,"G","","mv_par01","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"02","Serie Ate         ","mv_ch2","C",3,0,0,"G","","mv_par02","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"03","Nota De           ","mv_ch3","C",TamSX3("F2_DOC")[1],0,0,"G","","mv_par03","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"04","Nota Ate          ","mv_ch4","C",TamSX3("F2_DOC")[1],0,0,"G","","mv_par04","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"05","Emissao De        ","mv_ch5","D",8,0,0,"G","","mv_par05","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"06","Emissao Ate       ","mv_ch6","D",8,0,0,"G","","mv_par06","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"07","Cliente De        ","mv_ch7","C",6,0,0,"G","","mv_par07","","","","","","","","","","","","","","","CLI"})
	AADD(aRegistros,{cPerg,"08","Cliente Ate       ","mv_ch8","C",6,0,0,"G","","mv_par08","","","","","","","","","","","","","","","CLI"})
	AADD(aRegistros,{cPerg,"09","Loja De           ","mv_ch9","C",2,0,0,"G","","mv_par09","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"10","Loja Ate          ","mv_cha","C",2,0,0,"G","","mv_par10","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"11","% de JUROS ao Mês ","mv_chb","N",TAMSX3("E1_PORCJUR")[01],0,0,"G","","mv_par11","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"12","% de Multa        ","mv_chc","N",TAMSX3("E1_MULTA")[01]  ,0,0,"G","","mv_par12","","","","","","","","","","","","","","",""})
	//AADD(aRegistros,{cPerg,"11","Arq. Configuração ?","mv_ch11","C",20,0,0,"G","","mv_par11","","","","","","","","","","","","","","",""})
	//AADD(aRegistros,{cPerg,"12","Arq. Saída        ?","mv_ch12","C",50,0,0,"G","","mv_par12","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"13","Banco             ","mv_chd","C",3,0,0,"G","","mv_par13","","","","","","","","","","","","","","","SA6BOL"})
	AADD(aRegistros,{cPerg,"14","Agencia   	       ","mv_che","C",5,0,0,"G","","mv_par14","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"15","Conta             ","mv_chf","C",10,0,0,"G","","mv_par15","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"16","Sub-Conta         ","mv_chg","C",3,0,0,"G","","mv_par16","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"17","Carteira          ","mv_chh","C",6,0,0,"G","","mv_par17","","","","","","","","","","","","","","",""}) 
	If cEmpAnt == '01'  //Nyke é utilizado apenas pela agricopel
		AADD(aRegistros,{cPerg,"18","Mostrar	       ","mv_chi","N",1,0,0,"C","","mv_par18","Todos","","","Nyke","","","Exceto Nyke","","","","","","","",""})	
	Else
		AADD(aRegistros,{cPerg,"18","Mostrar	       ","mv_chi","N",1,0,0,"C","","mv_par18","Todos","","","","","","","","","","","","","",""})		
	Endif
	U_CriaPer(cPerg,aRegistros)
	      
	If !Pergunte(cPerg, .T.)
		Return
	Endif
	 
	//Valida se conta pode gerar boletos e mostra a conta selecionada em tela                                                           
	If !ValBanco(MV_PAR13,MV_PAR14,MV_PAR15,MV_PAR16,MV_PAR17 )
		Return
	Endif
	
	// Spiller 01/09/2017
	// Verifica Banco para que nao ocorra do usuario 
	// escolher uma conta erroneamente, ou seja, 
	// gerar boletos bradesco para uma conta do Banco do Brasil
	/*If alltrim(MV_PAR13) <>  '' .and. alltrim(MV_PAR14) <>  '' .and. alltrim(MV_PAR15) <>  '' 
		cTipoBol := U_AGR095RA(MV_PAR13,MV_PAR14,MV_PAR15,MV_PAR16,MV_PAR17)	
		If alltrim(cTipoBol) == 'ERRO'
			Return  
		Endif                  
	Else
		MsgInfo('  Preencha corretamente os dados bancários !    ')
		Return
	Endif    
	*/
	aAdd(aStru,{"OK"	,"C",02,00})
	aAdd(aStru,{"DOC"	,"C",TamSX3("F2_DOC")[1],00})
	aAdd(aStru,{"SERIE"	,"C",03,00})
	aAdd(aStru,{"CLIENTE","C",06,00})
	aAdd(aStru,{"LOJA"	,"C",02,00})
	aAdd(aStru,{"NOMECLI","C",40,00})
	aAdd(aStru,{"EMISSAO","D",08,00})
	
	aCampos := { {"OK"		,".T.","  "     		,"@!"},;
				 {"DOC"		,".T.","Doc"    		,"@!"},;
				 {"SERIE"	,".T.","Serie"			,"@!"},;
				 {"CLIENTE"	,".T.","Cliente"		,"@!"},;
				 {"LOJA"	,".T.","Loja"   		,"@!"},;
				 {"NOMECLI"	,".T.","Nome Cliente","@!"},;
				 {"EMISSAO"	,".T.","Dt. Emissão"	,"@!"} }
	
	if Select('TRB') # 0
		dbSelectArea('TRB')
		dbCloseArea()
	endif
	cArq := CriaTrab(aStru,.T.)
	dbUseArea(.T.,,cArq,cString,.T.)
	cInd := CriaTrab(NIL,.F.)
	IndRegua(cString,cInd,"SERIE+DOC+CLIENTE+LOJA",,,"Selecionando Registros...")
	
		
	cQuery := ""
	cQuery := "SELECT F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA, F2_EMISSAO "
	cQuery += "FROM " + RetSqlName("SF2") + " (NOLOCK) F2 "  
	//Spiller - Trava para nao mostrar Títulos de outros portadores
	cQuery += " LEFT JOIN " + RetSqlName("SE1") + " (NOLOCK) E1 ON E1_FILIAL = '' AND "
	cQuery += "						E1_CLIENTE = F2_CLIENTE AND "
	cQuery += "						E1_LOJA   = F2_LOJA AND "
	cQuery += "						E1_PREFIXO = '"+xfilial('SF2')+"'+Substring(LTRIM(F2_SERIE),1,1) AND "
	cQuery += "						E1_NUM = F2_DOC AND "
	cQuery += "					 	E1.D_E_L_E_T_ = '' "  
	//Fim                                                 
	//Spiller - Trava para nao mostrar Títulos com notas NÃO autorizadas no NfeSEfaz
	cQuery += "LEFT JOIN "  + RetSqlName("SF3") + " (NOLOCK) F3 ON F3_NFISCAL = F2_DOC AND F3_SERIE = F2_SERIE AND F2_FILIAL = F3_FILIAL "
	cQuery += "AND F2_CLIENTE = F3_CLIEFOR AND F2_LOJA = F3_LOJA and F3.D_E_L_E_T_ = '' "            
	//Fim
	cQuery += "WHERE F2.D_E_L_E_T_ <> '*' "
	cQuery += "AND F2_FILIAL = '" + xFilial("SF2") + "' "
	cQuery += "AND F2_EMISSAO >= '" + DTOS(mv_par05) + "' "
	cQuery += "AND F2_EMISSAO <= '" + DTOS(mv_par06) + "' "
	cQuery += "AND F2_SERIE >= '" + mv_par01 + "' "
	cQuery += "AND F2_SERIE <= '" + mv_par02 + "' "
	cQuery += "AND F2_DOC >= '" + mv_par03 + "' "
	cQuery += "AND F2_DOC <= '" + mv_par04 + "' "
	cQuery += "AND F2_CLIENTE >= '" + mv_par07 + "' "
	cQuery += "AND F2_CLIENTE <= '" + mv_par08 + "' "
	cQuery += "AND F2_LOJA >= '" + mv_par09 + "' "
	cQuery += "AND F2_LOJA <= '" + mv_par10 + "' "
	cQuery += "AND F2_XPROJ <> '1' " //Evita que tirem boleto para CTes Raizen   
	If cEmpant == '01'
		If MV_PAR18 == 2 //Mostra Só NYKE
			cQuery += " AND F2_XPROJ = '2' "  
		ElseIf MV_PAR18 == 3 //NÃO Mostra NYKE
			cQuery += " AND F2_XPROJ = '' "
		Endif
	Endif
	cQuery += "AND (F2_COND <> '001' OR F2_ORIIMP LIKE '%AGX635%' ) "//Adequado trecho pois DBGInt sempre grava 001     
	//Spiller - Trava para nao mostrar Títulos de outros portadores
	//cQuery += "AND (E1_PORTADO =  '"+mv_par13+"' OR E1_PORTADO = '' )"   
	cQuery += "AND ( ( E1_PORTADO =  '"+mv_par13+"' AND E1_CONTA ='"+mv_par15+"') OR E1_PORTADO = '' )"   
	//Spiller - Trava para nao mostrar Títulos com notas NÃO autorizadas no NfeSEfaz
	cQuery += " AND (F3_CODRSEF = '100' OR  F3_CODRSEF = ''  OR  F3_CODRSEF IS NULL ) "
	//Fim              
	cQuery += " AND NOT (E1_SITUACA = '0' AND E1_NUMBCO <> '') " //Bloqueio para nao gerar boleto que foi colocado em carteira
	cQuery += "GROUP BY F2_FILIAL, F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA, F2_EMISSAO "
	cQuery += "ORDER BY F2_FILIAL, F2_SERIE, F2_DOC, F2_CLIENTE, F2_LOJA "  

	If Select("MSF2") <> 0
		dbSelectArea("MSF2")
		dbCloseArea()
	Endif
	TCQuery cQuery NEW ALIAS "MSF2"
	TCSetField("MSF2","F2_EMISSAO","D",08,0)
	            
	dbSelectArea("MSF2")
	dbGoTop()
	While !Eof()  
		cNomCli := space(40)
		dbSelectArea("SA1")
		dbSetOrder(1)
		if dbSeek(xFilial("SA1")+MSF2->F2_CLIENTE+MSF2->F2_LOJA)
			cNomCli := SA1->A1_NOME	
		endif    

		//Valida campo de Geração de boletos, inicialmente ativo apenas para empresa 0103		    
		lGerabol := .T.
		IF SA1->(FieldPos("A1_XBOLETO")) > 0      
			If cEmpant == '01' .and. cFilant == '03' .and. alltrim(SA1->A1_XBOLETO) == '3'  
				lGerabol := .F.
			Endif 
		Endif
		
	    //Verifica se pode Gerar boletos para esse Cliente
		IF lGerabol  
			dbSelectArea("TRB")
			RecLock("TRB",.T.)
				TRB->DOC	:= MSF2->F2_DOC
				TRB->SERIE	:= MSF2->F2_SERIE
				TRB->CLIENTE:= MSF2->F2_CLIENTE
				TRB->LOJA	:= MSF2->F2_LOJA
				TRB->NOMECLI:= cNomCli
				TRB->EMISSAO:= MSF2->F2_EMISSAO
			TRB->(MsUnlock())//MsUnlock('TRB')    
		Endif
		
		dbSelectArea("MSF2")
	    DbSkip()
	EndDo
	
	dbSelectArea(cString)
	dbGotop()
	cMarca := GetMark()
	MarkBrow(cString,'OK',,aCampos,, cMarca,'ExecBlock("A095All",.f.,.f.)',,,,'ExecBlock("A095Mark",.f.,.f.)')
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Fecha os Arquivos ASC II                                     ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	FCLOSE(nHdlBco)
	FCLOSE(nHdlSaida)
	
	oXagCon:DescDBG()

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ?AGR095Gera?Autor ?Wagner Xavier         ?Data ?25/11/03 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ?Comunicao Banc ria - Envio  Banco Brasil                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?AGR095Gera(cAlias)                                          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?AGR095                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
User Function A095Gera(cAlias)     

	Processa({|lEnd| A095Ger(cAlias)})  // Chamada com regua
	dbSelectArea("TRB")
	dbGotop()
	nBorderos  := 0
	nSeq       := 0
	nSomaValor := 0 
	CloseBrowse()

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ?AGR095Ger ?Autor ?Wagner Xavier         ?Data ?26/05/92 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ?Comunicao Banc ria - Envio Banco Brasil                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?AGR095Ger()                                                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?AGR095                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Static Function A095Ger(cAlias) 

	LOCAL cSav7,cSav20,cSavCur,nPosAtu:=0,nPosAnt:=0,nTotRegs:=0,nPosCnt:=0
	LOCAL nTamArq:=0,lResp:=.t.
	LOCAL lHeader:=.F.,lFirst:=.F.,cSaveMenuh
	LOCAL nTam,nDec,nUltDisco:=0,nGrava:=0,aBordero:={}
	LOCAL nSavRecno := recno()
	Local cDbf
	Local lFinCnab2  := .F.
	LOCAL oDlg,oBnt,oBmp,nMeter := 1
	LOCAL cTexto := "CNAB"
	LOCAL lFirstBord := .T.
	LOCAL lAchouBord := .F.
	LOCAL cNumBorAnt      
	Local lMarcou    := .F.
	Local _cnumbor   := ""
	Private oPrn := NIL
	
	cMes := Space(01)
	Do Case 
		Case StrZero(Month(dDatabase),2) == "01"
			cMes := "A"
		Case StrZero(Month(dDatabase),2) == "02"
			cMes := "B"
		Case StrZero(Month(dDatabase),2) == "03"
			cMes := "C"
		Case StrZero(Month(dDatabase),2) == "04"
			cMes := "D"
		Case StrZero(Month(dDatabase),2) == "05"
			cMes := "E"
		Case StrZero(Month(dDatabase),2) == "06"
			cMes := "F"
		Case StrZero(Month(dDatabase),2) == "07"
			cMes := "G"
		Case StrZero(Month(dDatabase),2) == "08"
			cMes := "H"
		Case StrZero(Month(dDatabase),2) == "09"
			cMes := "I"
		Case StrZero(Month(dDatabase),2) == "10"
			cMes := "J"
		Case StrZero(Month(dDatabase),2) == "11"
			cMes := "K"																		
		Case StrZero(Month(dDatabase),2) == "12"
			cMes := "L"
	End Case
	
	
	Do Case
		Case MV_PAR13 == "001"//BB
			cNumBorAnt := "A"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)
		Case MV_PAR13 == "237" .And. Alltrim(MV_PAR14) == "04130" .And. Alltrim(MV_PAR15) == "00113948" // Para conta Cauçao cfe Fernando/Financeiro 12/12/2006
			cNumBorAnt := "D"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)		                           
		Case MV_PAR13 == "237"                                                                                                       
			cNumBorAnt := "E"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)	
			//Se for essa conta Bradesco, grava borderô como 1, a Michele nao estava gerando Remessa pra essa conta quando de outras filiais
			IF Alltrim(MV_PAR15) == '00277207' 
		   		cNumBorAnt := "E"+'1'+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)	
			Endif						
		Case MV_PAR13 == "027"//BESC	
			cNumBorAnt := "F"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)
		Case MV_PAR13 == "756"	//SICOOB
			cNumBorAnt := "I"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1) 
		Case mv_par13 == "422"  // Safra Novo	
			cNumBorAnt := "S"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)	
		OtherWise
			cNumBorAnt := "X"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)
		
	End Case
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona no Banco indicado                                  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	cBanco  := mv_par13
	cAgencia:= mv_par14
	cConta  := mv_par15
	cSubCta := mv_par16
	
	dbSelectArea("SA6")
	If !(dbSeek(xFilial("SA6")+cBanco+cAgencia+cConta))
	   //Help(" ",1,"NAOSA6",,"Dados Bancários Incorretos"+chr(13)+"Informe dados validos!",2,1)   
	   APMSGALERT("Dados Bancários Incorretos"+chr(13)+"Informe dados validos!") //Spiller - Não mostrava mensagem em tela
		Return .F.
	Endif 
	     
	//valida Carteira para Banco Bradesco
	if VAL(SA6->A6_CART) <> VAL(MV_PAR17) .AND. alltrim(SA6->A6_COD) <> '756' //alltrim(SA6->A6_CART) == '' .and. SA6->A6_COD = '237'  	
		APMSGALERT("Carteira cadastrada diferente da informada nos parâmetros!! ")
		Return .F.
	Endif        
	
	dbSelectArea("SEE")
	SEE->( dbSeek(cFilial+cBanco+cAgencia+cConta+cSubCta) )
	//12/07/2018 - Semaforo de Usuários 
	If /*alltrim(SEE->EE_XUSER) <> alltrim(cUserName) .and.*/ alltrim(SEE->EE_XUSER) <> ''  //Adequado, pois usuário faturamento é utilizado por varios usuarios
		Alert('O Usuário '+alltrim(SEE->EE_XUSER)+' está utilizando a Rotina, aguarde!' ) 
		Return    
	Else 
		dbselectarea('SEE')
	    Reclock("SEE")
	  		Replace EE_XUSER With alltrim(cUserName)+'('+alltrim(ComputerName())+')'
	   	SEE->(MsUnlock())    
	Endif 
	
	If !SEE->( found() )
		Help(" ",1,"PAR150")
		dbselectarea('SEE')
	    Reclock("SEE")
	  		Replace EE_XUSER With ''
	   	SEE->(MsUnlock()) 
		Return .F.
	Else
		If Val(EE_FAXFIM)-Val(EE_FAXATU) < 100
			Help(" ",1,"FAIXA150")
		Endif
	Endif 
	
	//Valida se tá posicionado no Parâmetro Bancario correto
	IF ! (alltrim(SEE->EE_CONTA) ==  alltrim(cConta) .and. alltrim(SEE->EE_AGENCIA) == alltrim(cAgencia))
		Alert('Parâmetros bancários incorretos!') 
		Conout('AGR095 - Parâmetros bancários incorretos!')
		dbselectarea('SEE')
	    Reclock("SEE")
	  		Replace EE_XUSER With ''
	   	SEE->(MsUnlock()) 
		Return
	Endif   
	
	//Bloqueio de cadastro bancario com menos de 7 digitos do banco do brasil
	/*if alltrim(MV_PAR13) == '001' .and. len(alltrim(SEE->EE_CODEMP)) < 7  
		Alert('Contas antigas do Banco do Brasil devem ser geradas pela rotina Antiga(AGR094)! ')
		Return .F.
	Endif*/
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona no Bordero Informado pelo usuario                  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nTotCnab2 := 0
	nSeq := 0 
	NqtdBol := 0 
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Inicia a leitura do arquivo de Titulos                       ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("TRB")
	dbGotop()
	ProcRegua(TRB->(RecCount()))
	While TRB->(!Eof())
	
		IncProc()
		If !IsMark( "OK", cMarca )
			dbSelectArea("TRB")
			dbSkip()
			Loop
		Endif      
		lMarcou := .T.
		dbSelectArea("SE1")
		SE1->( dbSetOrder(2) )
		SE1->( dbSeek(xFilial("SE1")+TRB->CLIENTE+TRB->LOJA+alltrim(cFilAnt)+Substr(ALLTRIM(TRB->SERIE),1,1)+TRB->DOC,.T.))
		While SE1->( !Eof()) .AND. SE1->E1_FILIAL+SE1->E1_CLIENTE+SE1->E1_LOJA+SE1->E1_PREFIXO+SE1->E1_NUM == xFilial("SE1")+TRB->CLIENTE+TRB->LOJA+alltrim(cFilAnt)+Substr(ALLTRIM(TRB->SERIE),1,1)+TRB->DOC
	           
	    	//Quando usuário utilizar data retroativa, permite apenas impressão de boletos já gerados ou seja reimpressões                                                 
		    If ( (ddatabase <> date()) .and. alltrim(SE1->E1_NUMBCO) == '' )
				 Aviso("AVISO","O Boleto "+AllTrim(SE1->E1_NUM)+" não será GERADO, com database retroativa é permitido apenas a sua REIMPRESSÃO !",{/*"Ok"*/},;
		  		,"Atenção:",,,.T.,5000)
		  		SE1->( dbSkip() )
				Loop  
	        Endif
	
	
			If !Empty(SE1->E1_NUMBOR) .AND. SE1->E1_NUMBOR <> cNumBorAnt 
		   		_cnumbor   := SE1->E1_NUMBOR
			  	SE1->( dbSkip() )
				Loop
			EndIf
	
			IF Alltrim(SE1->E1_TIPO) == "NCC" .Or.;
			   Alltrim(SE1->E1_TIPO) == "NP"  .Or.;
			   Alltrim(SE1->E1_TIPO) == "CH" 		
			   SE1->( dbSkip() )
		       Loop
			Endif
	
			IF Alltrim(SE1->E1_TIPO) <> "NF" 
			   SE1->( dbSkip() )
		       Loop
			Endif
	
			IF SE1->E1_EMISSAO <> TRB->EMISSAO
			   SE1->( dbSkip() )
		      Loop
			Endif
	        
	        //Valida quantidade de Boletos para inicio da impressao    
	       	If nQtdBol == 0 
				oPrn := TMSPrinter():New()	
			Endif
			nQtdBol++
	    
	                       
	        // Spiller - 02.08.2017
	        // Variável nao estava sendo iniciada 
			lAchouBord := .F.           
			
			//SELE SEE
		  	DbSelectarea('SEE')
		  	Dbsetorder(1)
		  	SEE->( dbSeek(xFilial("SEE")+cBanco+cAgencia+cConta+cSubCta) )
		  		
		  	//Valida se tá posicionado no Parâmetro Bancario correto
			IF  alltrim(SEE->EE_CONTA) <>   alltrim(cConta) .or. alltrim(SEE->EE_AGENCIA) <> alltrim(cAgencia) 
				Alert('Parâmetros bancários Incorretos! Entre em contato com a TI!')
				Conout('AGR095 - Parâmetros bancários incorretos!')
				Return
			Endif 
			
			//12.09.2017 - Spiller - Tratamento para erro de nosso numero sem portador
			If Empty(SE1->E1_NUMBCO) .or.  ( Empty(SE1->E1_PORTADO) .AND.  Empty(SE1->E1_NUMBOR))  
				//Spiller - Provavel causa de NN duplicado no banco
			    nNossoNum   := if(Empty(SE1->E1_NUMBCO), Val(NossoNum())+1,alltrim(SE1->E1_NUMBCO)) 
				If alltrim(cbanco) == '237' .or. ( alltrim(cbanco) == '001' .and. len(alltrim(SEE->EE_CODEMP)) < 7 )
			   		nNossoNumE1 := StrZero(nNossoNum,11)+U_AGR095DV(cbanco,MV_PAR17)
			   		nNossoNuEE := StrZero(nNossoNum,12)
			 	Elseif alltrim(cbanco) == '422' 
					nNossoNumE1 := StrZero(nNossoNum,9)
					nNossoNuEE  := nNossoNumE1
				Else
			 		nNossoNuEE := StrZero(nNossoNum,10)
			 		nNossoNumE1 := StrZero(nNossoNum,10)	
			 	Endif
			Else
				lAchouBord := .T.
				nNossoNumE1 := AllTrim(SE1->E1_NUMBCO)
			EndIf 
			
			//BB - conta com menos de 7 Digitos já contem o CodEmp no NN
			If alltrim(cbanco) == '001' .and. len(alltrim(SEE->EE_CODEMP)) < 7
		        nNossoNum := nNossoNumE1
	       	ElseIf alltrim(cbanco) == '422'
	       		nNossoNum := nNossoNumE1
	       	Else
	       	    nNossoNum := Alltrim(SEE->EE_CODEMP) + nNossoNumE1
	       	Endif
	       
			If !lAchouBord 
			  	SELE SE1
		  		RecLock('SE1',.f.)
		  		SE1->E1_PORTADO := cBanco
		  		SE1->E1_AGEDEP  := cAgencia
		  		SE1->E1_CONTA   := cConta
		  		SE1->E1_VENCREA := DATAVALIDA(SE1->E1_VENCREA+SA6->A6_RETENCA,.T.)
		  		se1->e1_numbor  := cNumBorAnt
		  		se1->e1_databor := dDataBase
		  		SE1->E1_NUMBCO  := nNossoNumE1
		  		se1->e1_situaca := '1'
		  		SE1->E1_ZNBANCO := nNossoNum
		  		SE1->E1_HIST    := 'A095Ger '+alltrim(SE1->E1_HIST)
		  		SE1->(MsUnlock())//'SE1')
	
		  		SELE SEA
		  		reclock('SEA',.t.)
		  		sea->ea_filial  := xfilial('SEA')
		  		sea->ea_prefixo := se1->e1_prefixo
		  		sea->ea_num     := se1->e1_num
		  		sea->ea_parcela := se1->e1_parcela
		  		sea->ea_portado := cBanco
		  		sea->ea_agedep  := cAgencia
		  		sea->ea_numcon  := cConta
		  		sea->ea_numbor  := cNumBorAnt
		  		sea->ea_databor := dDataBase
		  		sea->ea_tipo    := se1->e1_tipo
		  		sea->ea_cart    := 'R'
		  		SEA->(msunlock())//'SEA')
		
		  		//SELE SEE
		  		//SEE->( dbSeek(xFilial("SEE")+cBanco+cAgencia+cConta+cSubCta) )
		  		
		  		//Valida se tá posicionado no Parâmetro Bancario correto
				IF  alltrim(SEE->EE_CONTA) <>  alltrim(cConta) .or. alltrim(SEE->EE_AGENCIA) <> alltrim(cAgencia) 
					Alert('Entre em contat com a TI - Erro Parâmetros bancários incorretos!')  
					Conout('AGR095 - Parâmetros bancários incorretos!')
					Return
				Endif 
		  	                   
		  		//Valida Prefixo do NN 
	       		ValidaPref(cBanco,cAgencia,cConta,nNossoNumE1)
		  	
		  		//Valida Nosso Numero
		  		If !(U_AGR095NN(nNossoNum,SE1->E1_NUM,cBanco,cAgencia,cConta,SE1->E1_EMISSAO))
		  		   Return
		  		Endif
			
				RecLock("SEE",.F.)  
					//Só grava nosso numero se ele for maior que o atual
					If nNossoNuEE >= SEE->EE_FAXATU 
						Replace SEE->EE_FAXATU with  nNossoNuEE  
					Else
						Alert('NOSSO NUMERO menor que faixa atual! Entre em contato com a TI e não envie para o cliente! ')
					Endif
				SEE->(MsUnLock())  
				
			Endif
	
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	   		//?Posiciona no cliente                                         ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SA1")
			dbSeek(xFilial("SA1")+SE1->E1_CLIENTE+SE1->E1_LOJA)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		   //?Posiciona no Contrato bancario                               ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SE9")
			dbSetOrder(1)
			dbSeek(xFilial("SE9")+SE1->(E1_CONTRAT+E1_PORTADO+E1_AGEDEP))
			
			dbSelectArea("SE1")    
			
			u_WM095A(MV_PAR13,MV_PAR14,MV_PAR15,MV_PAR16,SE1->E1_PREFIXO,SE1->E1_NUM,cNumBorAnt,MV_PAR10,MV_PAR11)
	
			dbSelectArea("SE1")
			SE1->( dbSkip())
		Enddo
		dbSelectArea("TRB")
		TRB->(dbSkip())
		     
	EndDo 
	
	
	//12/07/2018 - Semaforo de Usuários
	FreeUsedCode()//Libera os Registro da SEE 
	dbselectarea('SEE')
	Reclock("SEE")
	  Replace EE_XUSER With ''
	SEE->(MsUnlock())  
	
	
	//Caso tenha boletos para imprimir
	If nQtdBol > 0  
		oPrn:Preview()
		SetPgEject(.F.)
		MS_Flush()
	Else 
		If !lMarcou
			Msgbox('Marque ao menos um título!  ')
		Else
			Msgbox('Boleto já possui Bordero: '+_cnumbor+', Você deverá entrar com a mesma Database da Geração do Bordero: '+SUBSTR(_cnumbor,3,2)+'/'+NumMes( substr(_cnumbor,5,1) ) )
		Endif
	Endif
	
	
	//If !lAchouBord
	 //	Help(" ",1,"BORD150")
	  //	Return .F.
	//EndIF   
	
	
	MsUnlockAll()
Return(.T.)


Static Function CriaPer(cGrupo,aPer)
*********************************** 

	LOCAL lRetu := .T., aReg  := {}
	LOCAL _l := 1, _m := 1, _k := 1
	
	dbSelectArea("SX1")
	If (FCount() == 41)
		For _l := 1 to Len(aPer)                                   
			Aadd(aReg,{cGrupo,aPer[_l,2],aPer[_l,3],"","",aPer[_l,4],aPer[_l,5],;
			                  aPer[_l,6],aPer[_l,7],aPer[_l,8],aPer[_l,9],aPer[_l,10],;
			                  aPer[_l,11],aPer[_l,12],"","",aPer[_l,13],aPer[_l,14],;
			                  aPer[_l,15],"","",aPer[_l,16],aPer[_l,17],aPer[_l,18],"","",;
			                  aPer[_l,19],aPer[_l,20],aPer[_l,21],"","",aPer[_l,22],;
			                  aPer[_l,23],aPer[_l,24],"","",aPer[_l,25],aPer[_l,26],"","",""})
		Next _l
	ElseIf (FCount() == 39)
		For _l := 1 to Len(aPer)                                   
			Aadd(aReg,{cGrupo,aPer[_l,2],aPer[_l,3],"","",aPer[_l,4],aPer[_l,5],;
			                  aPer[_l,6],aPer[_l,7],aPer[_l,8],aPer[_l,9],aPer[_l,10],;
			                  aPer[_l,11],aPer[_l,12],"","",aPer[_l,13],aPer[_l,14],;
			                  aPer[_l,15],"","",aPer[_l,16],aPer[_l,17],aPer[_l,18],"","",;
			                  aPer[_l,19],aPer[_l,20],aPer[_l,21],"","",aPer[_l,22],;
			                  aPer[_l,23],aPer[_l,24],"","",aPer[_l,25],aPer[_l,26],""})
		Next _l
	Elseif (FCount() == 26)
		aReg := aPer
	Endif
	
	dbSelectArea("SX1")
	For _l := 1 to Len(aReg)
		If !dbSeek(cGrupo+StrZero(_l,02,00))
			RecLock("SX1",.T.)
			For _m := 1 to FCount()
				FieldPut(_m,aReg[_l,_m])
			Next _m
			MsUnlock("SX1")
		Elseif Alltrim(aReg[_l,3]) <> Alltrim(SX1->X1_PERGUNT)
			RecLock("SX1",.F.)
			For _k := 1 to FCount()
				FieldPut(_k,aReg[_l,_k])
			Next _k
			MsUnlock("SX1")
		Endif
	Next _l
Return (lRetu)



// Grava marca no campo
User Function A095Mark
	If IsMark( 'OK', cMarca )
		RecLock( 'TRB', .F. )
		Replace OK With Space(2)
		TRB->(MsUnLock())//'TRB')
	Else
		RecLock( 'TRB', .F. )
		Replace OK With cMarca
		TRB->(MsUnLock())//'TRB')
	EndIf
Return

 

// Grava marca em todos os registros validos
User Function A095All
	Local nRecno := Recno()
	
	dbSelectArea('TRB')
	dbGotop()
	While !Eof()
		ExecBlock('A095Mark',.f.,.f.)
		dbSkip()
	End
	
	dbGoto( nRecno )
Return

***********************************************************************************************************************
User Function WM095A(sPAR01  ,sPAR02  ,sPAR03  ,sPAR04  ,sPAR05         ,sPAR06     ,sPAR07     ,sPAR10  ,sPAR11)
  //				(MV_PAR13,MV_PAR14,MV_PAR15,MV_PAR16,SE1->E1_PREFIXO,SE1->E1_NUM,cNumBorAnt,MV_PAR10,MV_PAR11)
*********************************************************************************************************************** 

	Local sNotFat	:= ""
	
	Private sPAR01,sPAR02,sPAR03,sPAR04,sPAR05,sPAR06,sPAR07,sPar10,sPAR11
	Private cBanco    := ""
	Private cAgencia  := ""
	Private cConta    := ""
	Private cSubConta := ""
	Private cDigitao  := ""
	Private nLastKey  := 0
	Private cPerguntas:= .T.
	Private aBancos   := {}
	Private nPOS	    := 0
	Private cAmbiente := GetEnvServer() 
	Private lProtesto := .T. 
	//Private oPrn := NIL
	
	Private nPAR10 := sPAR10
	Private nPAR11 := sPAR11
	
	Private oFont, cCode
	Private cBarraFim
	Private lTitAnt, dNewVen, nVlrCob 
	
	cBarraImp  := Space(50)
	nHeight    := 15
	lBold      := .F.
	lPixel     := .T.
	lPrint     := .F.
	nSedex     := 1
	MsgInstr01 := " "
	MsgInstr02 := " "
	MsgInstr03 := " "
	
	//Exclusivo Banco
	if sPAR01 == '756'
		AADD(aBancos, {sPAR01,"BANCOOBCED"  	,"SICOOB.BMP"	,sPAR01,sPAR01,SEE->EE_CODEMP ,"" ,"" ,"" ,5,"" })   
	Elseif sPAR01 == '237'
		AADD(aBancos, {sPAR01,"BRADESCO"    	,"BRADESCO.BMP"	,sPAR01+"-2",sPAR01,SEE->EE_CODEMP ,"" ,"" ,"" ,5,"" }) 
	Elseif sPAR01 == '001' 
		AADD(aBancos, {"001","BANCO DO BRASIL"	,"BBRASIL.BMP"	,"001-9","001",alltrim(SEE->EE_CODEMP)/*"2988362"*/ ,"" ,"" ,"" ,5,"" })  
	Elseif sPAR01 == '422' 
		AADD(aBancos, {sPAR01,"BANCO SAFRA S.A"   	,""/*"logo_safra.bmp"*/,sPAR01+"-7","001",alltrim(SEE->EE_CODEMP)/*"2988362"*/ ,"" ,"" ,"" ,5,"" })
	Endif
	oFont1 := TFont():New( "Times New Roman",,08,,.t.,,,,,.f. )
	oFont2 := TFont():New( "Times New Roman",,10,,.t.,,,,,.f. )
	oFont3 := TFont():New( "Times New Roman",,11,,.t.,,,,,.f. )
	oFont4 := TFont():New( "Times New Roman",,13,,.t.,,,,,.f. )
	oFont5 := TFont():New( "Times New Roman",,16,,.t.,,,,,.f. )
	
	oFont6 := TFont():New( "HAETTENSCHWEILLER",,10,,.t.,,,,,.f. )
	
	oFont8 := TFont():New( "Free 3 of 9" ,,44,,.t.,,,,,.f. )
	oFont10:= TFont():New( "Free 3 of 9" ,,38,,.t.,,,,,.f. )
	oFontA:= TFont():New( "Arial"          ,,08,,.f.,,,,,.f. )	
	oFont11:= TFont():New( "Courier New"    ,,10,,.t.,,,,,.f. )
	oFont12:= TFont():New( "Courier New"    ,,11,,.t.,,,,,.f. )
	oFont13:= TFont():New( "Arial"          ,,06,,.f.,,,,,.f. )
	oFont14:= TFont():New( "Courier New"    ,,09,,.T.,,,,,.f. ) 
	oFont14N := TFont():New( "Courier New"  ,,10,,.T.,,,,,.F. )
	oFont15:= TFont():New( "Arial"          ,,10,,.t.,,,,,.f. )
	oFont16:= TFont():New( "Arial"          ,,10,,.f.,,,,,.f. )
	oFont17:= TFont():New( "Arial"          ,,07,,.T.,,,,,.f. )
	oFont18:= TFont():New( "Arial"          ,,09,,.T.,,,,,.f. )
	oFont19:= TFont():New( "Arial"          ,,22,,.t.,,,,,.f. )
	oFont20:= TFont():New( "Arial Black"    ,,15,,.f.,,,,,.f. )
	oFont21:= TFont():New( "Arial"          ,,14,,.f.,,,,,.f. )
	oFont22:= TFont():New( "Arial"          ,,11,,.t.,,,,,.f. )
	oFont23:= TFont():New( "Arial Black"    ,,15.7,,.t.,,,,,.f. )
	oFont24:= TFont():New( "Times New Roman",,16,,.t.,,,,,.f. )
	
	//oPrn := TMSPrinter():New()  //Spiller 02.08.2017
	//oPrn:Setup()
	//oPrn:EndPage()
	//oPrn:StartPage()  
	
	IF sPAR01=="001" .AND. ALLTRIM(sPAR04)<>"001"
		APMSGALERT("Para o banco Banco do Brasil (001) obrigatoriamente a subconta deve ser 001.")
		Return()
	ENDIF 
	
	cAgeImp:=sPAR02
	
	// PESQUISA POR NÚMERO DE TITULO
	cCondicao := "SE1->E1_FILIAL=='"+xFilial("SE1")+"' .AND. SE1->E1_PREFIXO=='"+sPAR05+"' .AND. SE1->E1_NUM=='"+sPAR06+"' "  
	cAbatimento := MVABATIM +"|"+MVFUABT+"|"+MV_CRNEG+"|"+MVRECANT
	cAbatimento := strtran(cAbatimento,"|","','")
	
	
	IF SE1->E1_PORTADO == sPAR01
		cBanco    := SE1->E1_PORTADO
		cAgencia  := SE1->E1_AGEDEP
		cConta	  := SE1->E1_CONTA
		cSubConta := "001" //Posicione("SA6",1,xFilial("SA6")+cBanco+cAgencia+cConta,"A6_SUBCONT")
		
		dbSelectArea("SEE")
		dbSetOrder(1)
		dbSeek(XFILIAL("SEE")+SE1->E1_PORTADO+SE1->E1_AGEDEP+SE1->E1_CONTA+cSubConta)
	ELSE
		APMSGALERT("O boleto para o titulo "+SE1->E1_PREFIXO+"/"+SE1->E1_NUM+"-"+SE1->E1_PARCELA+" não será impresso pois o portador gravado nele ("+SE1->E1_PORTADO+") ?diferente do informado ("+sPAR01+")")
		Return
	ENDIF  
		
	
	// IDENTIFICA O BANCO PARA OBTENÇÃO DOS PARÂMETROS
	// - se não for nenhum dos bancos pr?determinados não imprime o boleto  
	nPOS := ASCAN(aBancos,{|x| x[1]==cBanco})
	
		   
	// OBTÉM CÓDIGO DE CEDENTE DO PARÂMETRO DE BANCO J?POSICIONADO 
	//Exclusivo Banco 
	//if sPAR01 == '756'
	cCodced			:= alltrim(SEE->EE_AGENCIA)//"31259"
	cContaSEE		:= alltrim(SEE->EE_CONTA)//"04908201"
	cConvenio		:= alltrim(SEE->EE_CODEMP)
	//Else
	//	cCodced	   		:= "31259"
	//	cContaSEE		:= "04908201"
	//	cConvenio		:= alltrim(SEE->EE_CODEMP)
	//Endif                              
	
	aBancos[nPOS,5] := ALLTRIM(SEE->EE_SUBCTA)    
	aBancos[nPOS,6] := cCodCed
	cNumBor         := SE1->E1_NUMBOR
		
		
	// atualiza campos nas faturas
	xRECNO    := SE1->(RECNO())
	PREFANT   := SE1->E1_PREFIXO
	NUMANT    := SE1->E1_NUM
	TIPOANT   := SE1->E1_TIPO
	CLIANT    := SE1->E1_CLIENTE
	LOJANT    := SE1->E1_LOJA
	
	MsgInstr01	:= SE1->E1_INSTR1
	MsgInstr02	:= SE1->E1_INSTR2
	//MsgInstr03	:= sPAR12
	
	SA1->(dbSeek(xFilial("SA1")+SE1->E1_CLIENTE+SE1->E1_LOJA,.f.))
	cNome := SA1->A1_NOME
	cCGC  := If(SA1->A1_PESSOA=="F",TRansform(SA1->A1_CGC, "@R 999.999.999-99"),TRansform(SA1->A1_CGC, "@R 99.999.999/9999-99"))
	
	nAbatim	:= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",SE1->E1_MOEDA,dDataBase,SE1->E1_CLIENTE,SE1->E1_LOJA)
	IF SE1->E1_VALJUR == 0.0 .AND. nPAR11 > 0.0 .AND. SE1->E1_SALDO > 0
		RecLock("SE1",.F.)
		Replace SE1->E1_VALJUR 	with Round(SE1->E1_VALOR * (nPAR11/30/100),2)
		Replace SE1->E1_PORCJUR 	with ROUND(nPAR11/30,2)
		SE1->(MsUnlock())
	ENDIF
	
	nJUROS := 0
	IF SE1->E1_VALJUR == 0.0 .AND. SE1->E1_PORCJUR == 0
		nJUROS := (nPAR11/30)/100
		nJUROS := Round(SE1->E1_SALDO * nJUROS,2)
	ELSEIF SE1->E1_VALJUR > 0
		nJUROS	:= SE1->E1_VALJUR
	ELSE 
	    nJUROS	:= Round(SE1->E1_VALOR * (SE1->E1_PORCJUR/100),2)
	ENDIF
	njrs01 := nJUROS
	nJUROS := ALLTRIM(transf(nJUROS,"@E 999,999.99"))
	
	nmulta	:= 0
	IF nPAR11 > 0
		nmulta	:= (nPAR11/100) 
		IF cBanco == "033"
			nmulta	:= NoRound(SE1->E1_VALOR * nmulta,2)
		ELSE
			nmulta	:= Round(SE1->E1_VALOR * nmulta,2)
		ENDIF
	ENDIF
	nmul01 := nmulta
	nmulta := ALLTRIM(transf(nmulta,"@E 999,999.99"))
	
	lTitAnt := .F.
	
		     
	// se titulo j?est?vencido
   	If SE1->E1_VENCREA < Date() .AND. SE1->E1_SALDO > 0	    
   		 Aviso("Título Vencido","O título: "+SE1->E1_NUM+" está vencido! Verifique antes de enviar para o cliente!   ",{/*"Ok"*/},;
   		  ,"Atenção:",,,.T.,5000)  
	Elseif SE1->E1_SALDO == 0
  		 Aviso("Título já BAIXADO ","O título: "+SE1->E1_NUM+" já ESTÁ BAIXADO ou possuí parcelas já baixadas. Verifique!   ",{/*"Ok"*/},;
  		  ,"Atenção:",,,.T.,5000)  
	Endif  
		                          
		/*dDatEmi := SE1->E1_EMISSAO
		dDatVen := SE1->E1_VENCREA//SE1->E1_VENCTO  //SPILLER 14.09.2017 - Mudar para Vencto Real, conversado com Josi
		nVlrSdo := SE1->E1_SALDO
		nTaxJur := mv_par10
		nTaxMul := mv_par11		
		dNewVen := Date()+7 
		cAtuVlr := "N"           
		cDadTit := SE1->E1_PREFIXO + "  " + SE1->E1_NUM + "  " + SE1->E1_PARCELA + "  " + SE1->E1_TIPO
		cDadCli := SE1->E1_CLIENTE + "  " + SE1->E1_LOJA + "  " + SE1->E1_NOMCLI
		If SE1->E1_SITUACA == "0"
		   cSitTit := "0  CARTEIRA"
		Elseif SE1->E1_SITUACA == "1"
		   cSitTit := "1  COBR. SIMPLES"
		Elseif SE1->E1_SITUACA == "2"
		   cSitTit := "2  COBR. DESCONT."
		Elseif SE1->E1_SITUACA == "4"
		   cSitTit := "4  COBR. VINCULAD"
		Else
		   cSitTit := Left(SE1->E1_SITUACA,1,1)
		Endif
	
		@ 150,1 TO 430,490 DIALOG oDlg1 TITLE "ATENÇÃO!!! TÍTULO VENCIDO."
	   
			@ 006,005  To 115,240 Title ""
	
		@ 013,013 Say "Reemissão de boleto com dados atualizados (DT VENCTO E VALOR)." 
		@ 028,013 Say "Titulo: "
		@ 042,013 Say "Cliente: "		
		@ 056,013 Say "Dt. Emissão: "
		@ 056,123 Say "Dt. Vencto Orig: "
	
		@ 070,013 Say "Vlr Título:"
		@ 070,123 Say "Situação:"
		@ 084,013 Say "%Taxa Juros:"
		@ 084,123 Say "%Taxa Multa:"
	
		@ 098,013 Say "Atualiza Valor? "
		@ 098,123 Say "Nova Dt. Vencto: "
		
		@ 027,055 Get cDadTit Size 080,060 When .F.
		@ 041,055 Get cDadCli Size 120,060 When .F.
		@ 055,055 Get dDatEmi Size 045,060 When .F.
		@ 055,170 Get dDatVen Size 045,060 When .F.
		
		@ 069,055 Get nVlrSdo Size 055,060 When .F. Picture "@E 9,999,999.99"
		@ 069,170 Get cSitTit Size 060,060 When .F. 
		@ 083,055 Get nTaxJur Size 030,060 When .F. Picture "@E 99.99"
		@ 083,170 Get nTaxMul Size 030,060 Picture "@E 99.99"		
		
		@ 097,055 Get cAtuVlr Size 020,060 Picture "@!" Valid cAtuVlr $ "SN"
		@ 097,170 Get dNewVen Size 045,060 Valid dNewVen >= dDatVen
		
		@ 121,105 BUTTON "_OK"          SIZE 035,015  ACTION Close(oDlg1)
	
		ACTIVATE DIALOG oDlg1 CENTERED     
	         
		If cAtuVlr == "S"
		   lTitAnt := .T.   
		   nValorMulta := (SE1->E1_SALDO*nTaxJur/100) 
		   nValorMulta := (nValorMulta/30)*(dNewVen-dDatVen)
		   nVlrCob := SE1->E1_SALDO + nmul01 + nValorMulta
		Endif   */
	
	//Endif
		
		
		
	// CALCULA PARÂMETROS PARA CADA BANCO (Linha Digitável, Código de Barras, Nosso Número)
	// - RHO - 03/11/05 - mudança na rotina para considerar Decréscimo e Abatimentos
	CALCVALBOL(cBanco,aBancos,sPar01,sPar02,sPar03)
	dbSelectArea("SEE")
	dbSetOrder(1)
	dbSeek(XFILIAL("SEE") + cBanco + cAgencia + cConta + cSubConta)
	                    
	If lTitAnt
	   cData := DTOC(dNewVen)
	Else   
	   cData := DTOC(SE1->E1_VENCREA) //DTOC(SE1->E1_VENCTO) //SPILLER 14.09.2017 - Mudar para Vencto Real, conversado com Josi
	Endif   
	cData := IIF(LEN(cData) == 8,SUBS(cData,1,6)+"20"+SUBS(cData,7,2),cData)
	cData2 := DTOC(SE1->E1_EMISSAO)
	cData2 := IIF(LEN(cData2) == 8,SUBS(cData2,1,6)+"20"+SUBS(cData2,7,2),cData2)
	cData3 := DTOC(DDATABASE)
	cData3 := IIF(LEN(cData3) == 8,SUBS(cData3,1,6)+"20"+SUBS(cData3,7,2),cData3)
	
	cEndBeneficiario := alltrim(SM0->M0_ENDCOB) + ", " + alltrim(SM0->M0_BAIRCOB) + ", " + alltrim(SM0->M0_CIDCOB)+ ", " +;
	alltrim(SM0->M0_ESTCOB) + " - CEP: " + alltrim(SM0->M0_CEPCOB)
	


	//******************************************
	//  INICIALIZA IMPRESSAO DO BOLETO   
	//******************************************
	oPrn:StartPage()
	nAjust1 := -2100	// Recibo Entrega
	nAjust2 := -1595+70	// Recibo Sacado
	nAjust3 := -600+70		// Ficha de Compensacao
	
	//******************************************
	//  MONTA RECIBO DE ENTREGA    -2110
	//******************************************
	
	// Monta linhas horizontais
	oPrn:Line(2220+nAjust1, 0050, 2220+nAjust1, 2380)
	oPrn:Line(2290+nAjust1, 0050, 2290+nAjust1, 2380)
	oPrn:Line(2360+nAjust1, 0050, 2360+nAjust1, 2380)
	oPrn:Line(2430+nAjust1, 0050, 2430+nAjust1, 2380)
	oPrn:Line(2500+nAjust1, 0050, 2500+nAjust1, 2380)
	oPrn:Line(2570+nAjust1, 0050, 2570+nAjust1, 2380)
	oPrn:Line(2500+nAjust1+80+70, 0050, 2500+nAjust1+80+70, 2380) //
		
	// Monta linha verticais
	oPrn:Line(2135+nAjust1, 0620, 2215+nAjust1, 0620)
	oPrn:Line(2135+nAjust1, 0830, 2215+nAjust1, 0830)
	oPrn:Line(2150+nAjust1+70, 1720, 2500+nAjust1+70, 1720)
	oPrn:Line(2220+nAjust1+70, 1720, 2500+nAjust1+70, 1720)
	
	oPrn:Line(2360+nAjust1+70, 0500, 2500+nAjust1+70, 0500)
	oPrn:Line(2360+nAjust1+70, 0900, 2500+nAjust1+70, 0900)
	oPrn:Line(2360+nAjust1+70, 1100, 2430+nAjust1+70, 1100)
	oPrn:Line(2360+nAjust1+70, 1400, 2500+nAjust1+70, 1400)
	
	IF FILE(aBancos[nPOS,3])
		oPrn:SayBitmap( 2150+nAjust1-22, 0050,aBancos[nPOS,3],400,85 )
	ELSE
		oPrn:Say( 2150+nAjust1, 0050, aBancos[nPOS,2]		,oFont24,100)
	ENDIF
	
	oPrn:Say( 2150+nAjust1, 0640, aBancos[nPOS,4]    ,oFont20,100)
	oPrn:Say( 2150+nAjust1, 0845, aBancos[nPOS,7]    ,oFont4,100)
	oPrn:Say( 2155+nAjust1, 2075, "   Recibo de Entrega",oFont1,100 )
	oPrn:Say( 2225+nAjust1, 0070, "Beneficiário "    ,oFont13,100)
	oPrn:Say( 2225+nAjust1, 1730, "Vencimento "      ,oFont13,100)
	oPrn:Say( 2250+nAjust1, 2040, cData              ,oFont15,100)
	

	oPrn:Say( 2245+nAjust1, 0090, ALLTRIM(SUBS(SM0->M0_NOMECOM,1,50))+" - CNPJ: "+ ALLTRIM(TRANSFORM(SM0->M0_CGC, "@R 99.999.999/9999-99"))			,oFont11,100  )
	oPrn:Say( 2295+nAjust1, 0070, "Endereço "     , oFont13,100  )
	oPrn:Say( 2320+nAjust1, 0090, cEndBeneficiario, oFontA,100  )   
	
	oPrn:Say( 2295+nAjust1, 1730, "Agência/Código Beneficiário "        ,oFont13,100  )  
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2320+nAjust1, 1880, alltrim(cAgencia) +'-'+SEE->EE_DVAGE+ "/" +alltrim(SEE->EE_CODEMP),oFont12,100  ) 
		oPrn:Say( 2460+nAjust1, 1880, alltrim(str(val(aBancos[nPOS,11])))         	,oFont12,100)  	
	ElseIf alltrim(sPAR01) == '237' 
	    if alltrim(SEE->EE_DVAGE) <> ''
	      	cDigitAG := SEE->EE_DVAGE
	    Else
	    	cDigitAG := '0'
	    Endif
		if alltrim(SEE->EE_DVCTA) <> ''
			cDigitCC := SEE->EE_DVCTA
			cCCSemDV := alltrim(cContaSEE)
		Else
	   		cDigitCC := SUBSTR(alltrim(cContaSEE),LEN(alltrim(cContaSEE)),1)
	   		cCCSemDV := substr(  alltrim(cContaSEE) , 1 , len(alltrim(cContaSEE))-1)
		Endif
		oPrn:Say( 2320+nAjust1, 1880, alltrim(cAgencia) +'-'+cDigitAG+ "/" +alltrim(cCCSemDV)+'-'+cDigitCC,oFont12,100  ) 
		oPrn:Say( 2460+nAjust1, 1880, substr(nNossoNumE1,1,11)+'-'+substr(nNossoNumE1,12,1)       	,oFont12,100)  	
	ElseIf alltrim(sPAR01) == '422' 
		oPrn:Say( 2320+nAjust1, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 99999") + "/" + transform(Substr(alltrim(cContaSEE),1,9),"@R 99999999-9"),oFont12,100  )
   		oPrn:Say( 2460+nAjust1, 1880, aBancos[nPOS,8]         	,oFont12,100)
	Else
		oPrn:Say( 2320+nAjust1, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 9999-9") + "/" + transform(Substr(alltrim(cContaSEE),1,8),"@R 9999999-9"),oFont12,100  )
   		oPrn:Say( 2460+nAjust1, 1880, aBancos[nPOS,8]         	,oFont12,100)
   	Endif
   	oPrn:Say( 2390+nAjust1, 1880, ALLTRIM(SE1->E1_CLIENTE) ,oFont12,100  )

    
	oPrn:Say( 2365+nAjust1, 0070, "Pagador: "              ,oFont13,100)
	oPrn:Say( 2365+nAjust1, 1730, "Codigo Pagador "        ,oFont13,100)
	oPrn:Say( 2390+nAjust1, 0090, ALLTRIM(cNome)           ,oFont12,100)
	oPrn:Say( 2435+nAjust1, 0070, "Data Documento"         ,oFont13,100)
	oPrn:Say( 2435+nAjust1, 0510, "N° Documento "         ,oFont13,100)
	oPrn:Say( 2435+nAjust1, 0910, "Especie Doc. "          ,oFont13,100)
	oPrn:Say( 2435+nAjust1, 1110, "Aceite "                ,oFont13,100)
	oPrn:Say( 2435+nAjust1, 1410, "(=) Valor do Documento" ,oFont13,100)
	
	oPrn:Say( 2435+nAjust1, 1730, "Nosso Numero " 		, oFont13,100)
	oPrn:Say( 2460+nAjust1, 0090, cData2  				, oFont12,100)
	oPrn:Say( 2460+nAjust1, 0520, U_AGX531()          	, oFont12,100)
	oPrn:Say( 2460+nAjust1, 0970, "DM"                  , oFont12,100)
	oPrn:Say( 2460+nAjust1, 1210, "Não"                 , oFont12,100) //ACEITE

    IF lTitAnt
		oPrn:Say( 2460+nAjust1, 1440, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
    ELSE
		oPrn:Say( 2460+nAjust1, 1440, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99"), oFont12,100  )
	ENDIF
	             
	oPrn:Say( 2500+nAjust1, 0070, "Recebi(emos) o Boleto"   ,oFont18,100)
	oPrn:Say( 2530+nAjust1, 0070, "de característica acima" ,oFont18,100)
	oPrn:Say( 2500+nAjust1, 0510, "Data "			   		,oFont13,100)
	oPrn:Say( 2500+nAjust1, 0910, "Assinatura "           	,oFont13,100)
	oPrn:Say( 2500+nAjust1, 1410, "Data "                 	,oFont13,100)
	oPrn:Say( 2500+nAjust1, 1730, "Entregador "    		   	,oFont13,100)
	
	//******************************************
	//  MONTA RECIBO DO SACADO +nAjust2
	//******************************************
	
	// Monta linhas horizontais
	oPrn:Line(2220+nAjust2, 0050, 2220+nAjust2, 2380)
	
	oPrn:Line(2290+nAjust2, 0050, 2290+nAjust2, 2380)
	oPrn:Line(2360+nAjust2, 0050, 2360+nAjust2, 2380)
	oPrn:Line(2430+nAjust2, 0050, 2430+nAjust2, 2380)
	oPrn:Line(2500+nAjust2, 0050, 2500+nAjust2, 2380)
	oPrn:Line(2570+nAjust2, 0050, 2570+nAjust2, 2380)
	
	oPrn:Line(2915+nAjust2, 0050, 2915+nAjust2, 2380)
	oPrn:Line(3120+nAjust2, 0050, 3120+nAjust2, 2380)
		
	oPrn:Line(2570+nAjust2, 1720, 2570+nAjust2, 2380)
	oPrn:Line(2640+nAjust2, 1720, 2640+nAjust2, 2380)
	oPrn:Line(2710+nAjust2, 1720, 2710+nAjust2, 2380)
	oPrn:Line(2780+nAjust2, 1720, 2780+nAjust2, 2380) 
	
	// Monta linha verticais
	oPrn:Line(2135+nAjust2, 0620, 2215+nAjust2, 0620)
	oPrn:Line(2135+nAjust2, 0830, 2215+nAjust2, 0830)
	
	oPrn:Line(2150+nAjust2+70, 1720, 2845+nAjust2+70, 1720)
	oPrn:Line(2360+nAjust2+70, 0500, 2430+nAjust2+70, 0500)
	oPrn:Line(2360+nAjust2+70, 0900, 2500+nAjust2+70, 0900)
	oPrn:Line(2360+nAjust2+70, 1100, 2430+nAjust2+70, 1100)
	oPrn:Line(2360+nAjust2+70, 1400, 2500+nAjust2+70, 1400)
	oPrn:Line(2430+nAjust2+70, 0700, 2500+nAjust2+70, 0700)
	
	IF FILE(aBancos[nPOS,3])
		oPrn:SayBitmap( 2150+nAjust2-30, 0050,aBancos[nPOS,3],400,90 )
	ELSE
		oPrn:Say( 2150+nAjust2, 0050, aBancos[nPOS,2]		,oFont24,100)
	ENDIF
	
	oPrn:Say( 2150+nAjust2, 0640, aBancos[nPOS,4]  ,oFont20,100)
	oPrn:Say( 2155+nAjust2, 0870, aBancos[nPOS,7]  ,oFont4,100)
	
	oPrn:Say( 2225+nAjust2, 0070, " 	mento "    ,oFont13,100)
	oPrn:Say( 2225+nAjust2, 1730, "Vencimento "            ,oFont13,100)
	oPrn:Say( 2245+nAjust2, 0090, iif(alltrim(sPAR01) == '422',"PAGÁVEL EM QUALQUER BANCO DO SISTEMA DE COMPENSAÇÃO","PAGÁVEL EM QUALQUER BANCO ATÉ O VENCIMENTO"),oFont22,100  )
	oPrn:Say( 2250+nAjust2, 1900, cData                    ,oFont15,100)
	
	oPrn:Say( 2295+nAjust2, 0070, "Beneficiário  "               ,oFont13,100  )
	oPrn:Say( 2295+nAjust2, 1730, "Agência/Codigo Beneficiário " ,oFont13,100  )   
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2320+nAjust2, 1880, alltrim(cAgencia) +'-'+SEE->EE_DVAGE + "/" +alltrim(SEE->EE_CODEMP),oFont12,100  )
		oPrn:Say( 2390+nAjust2, 1880, alltrim(str(val(aBancos[nPOS,11])))         	, oFont12,100  )  
	ElseIf alltrim(sPAR01) == '237' 
	    if  alltrim(SEE->EE_DVAGE) <> ''
	      	cDigitAG := SEE->EE_DVAGE
	    Else
	    	cDigitAG := '0'
	    Endif
		if alltrim(SEE->EE_DVCTA) <> ''
			cDigitCC := SEE->EE_DVCTA  
			cCCSemDV := alltrim(cContaSEE)
		Else
	   		cDigitCC := SUBSTR(alltrim(cContaSEE),LEN(alltrim(cContaSEE)),1) 
	   		cCCSemDV := substr(  alltrim(cContaSEE) , 1 , len(alltrim(cContaSEE))-1) 
		Endif
		oPrn:Say( 2320+nAjust2, 1880, alltrim(cAgencia) +'-'+cDigitAG+ "/" +alltrim(cCCSemDV)+'-'+cDigitCC,oFont12,100  ) 
		oPrn:Say( 2390+nAjust2, 1880, substr(nNossoNumE1,1,11)+'-'+substr(nNossoNumE1,12,1)         	,oFont12,100) 
	ElseIf alltrim(sPAR01) == '422' 
		oPrn:Say(  2320+nAjust2, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 99999") + "/" + transform(Substr(alltrim(cContaSEE),1,9),"@R 99999999-9"),oFont12,100  )
   		oPrn:Say(  2390+nAjust2, 1880, aBancos[nPOS,8]         	,oFont12,100)		
	Else
		oPrn:Say( 2320+nAjust2, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 9999-9") + "/" + transform(Substr(alltrim(cContaSEE),1,8),"@R 9999999-9"),oFont12,100  )
		oPrn:Say( 2390+nAjust2, 1880, aBancos[nPOS,8]         	, oFont12,100  )
	Endif
	
	oPrn:Say( 2365+nAjust2, 0070, "Endereço "     , oFont13,100  )
	oPrn:Say( 2390+nAjust2, 0090, cEndBeneficiario, oFontA,100  )   	
	oPrn:Say( 2320+nAjust2, 0090, ALLTRIM(SUBS(SM0->M0_NOMECOM,1,50))+" - CNPJ: "+ ALLTRIM(TRANSFORM(SM0->M0_CGC, "@R 99.999.999/9999-99"))			,oFont11,100  )

	
	oPrn:Say( 2435+nAjust2, 0070, "Data Documento "        ,oFont13,100  )
	oPrn:Say( 2435+nAjust2, 0510, "Nº Documento "         ,oFont13,100  )
	oPrn:Say( 2435+nAjust2, 0910, "Especie Doc. "          ,oFont13,100  )
	oPrn:Say( 2435+nAjust2, 1110, "Aceite "                ,oFont13,100  )
	oPrn:Say( 2435+nAjust2, 1410, "Data do Processamento " ,oFont13,100  )
	oPrn:Say( 2365+nAjust2, 1730, "Nosso Numero "          ,oFont13,100  )    

	oPrn:Say( 2460+nAjust2, 0090, cData2       				, oFont12,100  )
	oPrn:Say( 2460+nAjust2, 0520, U_AGX531()   				, oFont12,100  )
	oPrn:Say( 2460+nAjust2, 0970, "DM"		                , oFont12,100  )
	oPrn:Say( 2460+nAjust2, 1230, "Não"						, oFont12,100  )
	oPrn:Say( 2460+nAjust2, 1440, cData3          			, oFont12,100  )

	
	oPrn:Say( 2505+nAjust2, 0070, "Uso do Banco "          ,oFont13,100  )
	oPrn:Say( 2505+nAjust2, 0510, "Carteira "	           ,oFont13,100  )
	oPrn:Say( 2505+nAjust2, 0710, "Especie "               ,oFont13,100  )
	oPrn:Say( 2505+nAjust2, 0910, "Quantidade "            ,oFont13,100  )
	oPrn:Say( 2505+nAjust2, 1410, "Valor "                 ,oFont13,100  )
	oPrn:Say( 2435+nAjust2, 1730, "(=) Valor do Documento" ,oFont13,100  )
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
  		oPrn:Say( 2530+nAjust2, 0540, "1"         			, oFont12,100  )
	ElseIf alltrim(sPAR01) == '237'  .OR. alltrim(sPAR01) == '422' 
  		oPrn:Say( 2530+nAjust2, 0540, cCartei/*"02"*/         			, oFont12,100  )
	Else
		oPrn:Say( 2530+nAjust2, 0540, "17/19"         			, oFont12,100  )
	Endif
	oPrn:Say( 2530+nAjust2, 0745-30, if(cBanco=="399","9 - REAL","R$")           , oFont12,100  )

	IF lTitAnt
		oPrn:Say(2530+nAjust2, 1440, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
    ELSE
		oPrn:Say(2530+nAjust2, 1440, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99"), oFont12,100  )
	ENDIF		

    IF lTitAnt
		oPrn:Say( 2460+nAjust2, 1975, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
    ELSE
		oPrn:Say( 2460+nAjust2, 1975, TRANSF(SE1->E1_SALDO,"@E 999,999.99") , oFont12,100  )
	ENDIF	

	oPrn:Say( 2575+nAjust2, 0070, "Instruções: ",oFont13,100  )
	oPrn:Say( 2505+nAjust2, 1730, "(-) Desconto/Abatimento",oFont13,100  )
	
	IF nAbatim>0
		oPrn:Say( 2530+nAjust2, 1975, TRANSF(nAbatim,"@E 999,999.99") , oFont12,100  )
	ENDIF                                                                                                
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2650+nAjust2, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2680+nAjust2, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )
		oPrn:Say( 2710+nAjust2, 0090, "COBRAR TAXA DE 2% APÓS O VENCIMENTO E JUROS DE MORA 5% AO MÊS." ,oFont14,100  )	
	ElseIf alltrim(sPAR01) == '237' //.And. cEmpant == '01'
		oPrn:Say( 2650+nAjust2, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2680+nAjust2, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )  
		If val(nJuros) >0 
			oPrn:Say( 2710+nAjust2, 0090, "COBRAR JUROS DE MORA R$"+nJuros+" AO DIA." ,oFont14,100  )	
		Endif  
	Elseif alltrim(sPAR01) == '422'
		
		oPrn:Say( 2590+nAjust2, 0090, Iif(SE1->E1_DECRESC > 0,"Conceder desconto de R$ "    +AllTrim(Transform(SE1->E1_DECRESC,"@E 999,999.99"))+" ate o vencimento","") ,oFont14N,100)     
		oPrn:Say( 2620+nAjust2, 0090, Iif(SE1->E1_VALJUR  > 0,"COBRAR JUROS/MORA DIA DE R$ "+AllTrim(Transform(SE1->E1_VALJUR,"@E 999,999.99")),"") ,oFont14N,100)     
		/*oPrint:Say  (760,100 ,aBolText[1]                                      ,oFont10)     
		oPrint:Say  (810,100 ,aBolText[2]                                      ,oFont10)     
		oPrint:Say  (860,100 ,aBolText[3]                                      ,oFont10)    */   
		//Chamado[151830] - Nova conta Safra
		/*oPrn:Say( 2680+nAjust2, 0090,"ESTE BOLETO REPRESENTA DUPLICATA CEDIDA FIDUCIARIAMENTE AO BANCO SAFRA S/A," ,oFont14,100)     
		//oPrn:Say( 2710+nAjust2, 0090,"FICANDO VEDADO O PAGAMENTO DE QUALQUER OUTRA FORMA QUE NÃO ATRAVÉS DO" ,oFont14,100)     
		//oPrn:Say( 2740+nAjust2, 0090,"PRESENTE BOLETO. PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100) */ 
		oPrn:Say( 2710+nAjust2, 0090,"TODAS AS INFORMAÇÕES DESTE BLOQUETO SÃO DE EXCLUSIVA RESPONSABILIDADE DO BENEFICIÁRIO" ,oFont14,100)  
		oPrn:Say( 2740+nAjust2, 0090,"PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100)  
		
	Else
		oPrn:Say( 2650+nAjust2, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2680+nAjust2, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )
		oPrn:Say( 2710+nAjust2, 0090, "COBRAR JUROS DE MORA 6,9% AO MÊS." ,oFont14,100  )  
		If nmulta<>"0,00"
			oPrn:Say( 2740+nAjust2, 0090, "COBRAR MULTA DE 2% APÓS O VENCIMENTO." ,oFont14,100  )
		EndIf 
    Endif
  
    If !Empty(sNotFat)
        IF cBanco == "341" .AND. cAgencia=='01248'
		    oPrn:Say( 2830+nAjust2, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
        ELSEIF cBanco == "341"
		    oPrn:Say( 2830+nAjust2, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
        ELSEIF cBanco=="745" 
	        oPrn:Say( 2830+nAjust2, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
	    ELSE
	        oPrn:Say( 2800+nAjust2, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
	    ENDIF
	EndIf
	
	If !Empty(SE1->E1_HIST)
        IF cBanco=="341" .AND. cAgencia=='01248'
		    oPrn:Say( 2860+nAjust2, 0090, SE1->E1_HIST             ,oFont18,100  )	
        ELSEIF cBanco=="341"
		    oPrn:Say( 2860+nAjust2, 0090, SE1->E1_HIST             ,oFont18,100  )	
        ELSEIF cBanco=="745" 
	        oPrn:Say( 2860+nAjust2, 0090, SE1->E1_HIST             ,oFont18,100  )	
	    ELSE
	        oPrn:Say( 2830+nAjust2, 0090, SE1->E1_HIST             ,oFont18,100  )	
	    ENDIF
	Else 
	    If nAbatim > 0 
	    
			dbSelectArea("SE1")
			_HistAbatim := ''
			nRecn := Recno()
			nInd  := dbSetOrder()
			sReg  := xFilial("SE1")+SE1->E1_PREFIXO+SE1->E1_NUM+SE1->E1_PARCELA+"AB-"
			dbSetOrder(1)
			DbSeek(sReg)
			If Found()
	      		_HistAbatim := SE1->E1_HIST
			Endif         
			dbSelectArea("SE1")
			dbSetOrder(nInd)
			DbGoto(	nRecn )
	         
	        If !Empty(_HistAbatim)	    
			    oPrn:Say( 2770+nAjust2, 0090, "* VLR ABATIM: "+AllTrim(_HistAbatim)+" *"       ,oFont18,100  )	 
			Endif    
	    Endif
	Endif	
	
	oPrn:Say( 2575+nAjust2, 1730, "(-) Outras deduções "   ,oFont13,100  )
	
	IF SE1->E1_DECRESC>0
		oPrn:Say( 2600+nAjust2, 1975, TRANSF(SE1->E1_DECRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2645+nAjust2, 1730, "(+) Mora/Multa/Juros "  ,oFont13,100  )
	oPrn:Say( 2715+nAjust2, 1730, "(+) Outros Acrecimos "  ,oFont13,100  )
	
	IF SE1->E1_ACRESC>0
		oPrn:Say( 2740+nAjust2, 1975, TRANSF(SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2785+nAjust2, 1730, "(=) Valor Cobrado "     ,oFont13,100  )
	
	IF (SE1->E1_DECRESC+nAbatim+SE1->E1_ACRESC)>0
		oPrn:Say( 2800+nAjust2, 1975, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF

	oPrn:Say( 2920+nAjust2, 0070, "Pagador "                 ,oFont13,100  )
	oPrn:Say( 2955+nAjust2, 0090, ALLTRIM(SE1->E1_CLIENTE) + " - " + ALLTRIM(cNome) + " - " +cCgc, oFont12,100)
	
	IF  Empty(SA1->A1_ENDCOB)
		oPrn:Say( 2995+nAjust2, 0090, ALLTRIM(SA1->A1_END), oFont12,100)
		oPrn:Say( 3035+nAjust2, 0090, TRANSFORM(SA1->A1_CEP,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRRO)+" - "+ALLTRIM(SA1->A1_MUN)+" - "+SA1->A1_EST, oFont12,100  )
	ELSE
		oPrn:Say( 2995+nAjust2, 0090, ALLTRIM(SA1->A1_ENDCOB), oFont12,100)
		oPrn:Say( 3035+nAjust2, 0090, TRANSFORM(SA1->A1_CEPC,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRROC)+" - "+ALLTRIM(SA1->A1_MUNC)+" - "+SA1->A1_ESTC, oFont12,100  )
	ENDIF
	
	cCNPJFilial = SM0->M0_CGC//'05097311000134'
	oPrn:Say( 3080+nAjust2, 0070, "Beneficiário "                 ,oFont13,100  )
	oPrn:Say( 3070+nAjust2, 0190, ALLTRIM(SM0->M0_NOMECOM)+" - "+TRANSFORM(ALLTRIM(cCNPJFilial), "@R 99.999.999/9999-99"), oFont14,100  ) //oPrn:Say( 3000+nAjust2, 0190, SM0->M0_NOMECOM		, oFont12,100  ) //Alterado 14/12/2011 - BRUNO
	
	oPrn:Say( 60+3060+nAjust2, 1600, "Autenticação Mecânica"   ,oFont1,100  )  
	oPrn:Say( 3060+nAjust2, 1950, "Recibo do Pagador"    	,oFont3,100  )
	
	//******************************************
	//  MONTA FICHA COMPENSAÇÃO    +nAjust3
	//******************************************
	
	// Monta linhas horizontais
	oPrn:Line(2220+nAjust3+70, 0050, 2220+nAjust3+70, 2380)
	oPrn:Line(2290+nAjust3+70, 0050, 2290+nAjust3+70, 2380)
	oPrn:Line(2360+nAjust3+70, 0050, 2360+nAjust3+70, 2380)
	oPrn:Line(2430+nAjust3+70, 0050, 2430+nAjust3+70, 2380)
	oPrn:Line(2500+nAjust3+70, 0050, 2500+nAjust3+70, 2380)
	oPrn:Line(2570+nAjust3+70, 0050, 2570+nAjust3+70, 2380) 
	
	oPrn:Line(2845+nAjust3+140, 0050, 2845+nAjust3+140, 2380)
	oPrn:Line(3050+nAjust3+140, 0050, 3050+nAjust3+140, 2380)
	
	oPrn:Line(2570+nAjust3+140, 1720, 2570+nAjust3+140, 2380)
	oPrn:Line(2640+nAjust3+140, 1720, 2640+nAjust3+140, 2380)
	oPrn:Line(2710+nAjust3+140, 1720, 2710+nAjust3+140, 2380)
	
	// Monta linha verticais
	oPrn:Line(2135+nAjust3+70, 0620, 2215+nAjust3+70, 0620)
	oPrn:Line(2135+nAjust3+70, 0830, 2215+nAjust3+70, 0830)
	
	oPrn:Line(2220+nAjust3+70, 1720, 2915+nAjust3+70, 1720)
	oPrn:Line(2360+nAjust3+140, 0500, 2500+nAjust3+140, 0500)
	oPrn:Line(2360+nAjust3+140, 0900, 2500+nAjust3+140, 0900)
	oPrn:Line(2360+nAjust3+140, 1100, 2430+nAjust3+140, 1100)
	oPrn:Line(2360+nAjust3+140, 1400, 2500+nAjust3+140, 1400)
	oPrn:Line(2430+nAjust3+140, 0700, 2500+nAjust3+140, 0700)
	
	IF FILE(aBancos[nPOS,3])
		oPrn:SayBitmap( 2150+nAjust3-15+50, 0050,aBancos[nPOS,3],400,90 )
	ELSE
		oPrn:Say( 2150+nAjust3+70, 0050, aBancos[nPOS,2]  ,oFont24,100)
	ENDIF
	
	oPrn:Say( 2150+nAjust3+70, 0640, aBancos[nPOS,4] ,oFont20,100)
	oPrn:Say( 2155+nAjust3+70, 0870, aBancos[nPOS,7] ,oFont4, 100)
	
	oPrn:Say( 2225+nAjust3+70, 0070, "Local de Pagamento "    ,oFont13,100  )
	oPrn:Say( 2225+nAjust3+70, 1730, "Vencimento "            ,oFont13,100  )
	oPrn:Say( 2245+nAjust3+70, 0090, iif(alltrim(sPAR01) == '422',"PAGÁVEL EM QUALQUER BANCO DO SISTEMA DE COMPENSAÇÃO","PAGÁVEL EM QUALQUER BANCO ATÉ O VENCIMENTO"),oFont22,100  )
	oPrn:Say( 2250+nAjust3+70, 1900, cData     ,oFont15,100  )
	
	oPrn:Say( 2295+nAjust3+70, 0070, "Beneficiário "                ,oFont13,100)
	oPrn:Say( 2295+nAjust3+70, 1730, "Agência/Codigo Beneficiário " ,oFont13,100)
	
	oPrn:Say( 2365+nAjust3+70, 0070, "Endereço "     , oFont13,100)
	oPrn:Say( 2390+nAjust3+70, 0090, cEndBeneficiario, oFontA,100)
	

	oPrn:Say( 2320+nAjust3+70, 0090, ALLTRIM(SUBS(SM0->M0_NOMECOM,1,50))+" - CNPJ: "+ALLTRIM(TRANSFORM(SM0->M0_CGC, "@R 99.999.999/9999-99"))		,oFont11,100  )
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
		oPrn:Say(  2320+nAjust3+70, 1880, alltrim(cAgencia) +'-'+SEE->EE_DVAGE+ "/" +alltrim(SEE->EE_CODEMP),oFont12,100  )
		oPrn:Say( 2390+nAjust3+70,  1880, alltrim(str(val(aBancos[nPOS,11])))         	, oFont12,100  )
	ElseIf alltrim(sPAR01) == '237' 
	    if alltrim(SEE->EE_DVAGE) <> ''
	      	cDigitAG := SEE->EE_DVAGE
	    Else
	    	cDigitAG := '0'
	    Endif
		if alltrim(SEE->EE_DVCTA) <> ''
			cDigitCC := SEE->EE_DVCTA
			cCCSemDV := alltrim(cContaSEE)
		Else
	   		cDigitCC := SUBSTR(alltrim(cContaSEE),LEN(alltrim(cContaSEE)),1)  
	   		cCCSemDV := substr(  alltrim(cContaSEE) , 1 , len(alltrim(cContaSEE))-1)  
		Endif
		oPrn:Say( 2320+nAjust3+70, 1880, alltrim(cAgencia) +'-'+cDigitAG+ "/" +alltrim(cCCSemDV)+'-'+cDigitCC,oFont12,100  ) 
		oPrn:Say( 2390+nAjust3+70, 1880, substr(nNossoNumE1,1,11)+'-'+substr(nNossoNumE1,12,1)         	,oFont12,100) 
	Elseif alltrim(sPAR01) == '422'
		oPrn:Say( 2320+nAjust3+70, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 99999") + "/" + transform(Substr(alltrim(cContaSEE),1,9),"@R 99999999-9"),oFont12,100  )
    	oPrn:Say( 2390+nAjust3+70,  1880, aBancos[nPOS,8]         	, oFont12,100  )
	Else
		oPrn:Say( 2320+nAjust3+70, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 9999-9") + "/" + transform(Substr(alltrim(cContaSEE),1,8),"@R 9999999-9"),oFont12,100  )
    	oPrn:Say( 2390+nAjust3+70,  1880, aBancos[nPOS,8]         	, oFont12,100  )
    Endif
    
	oPrn:Say( 2365+nAjust3+140, 0070, "Data Documento "        ,oFont13,100  )
	oPrn:Say( 2365+nAjust3+140, 0510, "Nº Documento "         ,oFont13,100  )
	oPrn:Say( 2365+nAjust3+140, 0910, "Especie Doc. "          ,oFont13,100  )
	oPrn:Say( 2365+nAjust3+140, 1110, "Aceite "                ,oFont13,100  )
	oPrn:Say( 2365+nAjust3+140, 1410, "Data do Processamento " ,oFont13,100  )
	oPrn:Say( 2365+nAjust3+70,  1730, "Nosso Numero"           ,oFont13,100  )

	oPrn:Say( 2390+nAjust3+140, 0090, cData2       				, oFont12,100  )
	oPrn:Say( 2390+nAjust3+140, 0520, U_AGX531()		        , oFont12,100  )
	oPrn:Say( 2390+nAjust3+140, 0970, "DM" 						, oFont12,100  )
	oPrn:Say( 2390+nAjust3+140, 1210, "Não"     				, oFont12,100  )
	oPrn:Say( 2390+nAjust3+140, 1440, cData3          			, oFont12,100  )


	oPrn:Say( 2435+nAjust3+140, 0070, "Uso do Banco "          ,oFont13,100  )
	oPrn:Say( 2435+nAjust3+140, 0510, "Carteira "			   ,oFont13,100  )
	
	oPrn:Say( 2435+nAjust3+140, 0710, "Especie "               ,oFont13,100  )
	oPrn:Say( 2435+nAjust3+140, 0910, "Quantidade "            ,oFont13,100  )
	oPrn:Say( 2435+nAjust3+140, 1410, "Valor "                 ,oFont13,100  )
	oPrn:Say( 2435+nAjust3+70, 1730, "(=) Valor do Documento " ,oFont13,100  )
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
  		oPrn:Say( 2460+nAjust3+140, 0540, "1"         			, oFont12,100  ) 
    ElseIf alltrim(sPAR01) == '237' .OR.  alltrim(sPAR01) == '422'
  		oPrn:Say( 2460+nAjust3+140, 0540, cCartei/*"02"*/         			, oFont12,100  )
	Else
		oPrn:Say( 2460+nAjust3+140, 0540, "17/19"            			, oFont12,100  ) 
	Endif
	oPrn:Say( 2460+nAjust3+140, 0745-30, if(cBanco=="399","9 - REAL","R$")                , oFont12,100  )
	
	IF lTitAnt
		oPrn:Say(2460+nAjust3+140, 1440, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
    ELSE
		oPrn:Say(2460+nAjust3+140, 1440, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99"), oFont12,100  )
	ENDIF		
	
    IF lTitAnt
		oPrn:Say( 2460+nAjust3+70, 1975, TRANSF(nVlrCob,"@E 999,999.99") , oFont12,100  )
    ELSE
		oPrn:Say( 2460+nAjust3+70, 1975, TRANSF(SE1->E1_SALDO,"@E 999,999.99") , oFont12,100  )
	ENDIF	
	
	
	oPrn:Say( 2505+nAjust3+140, 0070, "Instruções "             ,oFont13,100  )
	oPrn:Say( 2505+nAjust3+70, 1730, "(-) Desconto/Abatimento " ,oFont13,100  )
	
	IF nAbatim>0
		oPrn:Say( 2530+nAjust3+70, 1975, TRANSF(nAbatim,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	//Exclusivo Banco   
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2580+nAjust3+140, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2610+nAjust3+140, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )
		oPrn:Say( 2640+nAjust3+140, 0090, "COBRAR TAXA DE 2% APÓS O VENCIMENTO E JUROS DE MORA 5% AO MÊS." ,oFont14,100  )	
	ElseIf alltrim(sPAR01) == '237' //.And. cEmpant == '01'
		oPrn:Say( 2580+nAjust3+140, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2610+nAjust3+140, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  ) 
		If val(nJuros) > 0 
			oPrn:Say( 2640+nAjust3+140, 0090, "COBRAR JUROS DE MORA R$"+nJuros+" AO DIA." ,oFont14,100  )	
		Endif                                                                                                                    
	Elseif alltrim(sPAR01) == '422' 	
	   
		oPrn:Say( 2520+nAjust3+140, 0090, Iif(SE1->E1_DECRESC > 0,"Conceder desconto de R$ "    +AllTrim(Transform(SE1->E1_DECRESC,"@E 999,999.99"))+" ate o vencimento","") ,oFont14N,100)     
		oPrn:Say( 2550+nAjust3+140, 0090, Iif(SE1->E1_VALJUR  > 0,"COBRAR JUROS/MORA DIA DE R$ "+AllTrim(Transform(SE1->E1_VALJUR,"@E 999,999.99")),"") ,oFont14N,100)     
		/*oPrint:Say  (760,100 ,aBolText[1]                                      ,oFont10)     
		oPrint:Say  (810,100 ,aBolText[2]                                      ,oFont10)     
		oPrint:Say  (860,100 ,aBolText[3]                                      ,oFont10)    */   
		//Chamado[151830] - Nova conta Safra
		/*oPrn:Say( 2610+nAjust3+140, 0090, "ESTE BOLETO REPRESENTA DUPLICATA CEDIDA FIDUCIARIAMENTE AO BANCO SAFRA S/A," ,oFont14,100)     
		oPrn:Say( 2640+nAjust3+140, 0090,"FICANDO VEDADO O PAGAMENTO DE QUALQUER OUTRA FORMA QUE NÃO ATRAVÉS DO" ,oFont14,100)     
		oPrn:Say( 2670+nAjust3+140, 0090,"PRESENTE BOLETO. PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100) 
		*/                                                             
		oPrn:Say( 2640+nAjust3+140, 0090,"TODAS AS INFORMAÇÕES DESTE BLOQUETO SÃO DE EXCLUSIVA RESPONSABILIDADE DO BENEFICIÁRIO",oFont14,100)  
		oPrn:Say( 2670+nAjust3+140, 0090,"PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100)  		
	Else
		oPrn:Say( 2580+nAjust3+140, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2610+nAjust3+140, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )
		oPrn:Say( 2640+nAjust3+140, 0090, "COBRAR JUROS DE MORA 6,9% AO MÊS" ,oFont14,100  )  
		If nmulta<>"0,00"
			oPrn:Say( 2670+nAjust3+140, 0090, "COBRAR MULTA DE 2% APÓS O VENCIMENTO." ,oFont14,100  )
		EndIf
    Endif
   

	IF !Empty(sNotFat)
  		IF cBanco=="341" .AND. cAgencia=='01248'
		    oPrn:Say( 2760+nAjust3+140, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
        ELSEIF cBanco=="745" 
	        oPrn:Say( 2760+nAjust3+140, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
	    ELSE
	        oPrn:Say( 2730+nAjust3+140, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
	    ENDIF        
	ENDIF

	If !Empty(SE1->E1_HIST)
        IF cBanco=="341" .AND. cAgencia=='01248'
		    oPrn:Say( 2860+nAjust3+70, 0090, SE1->E1_HIST             ,oFont18,100  )	
        ELSEIF cBanco=="745" 
	        oPrn:Say( 2860+nAjust3+70, 0090, SE1->E1_HIST             ,oFont18,100  )	
	    ELSE
	        oPrn:Say( 2830+nAjust3+70, 0090, SE1->E1_HIST             ,oFont18,100  )	
	    ENDIF
	Else 
	    If nAbatim > 0 
	    
			dbSelectArea("SE1")
			_HistAbatim := ''
			nRecn := Recno()
			nInd  := dbSetOrder()
			sReg  := xFilial("SE1")+SE1->E1_PREFIXO+SE1->E1_NUM+SE1->E1_PARCELA+"AB-"
			dbSetOrder(1)
			DbSeek(sReg)
			If Found()
	      		_HistAbatim := SE1->E1_HIST
			Endif         
			dbSelectArea("SE1")
			dbSetOrder(nInd)
			DbGoto(	nRecn )
	         
	        If !Empty(_HistAbatim)	    
			    oPrn:Say( 2770+nAjust3+70, 0090, "* VLR ABATIM: "+AllTrim(_HistAbatim)+" *"       ,oFont18,100  )	 
			Endif    
	    Endif
	Endif	
		
	oPrn:Say( 2575+nAjust3+70, 1730, "(-) Outras deduções "   ,oFont13,100  )
	
	IF SE1->E1_DECRESC>0
		oPrn:Say( 2600+nAjust3+70, 1975, TRANSF(SE1->E1_DECRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2645+nAjust3+70, 1730, "(+) Mora/Multa/Juros "  ,oFont13,100  )
	oPrn:Say( 2715+nAjust3+70, 1730, "(+) Outros Acrecimos "  ,oFont13,100  )
	
	IF SE1->E1_ACRESC>0
		oPrn:Say( 2730+nAjust3+70, 1975, TRANSF(SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2785+nAjust3+70, 1730, "(=) Valor Cobrado "     ,oFont13,100  )
	
	IF (SE1->E1_DECRESC+nAbatim+SE1->E1_ACRESC)>0
		oPrn:Say( 2805+nAjust3+70, 1975, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF

	oPrn:Say( 2850+nAjust3+140, 0070, "Pagador "                 ,oFont13,100  )
	oPrn:Say( 2885+nAjust3+140, 0090, ALLTRIM(SE1->E1_CLIENTE) + " - " + ALLTRIM(cNome)+" - " +cCgc, oFont12,100  )
	
	IF  Empty(SA1->A1_ENDCOB) 
		oPrn:Say( 2925+nAjust3+140, 0090, ALLTRIM(SA1->A1_END), oFont12,100)
		oPrn:Say( 2965+nAjust3+140, 0090, TRANSFORM(SA1->A1_CEP,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRRO)+" - "+ALLTRIM(SA1->A1_MUN)+" - "+SA1->A1_EST, oFont12,100  )
	ELSE
		oPrn:Say( 2925+nAjust3+140, 0090, ALLTRIM(SA1->A1_ENDCOB), oFont12,100)
		oPrn:Say( 2965+nAjust3+140, 0090, TRANSFORM(SA1->A1_CEPC,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRROC)+" - "+ALLTRIM(SA1->A1_MUNC)+" - "+SA1->A1_ESTC, oFont12,100  )
	ENDIF
	
	//oPrn:Say( 3000+nAjust3+140+5, 0250, ALLTRIM(SM0->M0_NOMECOM)+" - "+TRANSFORM(ALLTRIM(SM0->M0_CGC), "@R 99.999.999/9999-99"), oFont12,100)
	oPrn:Say( 3010+nAjust3+140, 0070, "Sacador / Avalista: "    ,oFont13,100)
	oPrn:Say( 3220+nAjust3+120, 1450, "Autenticação Mecânica" ,oFont3 ,100)
	oPrn:Say( 3220+nAjust3+120, 1950, "Ficha de Compensação"  ,oFont3 ,100)

	nPosBar	:= 23        
	MSBAR("INT25" ,nPosBar , 1.0 ,cbarraFim,oPrn,.F.,NIL,.T.,0.025,1.3,.F.,NIL,NIL,LPRINT)

	oPrn:Line(2520+200+170, 0050, 2520+200+170, 2380)
	oPrn:Say( 2525+200+170, 1950, "Cortar Aqui"  ,oFont13,100  ) //nAjuste3
	oPrn:Say( 1600,1950, "Cortar Aqui"              ,oFont13,100  ) //nAjuste2   
	IF cBanco<>'422'
		oPrn:Say( 560,1950, "Cortar Aqui"    ,oFont13,100  ) //nAjuste1
	ENDIF
	

oPrn:EndPage()
//oPrn:Preview()
//SetPgEject(.F.)
//MS_Flush()

RETURN(.t.)

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±³Funo    ?CALCVALBOL?Autor ?RAFAEL OGEDA         ?Data ?23/04/05 ³±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±³Descrio ?Faz o Calculo dos Parâmetros de cada banco                 ³±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?DALQUIM                                                    º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Static FUNCTION CALCVALBOL(cBanco,aBancos,sPar01,sPar02,sPar03)

	Local _DtVenc   
	   
	If lTitAnt
	   _DtVenc := dNewVen
	Else
	   _DtVenc := SE1->E1_VENCREA//SE1->E1_VENCTO//SPILLER 14.09.2017 - Mudar para Vencto Real, conversado com Josi
	Endif
	
	cFatorVen	:= strzero(_DtVenc-CTOD("07/10/1997"),4)
	cLinha		:= ""
	If sPAR01 == "237" .And. sPAR03 == "0076000519" 
	   nPOS := 1  
	ElseIf sPAR01 == "237" .And. sPAR03 == "0076001302"   
	   nPOS := 2
	ElseIf sPAR01 == "745" .And. sPAR03 == "3499590014"
	   nPOS := 6
	ElseIf sPAR01 == "745" .And. sPAR03 == "3499590012"
	   nPOS := 7
	Else
	   nPOS := ASCAN(aBancos,{|x| x[1]==cBanco})  
	Endif
	
	IF lTitAnt
		nSaldo := nVlrCob
	ELSE
		nSaldo := SE1->E1_SALDO - SE1->E1_DECRESC - nAbatim + SE1->E1_ACRESC
	ENDIF	
	       
	//Exclusivo Banco
	IF cBanco=="001" 
	    
	    //########## IMPORTANTE ##########
	    //Tratativa para banco do brasil 
		//contas NOVAS com Codigo empresa de 7 posições
		If len(alltrim(SEE->EE_CODEMP)) == 7
			cValor  := StrZero(100 * nSaldo,10)
			cCartei	:= STRZERO(val(MV_PAR17),2)//cCartei	:= "17"
			
		/*			
			Posição Tamanho Picture Conteúdo
			01 a 03 03 9(3) Código do Banco na Câmara de Compensação = ?01?
			04 a 04 01 9(1) Código da Moeda = '9'
			05 a 05 01 9(1) DV do Código de Barras (Anexo VI)
			06 a 09 04 9(04) Fator de Vencimento (Anexo IV)
			10 a 19 10 9(08) V(2) Valor
			20 a 25 06 9(6) Zeros
			26 a 42 17 9(17) Nosso Número, sem o DV
			26 a 32 9(7) Número do Convênio fornecido pelo Banco (CCCCCCC)
			33 a 42 9(10) Complemento do Nosso-Número, sem DV (NNNNNNNNNN)
			43 a 44 02 9(2) Tipo de Carteira/Modalidade de Cobrança
		*/
			cLinha	:= ""	
			strmult := "4329876543298765432987654329876543298765432"
			sBarra  := "001" + "9" + cFatorVen + cValor + "000000" +  nNossoNum + cCartei//"17"
			BaseDiv := 0
			For xx := 1 To 43
				BaseDiv := BaseDiv+Val(Subs(sBarra,xx,1))*Val(Subs(strmult,xx,1))
			Next xx
			resto  := BaseDiv % 11
			dig001 := 11 - resto
			dig001 := STR(IIF(dig001>9 .or. dig001==0,1,dig001),1,0)
			sBarra	:= "001" + "9" + dig001 + cFatorVen + cValor + "000000" +  nNossoNum + cCartei//"17"
			cBarraFim := Alltrim(sBarra)    
		
			// Calculo da linha digit?
			sDigi1 := "001"+"9"+Subs(cBarraFim,20,5)  	// 10412.1510	+X
			sDigi2 := Subs (cBarraFim,25,10)								// 90051.05001	+X
			sDigi3 := Subs (cBarraFim,35,10)								// 13008.00040	+X
			sDigi1 := cDigi(sDigi1)
			sDigi2 := cDigi(sDigi2)
			sDigi3 := cDigi(sDigi3)
			sDigi1 := Subs(sDigi1,1,5)+"."+Subs(sDigi1,6,5)+" "
			sDigi2 := Subs(sDigi2,1,5)+"."+Subs(sDigi2,6,6)+" "
			sDigi3 := Subs(sDigi3,1,5)+"."+Subs(sDigi3,6,6)+" "
			sDigit := sDigi1+sDigi2+sDigi3+dig001+" "+cFatorVen+cValor		  
		
			// Linha Digitável
			aBancos[nPOS,7] := sDigit
			// Nosso Número
			aBancos[nPOS,8] := nNossoNum
			// Código de Barras
			aBancos[nPOS,9] := cBarraFim 
			 
	    Else //Conta antiga(AGR094) Se não for de 7 posições 
	    
			cValor  := StrZero(100 * nSaldo,10)
			cCartei	:= STRZERO(val(MV_PAR17),2)//"17"
	
			cLinha	:= ""	
			strmult := "4329876543298765432987654329876543298765432"
			sBarra  := "001"+;
					    "9" +;
					    cFatorVen+;
					    cValor +;
					    substr(nNossoNum,1,11) +;
					    SUBSTR(ALLTRIM(str(val(SEE->EE_AGENCIA))),1,len(ALLTRIM(SEE->EE_AGENCIA))-1)+; 
					    STRZERO(val(SUBSTR(ALLTRIM(SEE->EE_CONTA),1,len(ALLTRIM(SEE->EE_CONTA))-1)),8)+; //Conta sem DV
					    cCartei
			BaseDiv := 0
			For xx := 1 To 43
				BaseDiv := BaseDiv+Val(Subs(sBarra,xx,1))*Val(Subs(strmult,xx,1))
			Next xx
			resto  := BaseDiv % 11
			dig001 := 11 - resto
			dig001 := STR(IIF(dig001>9 .or. dig001==0,1,dig001),1,0)
			sBarra	:= "001";
					+ "9" ;
					+ dig001 ;
					+ cFatorVen;
					+ cValor ;
					+ substr(nNossoNum,1,11);
					+SUBSTR(ALLTRIM(str(val(SEE->EE_AGENCIA))),1,len(ALLTRIM(SEE->EE_AGENCIA))-1);
					+STRZERO(val(SUBSTR(ALLTRIM(SEE->EE_CONTA),1,len(ALLTRIM(SEE->EE_CONTA))-1)),8); //Conta sem DV
					+STRZERO(val(MV_PAR17),2)// "17"
			cBarraFim := Alltrim(sBarra)    
		
			// Calculo da linha digit?
			sDigi1 := "001"+"9"+Subs(cBarraFim,20,5)  	// 10412.1510	+X
			sDigi2 := Subs (cBarraFim,25,10)								// 90051.05001	+X
			sDigi3 := Subs (cBarraFim,35,10)								// 13008.00040	+X
			sDigi1 := cDigi(sDigi1)
			sDigi2 := cDigi(sDigi2)
			sDigi3 := cDigi(sDigi3)
			sDigi1 := Subs(sDigi1,1,5)+"."+Subs(sDigi1,6,5)+" "
			sDigi2 := Subs(sDigi2,1,5)+"."+Subs(sDigi2,6,6)+" "
			sDigi3 := Subs(sDigi3,1,5)+"."+Subs(sDigi3,6,6)+" "
			sDigit := sDigi1+sDigi2+sDigi3+dig001+" "+cFatorVen+cValor		  
		
			// Linha Digitável
			aBancos[nPOS,7] := sDigit
			// Nosso Número
			aBancos[nPOS,8] := nNossoNum
			// Código de Barras
			aBancos[nPOS,9] := cBarraFim 
			    
	    Endif
	Elseif cBanco=="756"
	
		cValor  := StrZero(100 * nSaldo,10)
		cCartei	:= "1"
		
	/*			
		Posição Tamanho Picture Conteúdo
		01 a 03 03 9(3) Código do Banco na Câmara de Compensação = ?01?
		04 a 04 01 9(1) Código da Moeda = '9'
		05 a 05 01 9(1) DV do Código de Barras (Anexo VI)
		06 a 09 04 9(04) Fator de Vencimento (Anexo IV)
		10 a 19 10 9(08) V(2) Valor
		20 a 25 06 9(6) Zeros
		26 a 42 17 9(17) Nosso Número, sem o DV
		26 a 32 9(7) Número do Convênio fornecido pelo Banco (CCCCCCC)
		33 a 42 9(10) Complemento do Nosso-Número, sem DV (NNNNNNNNNN)
		43 a 44 02 9(2) Tipo de Carteira/Modalidade de Cobrança
	*/
		cLinha	:= ""	
		//strmult:="3197319731973197319731973197319731973197319"   
		strmult := "4329876543298765432987654329876543298765432" 
		aBancos[nPOS,11] := u_AGX636('NOSSONUM')
		           //Banco  moeda Fator       valor  (carteira) (coopera)  (Modal)   (cliente+nosso Num) parcela   
		sBarra  := cBanco + "9" + cFatorVen + cValor + "1"+alltrim(sPar02) +"01"+alltrim(SEE->EE_CODEMP) + aBancos[nPOS,11] +"0" +   u_AGX636('PARCELA')
		
		//Cria Digito Verificador
		BaseDiv := 0
		For xx := 1 To 43
			BaseDiv := BaseDiv+Val(Subs(sBarra,xx,1))*Val(Subs(strmult,xx,1))
		Next xx
		resto  := BaseDiv % 11
		dig001 := 11 - resto
		dig001 := STR(IIF(dig001>9 .or. dig001==0,1,dig001),1,0) 
		   
		//Inclui digito Verificador do Codbar
		sBarra := substr(sBarra,1,4)+dig001+substr(sBarra,5,len(sbarra))	
		//sBarra	:= cBanco + "9" + "1"/*dig001*/ + cFatorVen + cValor + "000000" +  nNossoNum + "17"
		cBarraFim := Alltrim(sBarra)    
	
		// Calculo da linha digit?
		sDigi1 := cBanco+"9"+Subs(cBarraFim,20,5)  	// 10412.1510	+X
		sDigi2 := Subs (cBarraFim,25,10)								// 90051.05001	+X
		sDigi3 := Subs (cBarraFim,35,10)								// 13008.00040	+X
		sDigi1 := cDigi(sDigi1)
		sDigi2 := cDigi(sDigi2)
		sDigi3 := cDigi(sDigi3)
		sDigi1 := Subs(sDigi1,1,5)+"."+Subs(sDigi1,6,5)+" "
		sDigi2 := Subs(sDigi2,1,5)+"."+Subs(sDigi2,6,6)+" "
		sDigi3 := Subs(sDigi3,1,5)+"."+Subs(sDigi3,6,6)+" "
		sDigit := sDigi1+sDigi2+sDigi3+dig001+" "+cFatorVen+cValor		  
	
		// Linha Digitável
		aBancos[nPOS,7] := sDigit
		// Nosso Número
		aBancos[nPOS,8] := nNossoNum
		// Código de Barras
		aBancos[nPOS,9] := cBarraFim 
	   
	// BRADESCO
	Elseif cBanco=="237"    
	
		cValor  := StrZero(100 * nSaldo,10)
		cCartei	:= STRZERO(val(MV_PAR17),2)//"02"
		
	/*			
		Posição Tamanho Picture Conteúdo
		01 a 03 03 9(3) Código do Banco na Câmara de Compensação = ?01?
		04 a 04 01 9(1) Código da Moeda = '9'
		05 a 05 01 9(1) DV do Código de Barras (Anexo VI)
		06 a 09 04 9(04) Fator de Vencimento (Anexo IV)
		10 a 19 10 9(08) V(2) Valor
		20 a 25 06 9(6) Zeros
		26 a 42 17 9(17) Nosso Número, sem o DV
		26 a 32 9(7) Número do Convênio fornecido pelo Banco (CCCCCCC)
		33 a 42 9(10) Complemento do Nosso-Número, sem DV (NNNNNNNNNN)
		43 a 44 02 9(2) Tipo de Carteira/Modalidade de Cobrança
	*/
		cLinha	:= ""	
		strmult := "4329876543298765432987654329876543298765432"
		//sBarra  := "237" + "9" + cFatorVen + cValor + "000000" +  nNossoNum + "02" 
		sBarra	:= "237" ; //banco
				 + "9" ;   //Moeda//+ dig001 ;//Dígito
				 + cFatorVen;//Fator Vencimento
				 + cValor ; //Valor
				 + SUBSTR(ALLTRIM(str(val(SEE->EE_AGENCIA))),1,len(ALLTRIM(SEE->EE_AGENCIA))-1);  //Agencia sem DV
				 + cCartei ; //Carteira
				 + substr(nNossoNumE1,1,11) ; //Nosso Num sem DV
				 + STRZERO(val(SUBSTR(ALLTRIM(SEE->EE_CONTA),1,len(ALLTRIM(SEE->EE_CONTA))-1)),7); //Conta sem DV
				 + "0"  //ZERO   
	
		BaseDiv := 0
		For xx := 1 To 43
			BaseDiv := BaseDiv+Val(Subs(sBarra,xx,1))*Val(Subs(strmult,xx,1))
		Next xx
		resto  := BaseDiv % 11
		dig001 := 11 - resto
		dig001 := STR(IIF(dig001>9 .or. dig001==0,1,dig001),1,0) 
		//dig001   := NnBradesco(VAL(substr(nNossoNumE1,1,11)))
		//Inclui digito Verificador do Codbar
		sBarra := substr(sBarra,1,4)+dig001+substr(sBarra,5,len(sbarra))	
		 
		
		/*sBarra	:= "237" ; //banco
				 + "9" ;   //Moeda
				 + dig001 ;//Dígito
				 + cFatorVen;//Fator Vencimento
				 + cValor ; //Valor
				 + SUBSTR(ALLTRIM(str(val(SEE->EE_AGENCIA))),1,len(ALLTRIM(SEE->EE_AGENCIA))-1);  //Agencia sem DV
				 + cCartei ; //Carteira
				 + nNossoNumE1 ; //Nosso Num sem DV
				 + SUBSTR(ALLTRIM(SEE->EE_CONTA),1,len(ALLTRIM(SEE->EE_CONTA))-1); //Conta sem DV
				 + "0"  //ZERO*/
		
		cBarraFim := Alltrim(sBarra)    
	
		// Calculo da linha digit?
		sDigi1 := "237"+"9"+Subs(cBarraFim,20,5)  	// 10412.1510	+X
		sDigi2 := Subs (cBarraFim,25,10)								// 90051.05001	+X
		sDigi3 := Subs (cBarraFim,35,10)								// 13008.00040	+X
		sDigi1 := cDigi(sDigi1)
		sDigi2 := cDigi(sDigi2)
		sDigi3 := cDigi(sDigi3)
		sDigi1 := Subs(sDigi1,1,5)+"."+Subs(sDigi1,6,5)+" "
		sDigi2 := Subs(sDigi2,1,5)+"."+Subs(sDigi2,6,6)+" "
		sDigi3 := Subs(sDigi3,1,5)+"."+Subs(sDigi3,6,6)+" "
		sDigit := sDigi1+sDigi2+sDigi3+dig001+" "+cFatorVen+cValor		  
	
		// Linha Digitável
		aBancos[nPOS,7]  := sDigit
		// Nosso Número
		aBancos[nPOS,8]  := nNossoNum
		// Código de Barras
		aBancos[nPOS,9]  := cBarraFim  
		//Nosso Numero Sem agencia
		aBancos[nPOS,11] := nNossoNumE1
		
	ElseIf cBanco=="422" 
		
		//Fator Vencimento - POSICAO DE 06 A 09
		cFatVenc := STRZERO(SE1->E1_VENCREA - CtoD("07/10/1997"),4)
		
		//Calcula e adequa campo Valor 
		_nVlrAbat   :=  SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",1,,SE1->E1_CLIENTE,SE1->E1_LOJA)
		nValor = (SE1->E1_SALDO -_nVlrAbat)
		blvalorfinal := strzero(int(nValor*100),10)
	
	
		cNossoSafra := ALLTRIM(nNossoNum)
		cCartei	:= STRZERO(val(MV_PAR17),2)
	    cNossoNum := substr(cCartei,2,2) + "" +  SUBSTR(Str(Year(dDatabase),4),3,2) +  cNossoSafra
		cCpoLivre := "7"+Substr(SEE->EE_AGENCIA,1,4)+Substr(SEE->EE_AGENCIA,5,1)+StrZero(Val(SEE->EE_CONTA),9)+cNossoSafra+"2"//substr(cCartei,2,2)//+ALLTRIM(cDigito)
		
		cNumAux := cNossoSafra  
		
		//Dados para Calcular o Dig Verificador Geral
		cCBSemDig := cBanco+"9" + cFatVenc + blvalorfinal + cCpoLivre
		//cCBSemDig:=  substr(cCBSemDig,1,43)
		//Codigo de Barras Completo
		cCodBarra := cBanco+"9" + Modulo11(cCBSemDig) + cFatVenc + blvalorfinal + cCpoLivre

		cBarraFim := alltrim(cCodBarra)
		
		//Digito Verificador do Primeiro Campo                  
		cPrCpo := cBanco+"9" + SubStr(cCodBarra,20,5)
		cDvPrCpo := AllTrim(Str(Modulo10(cPrCpo)))

		//Digito Verificador do Segundo Campo
		cSgCpo := SubStr(cCodBarra,25,10)
		cDvSgCpo := AllTrim(Str(Modulo10(cSgCpo)))

		//Digito Verificador do Terceiro Campo
		cTrCpo := SubStr(cCodBarra,35,10)
		cDvTrCpo := AllTrim(Str(Modulo10(cTrCpo)))

		//Digito Verificador Geral
		cDvGeral := SubStr(cCodBarra,5,1)

		//Linha Digitavel
		cLindig := SubStr(cPrCpo,1,5) + "." + SubStr(cPrCpo,6,4) + cDvPrCpo + " "   //primeiro campo
		cLinDig += SubStr(cSgCpo,1,5) + "." + SubStr(cSgCpo,6,5) + cDvSgCpo + " "   //segundo campo
		cLinDig += SubStr(cTrCpo,1,5) + "." + SubStr(cTrCpo,6,5) + cDvTrCpo + " "   //terceiro campo
		cLinDig += " " + cDvGeral              //dig verificador geral
		cLinDig += "  " + SubStr(cCodBarra,6,4)+SubStr(cCodBarra,10,10)  // fator de vencimento e valor nominal do titulo
		//Return({cCodBarra,cLinDig,cNossoNum, cNumAux})
		
		// Linha Digitável
		aBancos[nPOS,7]  := cLinDig
		// Nosso Número
		aBancos[nPOS,8]  := nNossoNum
		// Código de Barras
		aBancos[nPOS,9]  := cBarraFim  
		//Nosso Numero Sem agencia
		aBancos[nPOS,11] := nNossoNum
	
	Endif     
	 
Return


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±?
±±ºFuno    ³cDigi     ?Autor ?RAFAEL OGEDA       ?Data ? 08/05/03   º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºDescrio ?                                                           º±?
±±?         ?                                                           º±?
±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±?
±±ºUso       ?Programa principal                                         º±?
±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Static Function cDigi(cVal)

	lBase  := Len(cVal)
	umdois := 2
	sumdig := 0
	auxi   := 0
	iDig := lBase
	Do While iDig >= 1
		auxi   := VAL(Subs(cVal,idig,1))*umdois
		sumdig := SumDig+IIF(auxi<10,auxi,INT(auxi/10)+auxi%10)
		umdois := 3-umdois
		iDig   := iDig-1
	Enddo
	auxi   := STR(Round(sumdig/10+0.49,0)*10-sumdig,1,0)

Return (cVal+auxi)       




/////////////////////////////////////////////////////////////////////////////
////////////    ROTINAS PARA EMISSÃO DE BOLETOS POR E-MAIL   ////////////////
/////////////////////////////////////////////////////////////////////////////
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ?AGR095Mail?Autor ?Wagner Xavier         ?Data ?25/11/03 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ?Comunicao Banc ria - Envio  Banco Brasil                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?AGR095Gera(cAlias)                                          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?AGR095                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
User Function A095Mail(xAuto,xFrom)

	Local cStartPath := GetSrvProfString("Startpath","")    
	
	CONOUT('A095Mail')
	Processa({|lEnd| A095Env(xAuto,xFrom)})  // Chamada com regua
	dbSelectArea("TRB")
	dbGotop() 
	nBorderos  := 0
	nSeq       := 0
	nSomaValor := 0 
	If !xAuto 
		CloseBrowse()
	Endif
Return .T.


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ?AGR095Ger ?Autor ?Wagner Xavier         ?Data ?26/05/92 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ?Comunicao Banc ria - Envio Banco Brasil                  ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?AGR095Ger()                                                 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?AGR095                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
Static Function A095Env(xAuto,xFrom)      

	Local cSav7,cSav20,cSavCur,nPosAtu:=0,nPosAnt:=0,nTotRegs:=0,nPosCnt:=0
	Local nTamArq:=0,lResp:=.t.
	Local lHeader:=.F.,lFirst:=.F.,cSaveMenuh
	Local nTam,nDec,nUltDisco:=0,nGrava:=0,aBordero:={}
	Local nSavRecno := recno()
	Local cDbf
	Local lFinCnab2  := .F.
	Local oDlg,oBnt,oBmp,nMeter := 1
	Local cTexto := "CNAB"
	Local lFirstBord := .T.
	Local lAchouBord := .F.
	Local cNumBorAnt 
	Local cFile 	 := ""//'NF'+AlltoChar(Alltrim(xFilial("SE1")+SE1->E1_PREFIXO+SE1->E1_NUM+SE1->E1_PARCELA)) 
	Local lMarcou    := .F.   
	Local _cnumbor   := "" 
	Local nQtdBol    := 0 
	Local   cCliente := ""
	Local   cLoja 	 := ""  
	Local   aRecnoE1   := {} 
	Private cPath 	 := "" 
	Private oPrn      := NIL 
	Private cF2_XPROJ := "" 
	Private lEnvioMail := .F.
	
	Default xAuto    := .F.  
	//Default xMail    := ''  
	Default xFrom    := ''
	  
	cMes := Space(01)
	Do Case 
		Case StrZero(Month(dDatabase),2) == "01"
			cMes := "A"
		Case StrZero(Month(dDatabase),2) == "02"
			cMes := "B"
		Case StrZero(Month(dDatabase),2) == "03"
			cMes := "C"
		Case StrZero(Month(dDatabase),2) == "04"
			cMes := "D"
		Case StrZero(Month(dDatabase),2) == "05"
			cMes := "E"
		Case StrZero(Month(dDatabase),2) == "06"
			cMes := "F"
		Case StrZero(Month(dDatabase),2) == "07"
			cMes := "G"
		Case StrZero(Month(dDatabase),2) == "08"
			cMes := "H"
		Case StrZero(Month(dDatabase),2) == "09"
			cMes := "I"
		Case StrZero(Month(dDatabase),2) == "10"
			cMes := "J"
		Case StrZero(Month(dDatabase),2) == "11"
			cMes := "K"																		
		Case StrZero(Month(dDatabase),2) == "12"
			cMes := "L"
	End Case
	
	
	Do Case
		Case MV_PAR13 == "001" //BB
			cNumBorAnt := "A"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)
		Case MV_PAR13 == "237" .And. Alltrim(MV_PAR14) == "04130" .And. Alltrim(MV_PAR15) == "00113948" // Para conta Cauçao cfe Fernando/Financeiro 12/12/2006
			cNumBorAnt := "D"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)		                           
		Case MV_PAR13 == "237"                                                                                                       
			cNumBorAnt := "E"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)
			//Se for essa conta Bradesco, grava borderô como 1, a Michele nao estava gerando Remessa pra essa conta quando de outras filiais
			IF Alltrim(MV_PAR15) == '00277207' 
		   		cNumBorAnt := "E"+'1'+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)	
			Endif		
		Case MV_PAR13 == "027" //BESC
			cNumBorAnt := "F"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)
		Case MV_PAR13 == "756" //SICOOB
			cNumBorAnt := "I"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)
		Case mv_par13 == "422"  // Safra Novo	
			cNumBorAnt := "S"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)	
		OtherWise
			cNumBorAnt := "X"+Substr(cFilAnt,2,1)+StrZero(Day(dDatabase),2)+cMes+Substr(Strzero(year(dDatabase),4),4,1)	
	End Case
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona no Banco indicado                                  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	cBanco  := mv_par13
	cAgencia:= mv_par14
	cConta  := mv_par15
	cSubCta := mv_par16
	
	dbSelectArea("SA6")
	If !(dbSeek(xFilial("SA6")+cBanco+cAgencia+cConta))
	   Help(" ",1,"NAOSA6",,"Dados Bancários Incorretos"+chr(13)+"Informe dados validos!",2,1)
		Return .F.
	Endif
	
	dbSelectArea("SEE")
	SEE->( dbSeek(cFilial+cBanco+cAgencia+cConta+cSubCta) ) 
	
	//12/07/2018 - Semaforo de Usuários 
	If /*alltrim(SEE->EE_XUSER) <> alltrim(cUserName) .and.*/ alltrim(SEE->EE_XUSER) <> ''  //Adequado, pois usuário faturamento é utilizado por varios usuarios   
		If !xAuto
			Alert('O Usuário '+alltrim(SEE->EE_XUSER)+' está utilizando a Rotina, aguarde!' ) 
		Else
			Conout('BOLETO AUTOMATICO: O Usuário '+alltrim(SEE->EE_XUSER)+' está utilizando a Rotina, aguarde!' ) 
		Endif
		Return    
	Else 
		dbselectarea('SEE')
	    Reclock("SEE")
	  		Replace EE_XUSER With alltrim(cUserName)+'('+alltrim(ComputerName())+')'
	   	SEE->(MsUnlock())    
	Endif 
	
	
	If !SEE->( found() )
		Help(" ",1,"PAR150")
		dbselectarea('SEE')
	    Reclock("SEE")
	  		Replace EE_XUSER With ''
	   	SEE->(MsUnlock()) 
		Return .F.
	Else
		If Val(EE_FAXFIM)-Val(EE_FAXATU) < 100
			Help(" ",1,"FAIXA150")
		Endif
	Endif  
	
	//Valida se tá posicionado no Parâmetro Bancario correto
	IF ! (alltrim(SEE->EE_CONTA) ==  alltrim(cConta) .and. alltrim(SEE->EE_AGENCIA) == alltrim(cAgencia))
		Alert('Parâmetros bancários incorretos!')    
		Conout('AGR095 - Parâmetros bancários incorretos!') 
		dbselectarea('SEE')
	    Reclock("SEE")
	  		Replace EE_XUSER With ''
	   	SEE->(MsUnlock()) 
		Return
	Endif 
	                      
	//Bloqueio de cadastro bancario com menos de 7 digitos do banco do brasil
	/*if alltrim(MV_PAR13) == '001' .and. len(alltrim(SEE->EE_CODEMP)) < 7  
		Alert('Contas antigas do Banco do Brasil devem ser geradas pela rotina Antiga(AGR094)! ')  
		dbselectarea('SEE')
	    Reclock("SEE")
	  		Replace EE_XUSER With ''
	   	SEE->(MsUnlock()) 
		Return .F.
	Endif*/
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Posiciona no Bordero Informado pelo usuario                  ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nTotCnab2 := 0
	nSeq := 0
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//?Inicia a leitura do arquivo de Titulos                       ?
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("TRB")
	dbGotop()
	ProcRegua(TRB->(RecCount()))
	While TRB->(!Eof())
	
		IncProc() 
		
		//Variável que determina se foi gerado automáticamente 
		If !xAuto
			If !IsMark( "OK", cMarca )
				dbSelectArea("TRB")
				dbSkip()
				Loop
			Endif
		Endif
	    
	    aRecnoE1 := {}
		nQtdBol  := 0 
	    lMarcou    := .T.   
	    
	    dbSelectArea("SF2")
		SF2->( dbSetOrder(2) )
		SF2->( dbSeek(ALLTRIM(cFilAnt)+TRB->CLIENTE+TRB->LOJA+TRB->DOC+TRB->SERIE) )
	 	
		IF SF2->(FieldPos("F2_XPROJ")) > 0     
		 	cF2_XPROJ := SF2->F2_XPROJ
	    Endif
	    
		dbSelectArea("SE1")
		SE1->( dbSetOrder(2) )
		SE1->( dbSeek(xFilial("SE1")+TRB->CLIENTE+TRB->LOJA+ALLTRIM(cFilAnt)+Substr(ALLTRIM(TRB->SERIE),1,1)+TRB->DOC,.T.)) 
		
		While SE1->( !Eof()) .AND. SE1->E1_FILIAL+SE1->E1_CLIENTE+SE1->E1_LOJA+SE1->E1_PREFIXO+SE1->E1_NUM == xFilial("SE1")+TRB->CLIENTE+TRB->LOJA+ALLTRIM(cFilAnt)+Substr(ALLTRIM(TRB->SERIE),1,1)+TRB->DOC
	                     
	    	//Quando usuário utilizar data retroativa, permite apenas impressão de boletos já gerados ou seja reimpressões                                                 
		    If ( (ddatabase <> date()) .and. alltrim(SE1->E1_NUMBCO) == '' )
				 Aviso("AVISO","O Boleto "+AllTrim(SE1->E1_NUM)+" não será GERADO, com database retroativa é permitido apenas a sua REIMPRESSÃO !",{/*"Ok"*/},;
		  		,"Atenção:",,,.T.,5000)
		  		SE1->( dbSkip() )
				Loop  
	        Endif
	
	
			If !Empty(SE1->E1_NUMBOR) .AND. SE1->E1_NUMBOR <> cNumBorAnt .AND. !xAuto
				_cnumbor := SE1->E1_NUMBOR
			  	SE1->( dbSkip() )
				Loop
			EndIf
	
			IF Alltrim(SE1->E1_TIPO) == "NCC" .Or.;
			   Alltrim(SE1->E1_TIPO) == "NP"  .Or.;
			   Alltrim(SE1->E1_TIPO) == "CH" 		
			   SE1->( dbSkip() )
		       Loop
			Endif
	
			IF Alltrim(SE1->E1_TIPO) <> "NF" 
			   SE1->( dbSkip() )
		       Loop
			Endif
	
			IF SE1->E1_EMISSAO <> TRB->EMISSAO
			   SE1->( dbSkip() )
		      Loop
			Endif
	            
			//Spiller - 02.08.2017
			If nQtdBol == 0 
				cFile := 'NF_'+dtos(ddatabase)+SUBSTR(TIME(),1,2)+SUBSTR(TIME(),4,2)+SUBSTR(TIME(),7,2)+'_'+AlltoChar(Alltrim(xFilial("SE1")+SE1->E1_PREFIXO+alltrim(SE1->E1_NUM)+alltrim(SE1->E1_PARCELA)))
				oPrn  := FWMSPrinter():New(cFile,6,.T.,'\IMPBOLETO\'/*AQUI*/,.T., , , ,.T. )
				         
				//Caso não consiga criar o Arquivo temporário na função FWMSPrinter, chama a função novamente.
				If alltrim(oPrn:OFILEWRITER:OERROLOG:MESSAGE) <> ""   
        			nCountErro := 0 
					While alltrim(oPrn:OFILEWRITER:OERROLOG:MESSAGE) <> ""  .AND. nCountErro < 5 
						CONOUT('*AGR095* '+cFile+' - '+alltrim(str(nCountErro))+oPrn:OFILEWRITER:OERROLOG:MESSAGE)
						cFile := cFile+'_'+alltrim(str(nCountErro))
						oPrn  := FWMSPrinter():New(cFile,6,.T.,'\IMPBOLETO\'/*AQUI*/,.T., , , ,.T. )
						nCountErro++     
					Enddo
		  		Endif          
						 
	        Endif 
	        
	        nQtdBol++                
	                                                        	
	        //Spiller - 02D.08.2017    
		    // Variável nao estava sendo iniciada 
			lAchouBord := .F.  
	
			DbSelectarea('SEE')
		  	Dbsetorder(1)
		  	SEE->( dbSeek(xFilial("SEE")+cBanco+cAgencia+cConta+cSubCta) )
			
			//Valida se tá posicionado no Parâmetro Bancario correto
			IF  alltrim(SEE->EE_CONTA) <>   alltrim(cConta) .or. alltrim(SEE->EE_AGENCIA) <> alltrim(cAgencia) 
				Alert('Parâmetros bancários Incorretos! Entre em contato com a TI!') 
				Conout('AGR095 - Parâmetros bancários incorretos!')
				Return
			Endif 
			
			
			//12.09.2017 - Spiller - Tratamento para erro de nosso numero sem portador
			If Empty(SE1->E1_NUMBCO) .or.  ( Empty(SE1->E1_PORTADO) .AND.  Empty(SE1->E1_NUMBOR)) 
				//Spiller - Provavel causa de NN duplicado no banco
			    nNossoNum   := if(Empty(SE1->E1_NUMBCO), Val(NossoNum())+1,alltrim(SE1->E1_NUMBCO)) 		   
			   //	nNossoNum   := Val(NossoNum())+1
				If alltrim(cbanco) == '237'.or. ( alltrim(cbanco) == '001' .and. len(alltrim(SEE->EE_CODEMP)) < 7 )
			   		nNossoNumE1 := StrZero(nNossoNum,11)+U_AGR095DV(cbanco,MV_PAR17)
			   		nNossoNuEE := StrZero(nNossoNum,12)
				Elseif alltrim(cbanco) == '422' 
					nNossoNumE1 := StrZero(nNossoNum,9)
					nNossoNuEE  := nNossoNumE1
			 	Else
					nNossoNumE1 := StrZero(nNossoNum,10)
					nNossoNuEE := StrZero(nNossoNum,10)
				Endif	
			Else
				lAchouBord := .T.
				nNossoNumE1 := AllTrim(SE1->E1_NUMBCO)
			EndIf 
			
			//BB - conta com menos de 7 Digitos já contem o CodEmp no NN
			If alltrim(cbanco) == '001' .and. len(alltrim(SEE->EE_CODEMP)) < 7
		        nNossoNum := nNossoNumE1  
		 	ElseIf alltrim(cbanco) == '422'
	       		nNossoNum := nNossoNumE1
	       	Else
	       	    nNossoNum := Alltrim(SEE->EE_CODEMP) + nNossoNumE1
	       	Endif 
	            
			If !lAchouBord 
			  	SELE SE1
		  		RecLock('SE1',.f.)
		  		SE1->E1_PORTADO := cBanco
		  		SE1->E1_AGEDEP  := cAgencia
		  		SE1->E1_CONTA   := cConta
		  		SE1->E1_VENCREA := DATAVALIDA(SE1->E1_VENCREA+SA6->A6_RETENCA,.T.)
		  		se1->e1_numbor  := cNumBorAnt
		  		se1->e1_databor := dDataBase
		  		SE1->E1_NUMBCO  := nNossoNumE1
		  		se1->e1_situaca := '1'
		  		SE1->E1_ZNBANCO := nNossoNum  
		  		SE1->E1_HIST    := 'A095Env '+alltrim(SE1->E1_HIST)
		  		SE1->(msunlock())//'SE1')
	
		  		SELE SEA
		  		reclock('SEA',.t.)
		  		sea->ea_filial  := xfilial('SEA')
		  		sea->ea_prefixo := se1->e1_prefixo
		  		sea->ea_num     := se1->e1_num
		  		sea->ea_parcela := se1->e1_parcela
		  		sea->ea_portado := cBanco
		  		sea->ea_agedep  := cAgencia
		  		sea->ea_numcon  := cConta
		  		sea->ea_numbor  := cNumBorAnt
		  		sea->ea_databor := dDataBase
		  		sea->ea_tipo    := se1->e1_tipo
		  		sea->ea_cart    := 'R'
		  		SEA->(msunlock())//'SEA')
	
				//SELE SEE
		  		//SEE->( dbSeek(xFilial("SEE")+cBanco+cAgencia+cConta+cSubCta) )  
		  		
		  		//Valida se tá posicionado no Parâmetro Bancario correto
				IF  alltrim(SEE->EE_CONTA) <>  alltrim(cConta) .or. alltrim(SEE->EE_AGENCIA) <> alltrim(cAgencia)
					Alert('Entre em contato com a TI - Erro Parâmetros bancários incorretos!')   
					Conout('AGR095 - Parâmetros bancários incorretos!')
					Return
				Endif 			
		  		
				//Valida Prefixo do NN 
	       		ValidaPref(cBanco,cAgencia,cConta,nNossoNumE1)
				
				//Valida Nosso Numero
		  		If !(U_AGR095NN(nNossoNum,SE1->E1_NUM,cBanco,cAgencia,cConta,SE1->E1_EMISSAO))
		  		   Return
		  		Endif  
		  					
				RecLock("SEE",.F.) 
					//Só grava nosso numero se ele for maior que o atual
					If nNossoNuEE >= SEE->EE_FAXATU 
						Replace SEE->EE_FAXATU with nNossoNuEE//nNossoNumE1
					Else
						Alert('NOSSO NUMERO menor que faixa atual! Entre em contato com a TI e não envie para o cliente! ')
						EnvNN(nNossoNuEE,' menor que faixa atual') 
						Return
					Endif
				SEE->(MsUnLock())
			Endif
	
	
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	   		//?Posiciona no cliente                                         ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SA1")
			dbsetorder(1)
			dbSeek(xFilial('SA1')+SE1->E1_CLIENTE+SE1->E1_LOJA)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		   //?Posiciona no Contrato bancario                               ?
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SE9")
			dbSetOrder(1)
			dbSeek(xFilial("SE9")+SE1->(E1_CONTRAT+E1_PORTADO+E1_AGEDEP))
	 
			dbSelectArea("SE1")
			u_WM095B(MV_PAR13,MV_PAR14,MV_PAR15,MV_PAR16,SE1->E1_PREFIXO,SE1->E1_NUM,cNumBorAnt,MV_PAR10,MV_PAR11,xAuto)
	             
	        cCliente := SE1->E1_CLIENTE
	        cLoja 	 := SE1->E1_LOJA 
	        AADD(aRecnoE1,SE1->(RECNO()))
	         
			dbSelectArea("SE1")
			SE1->( dbSkip())
		Enddo 
		
		//Spiller 02.08.2017
		//Alterado para imprimir parcelas agrupadas
		If nQtdBol > 0 
			//cPath := "C:\BOLETO\" 
			cPath :="\IMPBOLETO\"
			MakeDir(Trim(Upper(cPath)))
	
			oPrn:SetPortrait()
			oPrn:SetPaperSize(9)
			oPrn:lServer  := .F.
			oPrn:cPathPDF := cPath   
			oPrn:SetViewPDF(.F.)	
			oPrn:Preview()
			SetPgEject(.F.)
			MS_Flush() 
		Else 
			If !xAuto
				If !lMarcou
					Msgbox('Marque ao menos um título!  ')
				Else
					Msgbox('Boleto já possui Bordero: '+_cnumbor+', Você deverá entrar com a mesma Database da Geração do Bordero: '+SUBSTR(_cnumbor,3,2)+'/'+NumMes( substr(_cnumbor,5,1) ) )
				Endif
			Else
			 	conout('Boleto já possui Bordero: '+_cnumbor+', Você deverá entrar com a mesma Database da Geração do Bordero: '+SUBSTR(_cnumbor,3,2)+'/'+NumMes( substr(_cnumbor,5,1) ) )
			Endif
		Endif
		
		DBSelectArea("SA1")
		dbSetOrder(1)
		If (dbSeek(xFilial("SA1")+cCliente+cLoja) .OR. alltrim(cF2_XPROJ) == '2' ).and. nQtdBol > 0 
	
		   	If !Empty(SA1->A1_EMAIL) .or. !Empty(SA1->A1_EMAIL2) .or. xAuto .OR. alltrim(cF2_XPROJ) == '2'//.or. !Empty(xMail)
				//Start do WorkFlow
				//CpyT2S( cpath+cFile+".pdf", "\impboleto" )
			
				_cEmpresa := FWEmpName(cEmpant) 	
				Do Case
					Case alltrim(cBanco) == '001'
			          cNomeBanco := 'Banco do Brasil'             
					Case alltrim(cBanco) == '756'
			          cNomeBanco := 'Sicoob'         
					Case alltrim(cBanco) == '237'
			          cNomeBanco := 'Bradesco'         
					Case alltrim(cBanco) == '422'
			         cNomeBanco := 'Safra'       
					Case alltrim(cBanco) == '033'
			          cNomeBanco := 'Santander'          
					Case alltrim(cBanco) == '104'
			          cNomeBanco := 'Caixa' 
			    Otherwise
			    	  cNomeBanco := ''      
			    EndCase   
			     
			    cMsgErro  := "" 
			    _cCC      := "" 
			    cMailNyke := ""            
	                 
	            //Se for do Projeto Nyke grava e-mail Nyke
	            If cF2_XPROJ == '2'
	            	xFrom  := 'frete.nyke@agricopel.com.br' 
	            Else
	            	xFrom := BuscaMail()
	           	 	/*If cFilant == '03' .and. cEmpant ==  '01' 
	               		xFrom  := 'boleto.trr@agricopel.com.br' 
	            	Elseif cEmpant == '11' 
	               		xFrom  := 'boleto.filial11@agricopel.com.br'
	            	Elseif cEmpant == '15' 
	               		xFrom  := 'boleto.filial15@agricopel.com.br'  
	            	Elseif cEmpant == '16' 
	              	 	xFrom  := 'boleto.filial16@agricopel.com.br' 
	            	Endif*/
	            Endif
				
				nEmpDe := 1
			    
			    //Se For um Boleto Nyke valida E-mail e caso esteja Vazio envia 
			    //e-mail de aviso
			    If  'NYKE' $ UPPER(xFrom)  
			         
			    	/*nEmpDe = é a Empresa DBGint, Variavel criada em XAG0031*/
			    	cMailNyke := EMailNyke(nEmpDe,SA1->A1_CGC)
			     	_cCC      := "spiller@agricopel.com.br"
			        If alltrim(cMailNyke) == ''
			    		cMailNyke 	:= "frete.nyke@agricopel.com.br"
			        	cMsgErro 	:= "ERRO - Cliente sem Email"
			        Endif
			    Else
			    	If alltrim(GETNEWPAR('MV_XMAILBO', "")) <> "" 
					  	_cCC := alltrim(GETMV('MV_XMAILBO'))
					Endif 
			    Endif
	 
				_cAttach := "\impboleto\"+cFile+".pdf" 
				_cFrom   := If( Empty(xFrom),"protheus@agricopel.com.br",xFrom)
				_cto     := alltrim(iif(alltrim(cMailNyke) == '', IIF(alltrim(SA1->A1_EMAIL2) <> '',SA1->A1_EMAIL2, SA1->A1_EMAIL),cMailNyke))  
				_cSubject:= cMsgErro+" Envio de boleto "+cNomeBanco+" - Empresa "+_cEmpresa+"("+cFile+")" 
				_cMsg    := /*AQUI remover XMAILcMailNyke+*/" Prezado, segue em anexo o boleto referente a nota emitida pela Empresa "+_cEmpresa+"."//+_cto  
				
				//Retira , e ' 
				_cto := STRTRAN(_cto, "'", "")
				_cto := alltrim( STRTRAN(_cto, ",", ";") )

				//Dá 1 segundos para dar tempo da aplicação terminar o salvamento em PDF
				SLEEP(1000)            
	
	            //*****************  
	            //***************** 
	            //**** ATENÇÃO ****
	            //***************** 
	            //*****************   
				//teste retirar 
			    //_cTo := 'leandrohey@gmail.com'
   				//_cCC:= 'spiller@agricopel.com.br'
			   	//Nova Função de Envio
				lEnvioMail := SendMail(_cFrom, _cTo, _cCC, _cSubject, _cMsg, _cAttach)
				  
				//Se deu Algum erro no envio gravou  
				If !lEnvioMail
					_cTo  := 'ERRO - '+alltrim(_cTo) 
				Endif 
	                            
	   		    //Grava Email na tabela SE1   
	   			GravaMailE1(aRecnoE1,_cTo)   
				
		   Else 
				 Aviso("Sem E-mail","Cliente "+AllTrim(SA1->A1_NOME)+" não possui e-mail cadastrado para envio de boleto.",{/*"Ok"*/},;
		  ,"Atenção:",,,.T.,5000)  
	  
		   Endif
			
		Endif
		
		dbSelectArea("TRB")
		TRB->(dbSkip())
	EndDo
	
	If nQtdBol == 0 .and. !xAuto
		If !lMarcou
			Msgbox('Marque ao menos um título!  ')
		Else
			Msgbox('Boleto já possui Bordero: '+_cnumbor+', Você deverá entrar com a mesma Database da Geração do Bordero: '+SUBSTR(_cnumbor,3,2)+'/'+NumMes( substr(_cnumbor,5,1) ) ) 
			//Msgbox('Bordero gerado: '+cNumBorAnt)
		Endif
	Endif 
	
	//12/07/2018 - Semaforo de Usuários
	FreeUsedCode()//Libera os Registro da SEE 		  
	dbselectarea('SEE')
	Reclock("SEE")
	  Replace EE_XUSER With ''
	SEE->(MsUnlock()) 
	             
	dbselectarea('SEE') 
	MsUnlockAll()

Return(.T.)



***********************************************************************************************************************
User Function WM095B(sPAR01  ,sPAR02  ,sPAR03  ,sPAR04  ,sPAR05         ,sPAR06     ,sPAR07   ,sPAR10   ,sPAR11,xAuto )  
		    //WM095B(MV_PAR13,MV_PAR14,MV_PAR15,MV_PAR16,SE1->E1_PREFIXO,SE1->E1_NUM,cNumBorAnt,MV_PAR10,MV_PAR11)
*********************************************************************************************************************** 
	Local sNotFat	:= ""
	Local oProcess := NIL
	
	Private sPAR01,sPAR02,sPAR03,sPAR04,sPAR05,sPAR06,sPAR07,sPar10,sPAR11
	Private cBanco    := ""
	Private cAgencia  := ""
	Private cConta    := ""
	Private cSubConta := ""
	Private cDigitao  := ""
	Private nLastKey  := 0
	Private cPerguntas:= .T.
	Private aBancos   := {}
	Private nPOS	    := 0
	Private cAmbiente := GetEnvServer() 
	Private lProtesto := .T. 
	
	Private nPAR10 := sPAR10
	Private nPAR11 := sPAR11
	
	Private oFont, cCode
	Private cBarraFim
	Private lTitAnt, dNewVen, nVlrCob  
	
	Default xAuto := .F.
	
	cBarraImp  := Space(50)
	nHeight    := 15
	lBold      := .F.
	lPixel     := .T.
	lPrint     := .F.
	nSedex     := 1
	MsgInstr01 := " "
	MsgInstr02 := " "
	MsgInstr03 := " "  
	
	//Exclusivo Banco
	if sPAR01 == '756'
		AADD(aBancos, {sPAR01,"BANCOOBCED"	,"SICOOB.BMP"	,sPAR01,sPAR01,SEE->EE_CODEMP ,"" ,"" ,"" ,5,""  })
	Elseif sPAR01 == '237'
		AADD(aBancos, {sPAR01,"BRADESCO"	,"BRADESCO.BMP"	,sPAR01+"-2",sPAR01,SEE->EE_CODEMP ,"" ,"" ,"" ,5,""  }) 
	Elseif sPAR01 == '001' 
		AADD(aBancos, {"001","BANCO DO BRASIL"	,"BBRASIL.BMP"	,"001-9","001",alltrim(SEE->EE_CODEMP)/*"2988362"*/ ,"" ,"" ,"" ,5,"" }) 
	Elseif sPAR01 == '422' 
		AADD(aBancos, {sPAR01,"BANCO SAFRA S.A"   	,""/*"logo_safra.bmp"*/,sPAR01+"-7","001",alltrim(SEE->EE_CODEMP)/*"2988362"*/ ,"" ,"" ,"" ,5,"" })
	Endif
	
	oFont1 := TFont():New( "Times New Roman",,08,,.t.,,,,,.f. )
	oFont2 := TFont():New( "Times New Roman",,10,,.t.,,,,,.f. )
	oFont3 := TFont():New( "Times New Roman",,12,,.t.,,,,,.f. )
	oFont4 := TFont():New( "Times New Roman",,14,,.t.,,,,,.f. )
	oFont5 := TFont():New( "Times New Roman",,16,,.t.,,,,,.f. )
	
	oFont6 := TFont():New( "HAETTENSCHWEILLER",,10,,.t.,,,,,.f. )
	
	oFont8 := TFont():New( "Free 3 of 9" ,,44,,.t.,,,,,.f. )
	oFont10:= TFont():New( "Free 3 of 9" ,,38,,.t.,,,,,.f. )
	
	oFont11:= TFont():New( "Courier New"   ,,10,,.t.,,,,,.f. )
	oFont12:= TFont():New( "Courier New"   ,,12,,.t.,,,,,.f. )
	oFont13:= TFont():New( "Arial"         ,,09,,.f.,,,,,.f. )
	oFont14:= TFont():New( "Courier New"   ,,09,,.T.,,,,,.f. )
	oFont14N := TFont():New( "Courier New"  ,,10,,.T.,,,,,.F. )
	oFont15:= TFont():New( "Arial"         ,,10,,.t.,,,,,.f. )
	oFont16:= TFont():New( "Arial"         ,,10,,.f.,,,,,.f. )
	oFont17:= TFont():New( "Arial"         ,,07,,.T.,,,,,.f. )
	oFont18:= TFont():New( "Arial"         ,,09,,.T.,,,,,.f. )
	oFont19:= TFont():New( "Arial"         ,,22,,.t.,,,,,.f. )
	oFont20:= TFont():New( "Arial Black"   ,,15,,.f.,,,,,.f. )
	oFont21:= TFont():New( "Arial"         ,,14,,.f.,,,,,.f. )
	oFont22:= TFont():New( "Arial"         ,,11,,.t.,,,,,.f. )
	oFont23:= TFont():New( "Arial Black"   ,,15.7,,.t.,,,,,.f. )
	oFont24:= TFont():New( "Times New Roman",,18,,.t.,,,,,.f. )
	
	//oPrn  := FWMSPrinter():New(cFile,6,.T.,,.T.)
	
	
	IF sPAR01=="001" .AND. ALLTRIM(sPAR04)<>"001"
		APMSGALERT("Para o banco Banco do Brasil (001) obrigatoriamente a subconta deve ser 001.")
		Return()
	ENDIF 
	
	cAgeImp:=sPAR02
	
	// PESQUISA POR NÚMERO DE TITULO
	cCondicao := "SE1->E1_FILIAL=='"+xFilial("SE1")+"' .AND. SE1->E1_PREFIXO=='"+sPAR05+"' .AND. SE1->E1_NUM=='"+sPAR06+"' "  
	cAbatimento := MVABATIM +"|"+MVFUABT+"|"+MV_CRNEG+"|"+MVRECANT
	cAbatimento := strtran(cAbatimento,"|","','")
	
	
	IF SE1->E1_PORTADO == sPAR01
		cBanco    := SE1->E1_PORTADO
		cAgencia  := SE1->E1_AGEDEP
		cConta	   := SE1->E1_CONTA
		cSubConta := "001" //Posicione("SA6",1,xFilial("SA6")+cBanco+cAgencia+cConta,"A6_SUBCONT")
		
		dbSelectArea("SEE")
		dbSetOrder(1)
		dbSeek(XFILIAL("SEE")+SE1->E1_PORTADO+SE1->E1_AGEDEP+SE1->E1_CONTA+cSubConta)
	ELSE
		APMSGALERT("O boleto para o titulo "+SE1->E1_PREFIXO+"/"+SE1->E1_NUM+"-"+SE1->E1_PARCELA+" não ser?impresso pois o portador gravado nele ("+SE1->E1_PORTADO+") ?diferente do informado ("+sPAR01+")")
		Return
	ENDIF  
		
	
	// IDENTIFICA O BANCO PARA OBTENÇÃO DOS PARÂMETROS
	// - se não for nenhum dos bancos pr?determinados não imprime o boleto  
	nPOS := ASCAN(aBancos,{|x| x[1]==cBanco})
	
		   
	// OBTÉM CÓDIGO DE CEDENTE DO PARÂMETRO DE BANCO J?POSICIONADO 
	//Exclusivo Banco 
	//if sPAR01 == '756'
	cCodced			:= alltrim(SEE->EE_AGENCIA)//"31259"
	cContaSEE		:= alltrim(SEE->EE_CONTA)//"04908201"
	cConvenio		:= alltrim(SEE->EE_CODEMP)
	//Else
	//	cCodced	   		:= "31259"
	//	cContaSEE		:= "04908201"
	//	cConvenio		:= alltrim(SEE->EE_CODEMP)
	//Endif
	
	aBancos[nPOS,5] := ALLTRIM(SEE->EE_SUBCTA)    
	aBancos[nPOS,6] := cCodCed
	cNumBor         := SE1->E1_NUMBOR
		
		
	// atualiza campos nas faturas
	xRECNO    := SE1->(RECNO())
	PREFANT   := SE1->E1_PREFIXO
	NUMANT    := SE1->E1_NUM
	TIPOANT   := SE1->E1_TIPO
	CLIANT    := SE1->E1_CLIENTE
	LOJANT    := SE1->E1_LOJA
	
	MsgInstr01	:= SE1->E1_INSTR1
	MsgInstr02	:= SE1->E1_INSTR2
	
	
	SA1->(dbSeek(xFilial("SA1")+SE1->E1_CLIENTE+SE1->E1_LOJA,.f.))
	cNome := SA1->A1_NOME
	cCGC  := If(SA1->A1_PESSOA=="F",TRansform(SA1->A1_CGC, "@R 999.999.999-99"),TRansform(SA1->A1_CGC, "@R 99.999.999/9999-99"))
	
	nAbatim	:= SomaAbat(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,"R",SE1->E1_MOEDA,dDataBase,SE1->E1_CLIENTE,SE1->E1_LOJA)
	IF SE1->E1_VALJUR == 0.0 .AND. nPAR11 > 0.0 .AND. SE1->E1_SALDO > 0
		RecLock("SE1",.F.)
		Replace SE1->E1_VALJUR 	with Round(SE1->E1_VALOR * (nPAR11/30/100),2)
		Replace SE1->E1_PORCJUR 	with ROUND(nPAR11/30,2)
		SE1->(MsUnlock())
	ENDIF
	
	nJUROS := 0
	IF SE1->E1_VALJUR == 0.0 .AND. SE1->E1_PORCJUR == 0
		nJUROS := (nPAR11/30)/100
		nJUROS := Round(SE1->E1_SALDO * nJUROS,2)
	ELSEIF SE1->E1_VALJUR > 0
		nJUROS	:= SE1->E1_VALJUR
	ELSE 
	    nJUROS	:= Round(SE1->E1_VALOR * (SE1->E1_PORCJUR/100),2)
	ENDIF
	njrs01 := nJUROS
	nJUROS := ALLTRIM(transf(nJUROS,"@E 999,999.99"))
	
	nmulta	:= 0
	IF nPAR11 > 0
		nmulta	:= (nPAR11/100) 
		nmulta	:= Round(SE1->E1_VALOR * nmulta,2)
	ENDIF
	nmul01 := nmulta
	nmulta := ALLTRIM(transf(nmulta,"@E 999,999.99"))
	
	lTitAnt := .F.
	
		     
	// se titulo j?est?vencido
	If SE1->E1_VENCREA < Date() .AND. SE1->E1_SALDO > 0 .AND. !xAuto //Não Mostra mensagem se for gerado de Forma automática
		 Aviso("Título Vencido","O título: "+SE1->E1_NUM+" está vencido! Verifique antes de enviar para o cliente!   ",{/*"Ok"*/},;
   		  ,"Atenção:",,,.F.,5000)  		  
	Elseif SE1->E1_SALDO == 0 .AND. !xAuto
		 Aviso("Título já BAIXADO ","O título: "+SE1->E1_NUM+" já ESTÁ BAIXADO ou possuí parcelas já baixadas. Verifique!   ",{/*"Ok"*/},;
		  ,"Atenção:",,,.T.,5000)  
	Endif  
		                          
		/*dDatEmi := SE1->E1_EMISSAO
		dDatVen := SE1->E1_VENCREA //SE1->E1_VENCTO  //SPILLER 14.09.2017 - Mudar para Vencto Real, conversado com Josi 
		nVlrSdo := SE1->E1_SALDO
		nTaxJur := mv_par10
		nTaxMul := mv_par11		
		dNewVen := Date()+7 
		cAtuVlr := "N"           
		cDadTit := SE1->E1_PREFIXO + "  " + SE1->E1_NUM + "  " + SE1->E1_PARCELA + "  " + SE1->E1_TIPO
		cDadCli := SE1->E1_CLIENTE + "  " + SE1->E1_LOJA + "  " + SE1->E1_NOMCLI
		If SE1->E1_SITUACA == "0"
		   cSitTit := "0  CARTEIRA"
		Elseif SE1->E1_SITUACA == "1"
		   cSitTit := "1  COBR. SIMPLES"
		Elseif SE1->E1_SITUACA == "2"
		   cSitTit := "2  COBR. DESCONT."
		Elseif SE1->E1_SITUACA == "4"
		   cSitTit := "4  COBR. VINCULAD"
		Else
		   cSitTit := Left(SE1->E1_SITUACA,1,1)
		Endif
	
		@ 150,1 TO 430,490 DIALOG oDlg1 TITLE "ATENÇÃO!!! TÍTULO VENCIDO."
		@ 006,005  To 115,240 Title ""
	
		@ 013,013 Say "Reemissão de boleto com dados atualizados (DT VENCTO E VALOR)." 
		@ 028,013 Say "Titulo: "
		@ 042,013 Say "Cliente: "		
		@ 056,013 Say "Dt. Emissão: "
		@ 056,123 Say "Dt. Vencto Orig: "
	
		@ 070,013 Say "Vlr Título:"
		@ 070,123 Say "Situação:"
		@ 084,013 Say "%Taxa Juros:"
		@ 084,123 Say "%Taxa Multa:"
	
		@ 098,013 Say "Atualiza Valor? "
		@ 098,123 Say "Nova Dt. Vencto: "
		
		@ 027,055 Get cDadTit Size 080,060 When .F.
		@ 041,055 Get cDadCli Size 120,060 When .F.
		@ 055,055 Get dDatEmi Size 045,060 When .F.
		@ 055,170 Get dDatVen Size 045,060 When .F.
		
		@ 069,055 Get nVlrSdo Size 055,060 When .F. Picture "@E 9,999,999.99"
		@ 069,170 Get cSitTit Size 060,060 When .F. 
		@ 083,055 Get nTaxJur Size 030,060 When .F. Picture "@E 99.99"
		@ 083,170 Get nTaxMul Size 030,060 Picture "@E 99.99"		
		
		@ 097,055 Get cAtuVlr Size 020,060 Picture "@!" Valid cAtuVlr $ "SN"
		@ 097,170 Get dNewVen Size 045,060 Valid dNewVen >= dDatVen
		
		@ 121,105 BUTTON "_OK"          SIZE 035,015  ACTION Close(oDlg1)
	
		ACTIVATE DIALOG oDlg1 CENTERED     
	         
		If cAtuVlr == "S"
		   lTitAnt := .T.   
		   nValorMulta := (SE1->E1_SALDO*nTaxJur/100) 
		   nValorMulta := (nValorMulta/30)*(dNewVen-dDatVen)
		   nVlrCob := SE1->E1_SALDO + nmul01 + nValorMulta
		Endif   
		*/
	//Endif
		
		
		
	// CALCULA PARÂMETROS PARA CADA BANCO (Linha Digitável, Código de Barras, Nosso Número)
	// - RHO - 03/11/05 - mudança na rotina para considerar Decréscimo e Abatimentos
	CALCVALBOL(cBanco,aBancos,sPar01,sPar02,sPar03)
	dbSelectArea("SEE")
	dbSetOrder(1)
	dbSeek(XFILIAL("SEE") + cBanco + cAgencia + cConta + cSubConta)
	                    
	If lTitAnt
	   cData := DTOC(dNewVen)
	Else   
	   cData := DTOC(SE1->E1_VENCREA)//DTOC(SE1->E1_VENCTO)  //SPILLER 14.09.2017 - Mudar para Vencto Real, conversado com Josi 
	Endif   
	cData := IIF(LEN(cData) == 8,SUBS(cData,1,6)+"20"+SUBS(cData,7,2),cData)
	cData2 := DTOC(SE1->E1_EMISSAO)
	cData2 := IIF(LEN(cData2) == 8,SUBS(cData2,1,6)+"20"+SUBS(cData2,7,2),cData2)
	cData3 := DTOC(DDATABASE)
	cData3 := IIF(LEN(cData3) == 8,SUBS(cData3,1,6)+"20"+SUBS(cData3,7,2),cData3)
	
	cEndBeneficiario := alltrim(SM0->M0_ENDCOB) + ", " + alltrim(SM0->M0_BAIRCOB) + ", " + alltrim(SM0->M0_CIDCOB)+ ", " +;
	alltrim(SM0->M0_ESTCOB) + " - CEP: " + alltrim(SM0->M0_CEPCOB)



	//******************************************
	//  INICIALIZA IMPRESSAO DO BOLETO   
	//******************************************
	oPrn:StartPage()
	nAjust1 := -2100	// Recibo Entrega
	nAjust2 := -1595+70	// Recibo Sacado
	nAjust3 := -600+70		// Ficha de Compensacao
	
	//******************************************
	//  MONTA RECIBO DE ENTREGA    -2110
	//******************************************
	
	// Monta linhas horizontais
	oPrn:Line(2220+nAjust1, 0050, 2220+nAjust1, 2380)
	oPrn:Line(2290+nAjust1, 0050, 2290+nAjust1, 2380)
	oPrn:Line(2360+nAjust1, 0050, 2360+nAjust1, 2380)
	oPrn:Line(2430+nAjust1, 0050, 2430+nAjust1, 2380)
	oPrn:Line(2500+nAjust1, 0050, 2500+nAjust1, 2380)
	oPrn:Line(2570+nAjust1, 0050, 2570+nAjust1, 2380)
	oPrn:Line(2500+nAjust1+80+70, 0050, 2500+nAjust1+80+70, 2380) 
		
	// Monta linha verticais
	oPrn:Line(2135+nAjust1, 0620, 2215+nAjust1, 0620)
	oPrn:Line(2135+nAjust1, 0830, 2215+nAjust1, 0830)
	
	oPrn:Line(2150+nAjust1+70, 1720, 2500+nAjust1+70, 1720)
	oPrn:Line(2220+nAjust1+70, 1720, 2500+nAjust1+70, 1720)
	
	oPrn:Line(2360+nAjust1+70, 0500, 2500+nAjust1+70, 0500)
	oPrn:Line(2360+nAjust1+70, 0900, 2500+nAjust1+70, 0900)
	oPrn:Line(2360+nAjust1+70, 1100, 2430+nAjust1+70, 1100)
	oPrn:Line(2360+nAjust1+70, 1400, 2500+nAjust1+70, 1400)
	
	IF FILE(aBancos[nPOS,3])
		oPrn:SayBitmap( 2150+nAjust1-22, 0050,aBancos[nPOS,3],400,85 )
	ELSE
		oPrn:Say( 2200+nAjust1, 0050, aBancos[nPOS,2]		,oFont24,100)
	ENDIF
	
	oPrn:Say( 2200+nAjust1, 0640, aBancos[nPOS,4]		,oFont20,100)
	oPrn:Say( 2200+nAjust1, 0880, aBancos[nPOS,7]		,oFont5,100)
	oPrn:Say( 2155+nAjust1, 1950, "   Recibo de Entrega",oFont3,100  )
	
	oPrn:Say( 2240+nAjust1, 0070, "Beneficiário "    ,oFont13,100  )
	oPrn:Say( 2240+nAjust1, 1730, "Vencimento "      ,oFont13,100  )
	oPrn:Say( 2275+nAjust1, 1880, cData     			,oFont12,100  )
	

	oPrn:Say( 2275+nAjust1, 0090, ALLTRIM(SUBS(SM0->M0_NOMECOM,1,50))+" - CNPJ: "+ ALLTRIM(TRANSFORM(SM0->M0_CGC, "@R 99.999.999/9999-99"))			,oFont11,100  )
	oPrn:Say( 2315+nAjust1, 0070, "Endereço "     , oFont13,100  )
	oPrn:Say( 2345+nAjust1, 0090, cEndBeneficiario, oFont12,100  )   
	
	oPrn:Say( 2315+nAjust1, 1730, "Agência/Código Beneficiário"        ,oFont13,100  ) 
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2345+nAjust1, 1880, alltrim(cAgencia) +'-'+SEE->EE_DVAGE+ "/" +alltrim(SEE->EE_CODEMP),oFont12,100  )
		oPrn:Say( 2485+nAjust1, 1880, alltrim(str(val(aBancos[nPOS,11])))         	,oFont12,100)
	ElseIf alltrim(sPAR01) == '237' 
	    if alltrim(SEE->EE_DVAGE) <> ''
	      	cDigitAG := SEE->EE_DVAGE
	    Else
	    	cDigitAG := '0'
	    Endif
		if alltrim(SEE->EE_DVCTA) <> ''
			cDigitCC := SEE->EE_DVCTA
			cCCSemDV := alltrim(cContaSEE) 
		Else
	   		cDigitCC := SUBSTR(alltrim(cContaSEE),LEN(alltrim(cContaSEE)),1)
	   		cCCSemDV := substr(  alltrim(cContaSEE) , 1 , len(alltrim(cContaSEE))-1) 
		Endif
		oPrn:Say( 2345+nAjust1, 1880, alltrim(cAgencia) +'-'+cDigitAG+ "/" +alltrim(cCCSemDV)+'-'+cDigitCC,oFont12,100  ) 
		oPrn:Say( 2485+nAjust1, 1880, substr(nNossoNumE1,1,11)+'-'+substr(nNossoNumE1,12,1)        	,oFont12,100) 
	ElseIf alltrim(sPAR01) == '422' 
		oPrn:Say( 2345+nAjust1, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 99999") + "/" + transform(Substr(alltrim(cContaSEE),1,9),"@R 99999999-9"),oFont12,100  )
   		oPrn:Say( 2485+nAjust1, 1880, aBancos[nPOS,8]         	,oFont12,100)	
	Else
		oPrn:Say( 2345+nAjust1, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 9999-9") + "/" + transform(Substr(alltrim(cContaSEE),1,8),"@R 9999999-9"),oFont12,100  )
   		oPrn:Say( 2485+nAjust1, 1880, aBancos[nPOS,8]         	,oFont12,100)
   	Endif
   	
   	oPrn:Say( 2410+nAjust1, 1880, ALLTRIM(SE1->E1_CLIENTE) ,oFont12,100  )
    
	oPrn:Say( 2385+nAjust1, 0070, "Pagador: "              ,oFont13,100  )  
	oPrn:Say( 2385+nAjust1, 1730, "Codigo Pagador "        ,oFont13,100  )
	oPrn:Say( 2410+nAjust1, 0090, ALLTRIM(cNome)           ,oFont12,100  )   
	oPrn:Say( 2455+nAjust1, 0070, "Data Documento"         ,oFont13,100  )
	oPrn:Say( 2455+nAjust1, 0510, "Nº Documento "         ,oFont13,100  )
	oPrn:Say( 2455+nAjust1, 0910, "Especie Doc. "          ,oFont13,100  )
	oPrn:Say( 2455+nAjust1, 1110, "Aceite "                ,oFont13,100  )
	oPrn:Say( 2455+nAjust1, 1410, "(=) Valor do Documento" ,oFont13,100  )
	oPrn:Say( 2455+nAjust1, 1730, "Nosso Numero "          ,oFont13,100  )
	   
	oPrn:Say( 2485+nAjust1, 0090, cData2     , oFont12,100  )
	oPrn:Say( 2485+nAjust1, 0520, U_AGX531() , oFont12,100  )
	oPrn:Say( 2485+nAjust1, 0970, "DM"       , oFont12,100  )
	oPrn:Say( 2485+nAjust1, 1230, "Não"      , oFont12,100  ) //ACEITE

    IF lTitAnt
		oPrn:Say( 2485+nAjust1, 1440, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
    ELSE
		oPrn:Say( 2485+nAjust1, 1440, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99"), oFont12,100  )
	ENDIF
	             

	oPrn:Say( 2525+nAjust1, 0070, "Recebi(emos) o Boleto"   ,oFont18,100)
	oPrn:Say( 2550+nAjust1, 0070, "de característica acima" ,oFont18,100)
	oPrn:Say( 2525+nAjust1, 0510, "Data "                   ,oFont13,100)
	oPrn:Say( 2525+nAjust1, 0910, "Assinatura "           	,oFont13,100)
	oPrn:Say( 2525+nAjust1, 1410, "Data "                 	,oFont13,100)
	oPrn:Say( 2525+nAjust1, 1730, "Entregador "    		   	,oFont13,100)


	
	//******************************************
	//  MONTA RECIBO DO SACADO +nAjust2
	//******************************************
	
	// Monta linhas horizontais
	oPrn:Line(2220+nAjust2, 0050, 2220+nAjust2, 2380)
	oPrn:Line(2290+nAjust2, 0050, 2290+nAjust2, 2380)
	oPrn:Line(2360+nAjust2, 0050, 2360+nAjust2, 2380)
	oPrn:Line(2430+nAjust2, 0050, 2430+nAjust2, 2380)
	oPrn:Line(2500+nAjust2, 0050, 2500+nAjust2, 2380)
	oPrn:Line(2570+nAjust2, 0050, 2570+nAjust2, 2380)
	
	oPrn:Line(2915+nAjust2, 0050, 2915+nAjust2, 2380)
	oPrn:Line(3120+nAjust2, 0050, 3120+nAjust2, 2380)
		
	oPrn:Line(2570+nAjust2, 1720, 2570+nAjust2, 2380)
	oPrn:Line(2640+nAjust2, 1720, 2640+nAjust2, 2380)
	oPrn:Line(2710+nAjust2, 1720, 2710+nAjust2, 2380)
	oPrn:Line(2780+nAjust2, 1720, 2780+nAjust2, 2380) 
	
	// Monta linha verticais
	oPrn:Line(2135+nAjust2, 0620, 2215+nAjust2, 0620)
	oPrn:Line(2135+nAjust2, 0830, 2215+nAjust2, 0830)
	
	oPrn:Line(2150+nAjust2+70, 1720, 2845+nAjust2+70, 1720)
	oPrn:Line(2360+nAjust2+70, 0500, 2500+nAjust2+70, 0500)
	oPrn:Line(2360+nAjust2+70, 0900, 2500+nAjust2+70, 0900)
	oPrn:Line(2360+nAjust2+70, 1100, 2430+nAjust2+70, 1100)
	oPrn:Line(2360+nAjust2+70, 1400, 2500+nAjust2+70, 1400)
	oPrn:Line(2430+nAjust2+70, 0700, 2500+nAjust2+70, 0700)
	
	IF FILE(aBancos[nPOS,3])
		oPrn:SayBitmap( 2150+nAjust2-30, 0050,aBancos[nPOS,3],400,90 )
	ELSE
		oPrn:Say( 2200+nAjust2, 0050, aBancos[nPOS,2]		,oFont24,100)
	ENDIF
	
	oPrn:Say( 2200+nAjust2, 0640, aBancos[nPOS,4] ,oFont20,100)
	oPrn:Say( 2200+nAjust2, 0880, aBancos[nPOS,7] ,oFont5 ,100)
	
	oPrn:Say( 2240+nAjust2, 0070, "Local de Pagamento "    						,oFont13,100)
	oPrn:Say( 2240+nAjust2, 1730, "Vencimento "            						,oFont13,100)
	oPrn:Say( 2275+nAjust2, 0090, iif(alltrim(sPAR01) == '422',"PAGÁVEL EM QUALQUER BANCO DO SISTEMA DE COMPENSAÇÃO","PAGÁVEL EM QUALQUER BANCO ATÉ O VENCIMENTO")	,oFont22,100)
	oPrn:Say( 2270+nAjust2, 1880, cData     									,oFont12,100)
	
	oPrn:Say( 2315+nAjust2, 0070, "Beneficiário  "               ,oFont13,100  )
	oPrn:Say( 2315+nAjust2, 1730, "Agência/Codigo Beneficiário " ,oFont13,100  )
	oPrn:Say( 2350+nAjust2, 0090, ALLTRIM(SUBS(SM0->M0_NOMECOM,1,50))+" - CNPJ: "+ ALLTRIM(TRANSFORM(SM0->M0_CGC, "@R 99.999.999/9999-99"))			,oFont11,100  )
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2350+nAjust2, 1880, alltrim(cAgencia) +'-'+SEE->EE_DVAGE+ "/" +alltrim(SEE->EE_CODEMP),oFont12,100  )
	ElseIf alltrim(sPAR01) == '237' 
	    if alltrim(SEE->EE_DVAGE) <> ''
	      	cDigitAG := SEE->EE_DVAGE
	    Else
	    	cDigitAG := '0'
	    Endif
		if alltrim(SEE->EE_DVCTA) <> ''
			cDigitCC := SEE->EE_DVCTA 
			cCCSemDV := alltrim(cContaSEE)
		Else
	   		cDigitCC := SUBSTR(alltrim(cContaSEE),LEN(alltrim(cContaSEE)),1) 
	   		cCCSemDV := substr(  alltrim(cContaSEE) , 1 , len(alltrim(cContaSEE))-1) 
		Endif
		oPrn:Say( 2350+nAjust2, 1880, alltrim(cAgencia) +'-'+cDigitAG+ "/" +alltrim(cContaSEE)+'-'+cDigitCC,oFont12,100  ) 
		//oPrn:Say( 2460+nAjust1, 1880, substr(nNossoNumE1,1,11)+'-'+substr(nNossoNumE1,12,1)          	,oFont12,100) 
	Elseif alltrim(sPAR01) == '422' 
		oPrn:Say( 2350+nAjust2, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 99999") + "/" + transform(Substr(alltrim(cContaSEE),1,9),"@R 99999999-9"),oFont12,100  )
	Else
		oPrn:Say( 2350+nAjust2, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 9999-9") + "/" + transform(Substr(alltrim(cContaSEE),1,8),"@R 9999999-9"),oFont12,100  )
	Endif
	
	oPrn:Say( 2380+nAjust2, 0070, "Endereço "       		,oFont13,100)
	oPrn:Say( 2415+nAjust2, 0090, cEndBeneficiario  		,oFont12,100)
	oPrn:Say( 2380+nAjust2, 1730, "Nosso Numero "           ,oFont13,100)

	
	oPrn:Say( 2450+nAjust2, 0070, "Data Documento "        ,oFont13,100  )
	oPrn:Say( 2450+nAjust2, 0510, "Nº Documento "         ,oFont13,100  )
	oPrn:Say( 2450+nAjust2, 0910, "Especie Doc. "          ,oFont13,100  )
	oPrn:Say( 2450+nAjust2, 1110, "Aceite "                ,oFont13,100  )
	oPrn:Say( 2450+nAjust2, 1410, "Data do Processamento " ,oFont13,100  )
	oPrn:Say( 2485+nAjust2, 0090, cData2                   ,oFont12,100  )
	oPrn:Say( 2485+nAjust2, 0520, U_AGX531()               ,oFont12,100  )
	oPrn:Say( 2485+nAjust2, 0970, "DM"	  ,oFont12,100)
	oPrn:Say( 2485+nAjust2, 1230, "Não"   ,oFont12,100)
	oPrn:Say( 2485+nAjust2, 1440, cData3  ,oFont12,100)
	
	oPrn:Say( 2525+nAjust2, 0070, "Uso do Banco "          ,oFont13,100  )
	oPrn:Say( 2525+nAjust2, 0510, "Carteira "			   ,oFont13,100  )
	oPrn:Say( 2525+nAjust2, 0710, "Especie "               ,oFont13,100  )
	oPrn:Say( 2525+nAjust2, 0910, "Quantidade "            ,oFont13,100  )
	oPrn:Say( 2525+nAjust2, 1410, "Valor "                 ,oFont13,100  )
	oPrn:Say( 2450+nAjust2, 1730, "(=) Valor do Documento" ,oFont13,100  )
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
  		oPrn:Say( 2555+nAjust2, 0540, "1"         			, oFont12,100  ) 
  		oPrn:Say( 2415+nAjust2, 1880, alltrim(str(val(aBancos[nPOS,11])))         	,oFont12,100)
 	ElseIf alltrim(sPAR01) == '237' 
   		oPrn:Say( 2555+nAjust2, 0540, cCartei/*"02"*/         			, oFont12,100  ) 
  		oPrn:Say( 2415+nAjust2, 1880, substr(nNossoNumE1,1,11)+'-'+substr(nNossoNumE1,12,1)           	,oFont12,100)
 	Elseif alltrim(sPAR01) == '422'
  		oPrn:Say( 2555+nAjust2, 0540, cCartei/*"02"*/         			, oFont12,100  ) 
  		oPrn:Say( 2415+nAjust2, 1880, substr(nNossoNumE1,1,11)         	,oFont12,100)
	Else                                           
		oPrn:Say( 2555+nAjust2, 0540   , "17/19" ,oFont12,100  )
		oPrn:Say( 2415+nAjust2, 1880, aBancos[nPOS,8]         	,oFont12,100)
	Endif
	oPrn:Say( 2555+nAjust2, 0745-30, "R$"    ,oFont12,100  )

	IF lTitAnt
		oPrn:Say( 2485+nAjust2, 1975, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
		oPrn:Say( 2555+nAjust2, 1440, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
    ELSE
		oPrn:Say( 2485+nAjust2, 1975, TRANSF(SE1->E1_SALDO,"@E 999,999.99") , oFont12,100  )
		oPrn:Say( 2555+nAjust2, 1440, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99"), oFont12,100  )
	ENDIF		


	oPrn:Say( 2595+nAjust2, 0070, "Instruções: ",oFont13,100  )
	oPrn:Say( 2525+nAjust2, 1730, "(-) Desconto/Abatimento",oFont13,100  )
	
	IF nAbatim>0
		oPrn:Say( 2540+nAjust2, 1975, TRANSF(nAbatim,"@E 999,999.99") , oFont12,100  )
	ENDIF                                                                                                

	//Exclusivo Banco   
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2650+nAjust2, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2680+nAjust2, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )
		oPrn:Say( 2710+nAjust2, 0090, "COBRAR TAXA DE 2% APÓS O VENCIMENTO E JUROS DE MORA 5% AO MÊS." ,oFont14,100  )
	ElseIf alltrim(sPAR01) == '237' //.And. cEmpant == '01'
		oPrn:Say( 2650+nAjust2, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2680+nAjust2, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  ) 
		If val(nJuros) > 0 
			oPrn:Say( 2710+nAjust2, 0090, "COBRAR JUROS DE MORA R$"+nJuros+" AO DIA." ,oFont14,100  )		
		Endif
	Elseif alltrim(sPAR01) == '422' 	
	   
		oPrn:Say( 2650+nAjust2, 0090, Iif(SE1->E1_DECRESC > 0,"Conceder desconto de R$ "    +AllTrim(Transform(SE1->E1_DECRESC,"@E 999,999.99"))+" ate o vencimento","") ,oFont14N,100)     
		oPrn:Say( 2680+nAjust2, 0090, Iif(SE1->E1_VALJUR  > 0,"COBRAR JUROS/MORA DIA DE R$ "+AllTrim(Transform(SE1->E1_VALJUR,"@E 999,999.99")),"") ,oFont14N,100)     
		/*oPrint:Say  (760,100 ,aBolText[1]                                      ,oFont10)     
		oPrint:Say  (810,100 ,aBolText[2]                                      ,oFont10)     
		oPrint:Say  (860,100 ,aBolText[3]                                      ,oFont10)    */
		//Chamado[151830] - Nova conta Safra
		//oPrn:Say( 2740+nAjust2, 0090, "ESTE BOLETO REPRESENTA DUPLICATA CEDIDA FIDUCIARIAMENTE AO BANCO SAFRA S/A," ,oFont14,100)     
		//oPrn:Say( 2770+nAjust2, 0090,"FICANDO VEDADO O PAGAMENTO DE QUALQUER OUTRA FORMA QUE NÃO ATRAVÉS DO" ,oFont14,100)     
		//oPrn:Say( 2810+nAjust2, 0090,"PRESENTE BOLETO. PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100)  
		oPrn:Say( 2770+nAjust2, 0090,"TODAS AS INFORMAÇÕES DESTE BLOQUETO SÃO DE EXCLUSIVA RESPONSABILIDADE DO BENEFICIÁRIO",oFont14,100) 
		oPrn:Say( 2810+nAjust2, 0090," PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100)    
	
	Else
		oPrn:Say( 2650+nAjust2, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont12,100) 
		oPrn:Say( 2680+nAjust2, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO."		 ,oFont12,100)
		oPrn:Say( 2710+nAjust2, 0090, "COBRAR JUROS DE MORA 6,9% AO MÊS." 					 ,oFont12,100)
   		If nmulta<>"0,00"
			oPrn:Say( 2740+nAjust2, 0090, "COBRAR MULTA DE 2% APÓS O VENCIMENTO." 			 ,oFont12,100  )
		EndIf    
    Endif

    If !Empty(sNotFat)
        oPrn:Say( 2800+nAjust2, 0090, "FATURA REF. NF : " + sNotFat ,oFont12,100  )
	EndIf
	
	If !Empty(SE1->E1_HIST)
        oPrn:Say( 2830+nAjust2+30, 0090, SE1->E1_HIST             ,oFont18,100  )	
	Else 
	    If nAbatim > 0 
	    
			dbSelectArea("SE1")
			_HistAbatim := ''
			nRecn := Recno()
			nInd  := dbSetOrder()
			sReg  := xFilial("SE1")+SE1->E1_PREFIXO+SE1->E1_NUM+SE1->E1_PARCELA+"AB-"
			dbSetOrder(1)
			DbSeek(sReg)
			If Found()
	      		_HistAbatim := SE1->E1_HIST
			Endif         
			dbSelectArea("SE1")
			dbSetOrder(nInd)
			DbGoto(	nRecn )
	         
	        If !Empty(_HistAbatim)	    
			    oPrn:Say( 2770+nAjust2, 0090, "* VLR ABATIM: "+AllTrim(_HistAbatim)+" *"       ,oFont18,100  )	 
			Endif    
	    Endif
	Endif	
	

	oPrn:Say( 2595+nAjust2, 1730, "(-) Outras deduções "   ,oFont13,100  )
	IF SE1->E1_DECRESC>0
		oPrn:Say( 2620+nAjust2, 1975, TRANSF(SE1->E1_DECRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2660+nAjust2, 1730, "(+) Mora/Multa/Juros "  ,oFont13,100  )
	oPrn:Say( 2730+nAjust2, 1730, "(+) Outros Acréscimos"  ,oFont13,100  )
	IF SE1->E1_ACRESC>0
		oPrn:Say( 2755+nAjust2, 1975, TRANSF(SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	

	oPrn:Say( 2800+nAjust2, 1730, "(=) Valor Cobrado "     ,oFont13,100  )
	IF (SE1->E1_DECRESC+nAbatim+SE1->E1_ACRESC)>0
		oPrn:Say( 2820+nAjust2, 1975, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF


	oPrn:Say( 2935+nAjust2, 0070, "Pagador "                 ,oFont13,100  )
	oPrn:Say( 2965+nAjust2, 0090, ALLTRIM(SE1->E1_CLIENTE) + " - " + ALLTRIM(cNome) + " - " +cCgc, oFont12,100)
	
	IF  Empty(SA1->A1_ENDCOB)
		oPrn:Say( 3000+nAjust2, 0090, ALLTRIM(SA1->A1_END), oFont12,100)
		oPrn:Say( 3040+nAjust2, 0090, TRANSFORM(SA1->A1_CEP,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRRO)+" - "+ALLTRIM(SA1->A1_MUN)+" - "+SA1->A1_EST, oFont12,100  )
	ELSE
		oPrn:Say( 3000+nAjust2, 0090, ALLTRIM(SA1->A1_ENDCOB), oFont12,100)
		oPrn:Say( 3040+nAjust2, 0090, TRANSFORM(SA1->A1_CEPC,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRROC)+" - "+ALLTRIM(SA1->A1_MUNC)+" - "+SA1->A1_ESTC, oFont12,100  )
	ENDIF
	
	cCNPJFilial = SM0->M0_CGC//'05097311000134'
	oPrn:Say( 3105+nAjust2, 0070, "Beneficiário "                 ,oFont13,100  )
	oPrn:Say( 3105+nAjust2, 0200, ALLTRIM(SM0->M0_NOMECOM)+" - "+TRANSFORM(ALLTRIM(cCNPJFilial), "@R 99.999.999/9999-99"), oFont12,100  ) //oPrn:Say( 3000+nAjust2, 0190, SM0->M0_NOMECOM		, oFont12,100  ) //Alterado 14/12/2011 - BRUNO
	
	oPrn:Say( 60+3095+nAjust2, 1450, "Autenticação Mecânica"   ,oFont4,100  )  
	oPrn:Say( 3095+nAjust2, 1950, "Recibo do Pagador"    	,oFont4,100  )


	
	//******************************************
	//  MONTA FICHA COMPENSAÇÃO    +nAjust3
	//******************************************
	
	// Monta linhas horizontais
	oPrn:Line(2220+nAjust3+70, 0050, 2220+nAjust3+70, 2380)
	oPrn:Line(2290+nAjust3+70, 0050, 2290+nAjust3+70, 2380)
	oPrn:Line(2360+nAjust3+70, 0050, 2360+nAjust3+70, 2380)
	oPrn:Line(2430+nAjust3+70, 0050, 2430+nAjust3+70, 2380)
	oPrn:Line(2500+nAjust3+70, 0050, 2500+nAjust3+70, 2380)
	oPrn:Line(2570+nAjust3+70, 0050, 2570+nAjust3+70, 2380) 
	
	oPrn:Line(2845+nAjust3+140, 0050, 2845+nAjust3+140, 2380)
	oPrn:Line(3050+nAjust3+140, 0050, 3050+nAjust3+140, 2380)
	
	oPrn:Line(2570+nAjust3+140, 1720, 2570+nAjust3+140, 2380)
	oPrn:Line(2640+nAjust3+140, 1720, 2640+nAjust3+140, 2380)
	oPrn:Line(2710+nAjust3+140, 1720, 2710+nAjust3+140, 2380)
	
	// Monta linha verticais
	oPrn:Line(2135+nAjust3+70 , 0620, 2215+nAjust3+70, 0620)
	oPrn:Line(2135+nAjust3+70 , 0830, 2215+nAjust3+70, 0830)
	
	oPrn:Line(2220+nAjust3+70,  1720, 2915+nAjust3+70,  1720)
	oPrn:Line(2360+nAjust3+140, 0500, 2500+nAjust3+140, 0500)
	oPrn:Line(2360+nAjust3+140, 0900, 2500+nAjust3+140, 0900)
	oPrn:Line(2360+nAjust3+140, 1100, 2430+nAjust3+140, 1100)
	oPrn:Line(2360+nAjust3+140, 1400, 2500+nAjust3+140, 1400)
	oPrn:Line(2430+nAjust3+140, 0700, 2500+nAjust3+140, 0700)
	
	IF FILE(aBancos[nPOS,3])
		oPrn:SayBitmap( 2150+nAjust3-15+50, 0050,aBancos[nPOS,3],400,90 )
	ELSE
		oPrn:Say( 2200+nAjust3+70, 0050, aBancos[nPOS,2]	,oFont24,100)
	ENDIF
	
	oPrn:Say( 2200+nAjust3+70, 0640, aBancos[nPOS,4]		,oFont20,100)
	oPrn:Say( 2200+nAjust3+70, 0880, aBancos[nPOS,7]        ,oFont5,100)
	
	oPrn:Say( 2240+nAjust3+70, 0070, "Local de Pagamento "  ,oFont13,100  )
	oPrn:Say( 2240+nAjust3+70, 1730, "Vencimento "          ,oFont13,100  )
	oPrn:Say( 2275+nAjust3+70, 0090, iif(alltrim(sPAR01) == '422',"PAGÁVEL EM QUALQUER BANCO DO SISTEMA DE COMPENSAÇÃO","PAGÁVEL EM QUALQUER BANCO ATÉ O VENCIMENTO"),oFont22,100  )
	oPrn:Say( 2270+nAjust3+70, 1880, cData     ,oFont12,100  )
	
	oPrn:Say( 2310+nAjust3+70, 0070, "Beneficiário "                ,oFont13,100  )
	oPrn:Say( 2310+nAjust3+70, 1730, "Agência/Codigo Beneficiário " ,oFont13,100  ) 
	oPrn:Say( 2345+nAjust3+70, 0090, ALLTRIM(SUBS(SM0->M0_NOMECOM,1,50))+" - CNPJ: "+ALLTRIM(TRANSFORM(SM0->M0_CGC, "@R 99.999.999/9999-99"))		,oFont11,100  )
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2345+nAjust3+70, 1880, alltrim(cAgencia) +'-'+SEE->EE_DVAGE+ "/" +alltrim(SEE->EE_CODEMP),oFont12,100  )
		oPrn:Say( 2410+nAjust3+70,  1880, alltrim(str(val(aBancos[nPOS,11]))), oFont12,100  )
	ElseIf alltrim(sPAR01) == '237' 
	    if ALLTRIM(SEE->EE_DVAGE) <> ''
	      	cDigitAG := SEE->EE_DVAGE
	    Else
	    	cDigitAG := '0'
	    Endif
		if alltrim(SEE->EE_DVCTA) <> ''
			cDigitCC := SEE->EE_DVCTA
			cCCSemDV := alltrim(cContaSEE)
		Else
	   		cDigitCC := SUBSTR(alltrim(cContaSEE),LEN(alltrim(cContaSEE)),1) 
	   		cCCSemDV := substr(  alltrim(cContaSEE) , 1 , len(alltrim(cContaSEE))-1)
		Endif
		oPrn:Say( 2345+nAjust3+70, 1880, alltrim(cAgencia) +'-'+cDigitAG+ "/" +alltrim(cCCSemDV)+'-'+cDigitCC,oFont12,100  ) 
		oPrn:Say( 2410+nAjust3+70, 1880, substr(nNossoNumE1,1,11)+'-'+substr(nNossoNumE1,12,1)          	,oFont12,100) 
	Elseif alltrim(sPAR01) == '422' 
		oPrn:Say( 2345+nAjust3+70, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 99999") + "/" + transform(Substr(alltrim(cContaSEE),1,9),"@R 99999999-9"),oFont12,100  )
		oPrn:Say( 2410+nAjust3+70,  1880, aBancos[nPOS,8], oFont12,100  )
	Else
		oPrn:Say( 2345+nAjust3+70, 1880, transform(strzero(val(StrTran(cAgencia,"-","")),5),"@R 9999-9") + "/" + transform(Substr(alltrim(cContaSEE),1,8),"@R 9999999-9"),oFont12,100  )
		oPrn:Say( 2410+nAjust3+70,  1880, aBancos[nPOS,8], oFont12,100  )
	Endif
	
	oPrn:Say( 2375+nAjust3+70, 0070, "Endereço "     , oFont13,100  )
	oPrn:Say( 2410+nAjust3+70, 0090, cEndBeneficiario, oFont12,100  )   	
	oPrn:Say( 2375+nAjust3+70, 1730, "Nosso Numero"  , oFont13,100  )

	

	oPrn:Say( 2380+nAjust3+140, 0070, "Data Documento "        ,oFont13,100  )
	oPrn:Say( 2380+nAjust3+140, 0510, "Nº Documento "         ,oFont13,100  )
	oPrn:Say( 2380+nAjust3+140, 0910, "Especie Doc. "          ,oFont13,100  )
	oPrn:Say( 2380+nAjust3+140, 1110, "Aceite "                ,oFont13,100  )
	oPrn:Say( 2380+nAjust3+140, 1410, "Data do Processamento " ,oFont13,100  )

	oPrn:Say( 2410+nAjust3+140, 0090, cData2      , oFont12,100  )
	oPrn:Say( 2410+nAjust3+140, 0520, U_AGX531()  , oFont12,100  )
	oPrn:Say( 2410+nAjust3+140, 0970, "DM"        , oFont12,100  )
	oPrn:Say( 2410+nAjust3+140, 1230, "Não"       , oFont12,100  )
	oPrn:Say( 2410+nAjust3+140, 1440, cData3      , oFont12,100  )
	
	oPrn:Say( 2455+nAjust3+140, 0070, "Uso do Banco "          ,oFont13,100  )
	oPrn:Say( 2455+nAjust3+140, 0510, "Carteira "              ,oFont13,100  )
	oPrn:Say( 2455+nAjust3+140, 0710, "Especie "               ,oFont13,100  )
	oPrn:Say( 2455+nAjust3+140, 0910, "Quantidade "            ,oFont13,100  )
	oPrn:Say( 2455+nAjust3+140, 1410, "Valor "                 ,oFont13,100  )
	oPrn:Say( 2455+nAjust3+70,  1730, "(=) Valor do Documento" ,oFont13,100  )
	
	//Exclusivo Banco                                           
	If alltrim(sPAR01) == '756'
  		oPrn:Say( 2480+nAjust3+140, 0540, "1"         			, oFont12,100  ) 
  	ElseIf alltrim(sPAR01) == '237' .OR.  alltrim(sPAR01) == '422'
  		oPrn:Say( 2480+nAjust3+140, 0540, cCartei/*"02"*/         			, oFont12,100  )
	Else
		oPrn:Say( 2480+nAjust3+140, 0540   , "17/19"    		   , oFont12,100  ) 
	Endif

	oPrn:Say( 2480+nAjust3+140, 0745-30, "R$"                  , oFont12,100  )
	
	IF lTitAnt
		oPrn:Say(2480+nAjust3+140, 1440, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
		oPrn:Say( 2480+nAjust3+70, 1975, TRANSF(nVlrCob,"@E 999,999.99"), oFont12,100  )
    ELSE
		oPrn:Say(2480+nAjust3+140, 1440, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99"), oFont12,100  )
		oPrn:Say( 2480+nAjust3+70, 1975, TRANSF(SE1->E1_SALDO,"@E 999,999.99") , oFont12,100  )
	ENDIF		
	

	oPrn:Say( 2520+nAjust3+70, 1730, "(-) Desconto/Abatimento "          , oFont13,100  )
	IF nAbatim>0
		oPrn:Say( 2540+nAjust3+70, 1975, TRANSF(nAbatim,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2525+nAjust3+140, 0070, "Instruções "            ,oFont13,100  )
                                                          
	//Exclusivo Banco   
	If alltrim(sPAR01) == '756'
		oPrn:Say( 2580+nAjust3+140, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2610+nAjust3+140, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )
		oPrn:Say( 2640+nAjust3+140, 0090, "COBRAR TAXA DE 2% APÓS O VENCIMENTO E JUROS DE MORA 5% AO MÊS." ,oFont14,100  )	
	ElseIf alltrim(sPAR01) == '237'// .And. cEmpant == '01'
		oPrn:Say( 2580+nAjust3+140, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR." ,oFont14,100  ) 
		oPrn:Say( 2610+nAjust3+140, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO." ,oFont14,100  )
		If val(nJuros) > 0 
			oPrn:Say( 2640+nAjust3+140, 0090, "COBRAR JUROS DE MORA R$"+nJuros+" AO DIA." ,oFont14,100  )	
		Endif 
	Elseif alltrim(sPAR01) == '422' 	
	   
		oPrn:Say( 2580+nAjust3+140, 0090, Iif(SE1->E1_DECRESC > 0,"Conceder desconto de R$ "    +AllTrim(Transform(SE1->E1_DECRESC,"@E 999,999.99"))+" ate o vencimento","") ,oFont14N,100)     
		oPrn:Say( 2610+nAjust3+140, 0090, Iif(SE1->E1_VALJUR  > 0,"COBRAR JUROS/MORA DIA DE R$ "+AllTrim(Transform(SE1->E1_VALJUR,"@E 999,999.99")),"") ,oFont14N,100)     
		/*oPrint:Say  (760,100 ,aBolText[1]                                      ,oFont10)     
		oPrint:Say  (810,100 ,aBolText[2]                                      ,oFont10)     
		oPrint:Say  (860,100 ,aBolText[3]                                      ,oFont10)    */  
		//Chamado[151830] - Nova conta Safra
		/*oPrn:Say( 2670+nAjust3+140, 0090, "ESTE BOLETO REPRESENTA DUPLICATA CEDIDA FIDUCIARIAMENTE AO BANCO SAFRA S/A," ,oFont14,100)     
		oPrn:Say( 2700+nAjust3+140, 0090,"FICANDO VEDADO O PAGAMENTO DE QUALQUER OUTRA FORMA QUE NÃO ATRAVÉS DO" ,oFont14,100)     
		oPrn:Say( 2730+nAjust3+140, 0090,"PRESENTE BOLETO. PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100)*/ 
		oPrn:Say( 2700+nAjust3+140, 0090,"TODAS AS INFORMAÇÕES DESTE BLOQUETO SÃO DE EXCLUSIVA RESPONSABILIDADE DO BENEFICIÁRIO" ,oFont14,100)  	
		oPrn:Say( 2730+nAjust3+140, 0090,"PARA EMISSÃO DE SEGUNDA VIA, WWW.SAFRAEMPRESAS.COM.BR." ,oFont14,100)
	Else
		oPrn:Say( 2580+nAjust3+140, 0090, "NÃO DISPENSAR JUROS DE MORA E RECUSAR VALOR A MENOR."  ,oFont12,100  ) 
		oPrn:Say( 2610+nAjust3+140, 0090, "APÓS O VENCIMENTO TITULO SUJEITO A PROTESTO."          ,oFont12,100  )
		oPrn:Say( 2640+nAjust3+140, 0090, "COBRAR JUROS DE MORA 6,9% AO MÊS"                        ,oFont12,100  )  
		If nmulta<>"0,00"
			oPrn:Say( 2670+nAjust3+140, 0090, "COBRAR MULTA DE 2% APÓS O VENCIMENTO." ,oFont14,100  )
		EndIf  
    Endif
 

	IF !Empty(sNotFat)
        oPrn:Say( 2730+nAjust3+140, 0090, "FATURA REF. NF : " + sNotFat ,oFont14,100  )
	ENDIF

	If !Empty(SE1->E1_HIST)
        oPrn:Say( 2830+nAjust3+70+30, 0090, SE1->E1_HIST             ,oFont18,100  )	
	Else 
	    If nAbatim > 0 
	    
			dbSelectArea("SE1")
			_HistAbatim := ''
			nRecn := Recno()
			nInd  := dbSetOrder()
			sReg  := xFilial("SE1")+SE1->E1_PREFIXO+SE1->E1_NUM+SE1->E1_PARCELA+"AB-"
			dbSetOrder(1)
			DbSeek(sReg)
			If Found()
	      		_HistAbatim := SE1->E1_HIST
			Endif         
			dbSelectArea("SE1")
			dbSetOrder(nInd)
			DbGoto(	nRecn )
	         
	        If !Empty(_HistAbatim)	    
			    oPrn:Say( 2770+nAjust3+70, 0090, "* VLR ABATIM: "+AllTrim(_HistAbatim)+" *"       ,oFont18,100  )	 
			Endif    
	    Endif
	Endif	
		
		
	oPrn:Say( 2590+nAjust3+70, 1730, "(-) Outras deduções "   ,oFont13,100  )
	IF SE1->E1_DECRESC>0
		oPrn:Say( 2610+nAjust3+70, 1975, TRANSF(SE1->E1_DECRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2665+nAjust3+70, 1730, "(+) Mora/Multa/Juros "  ,oFont13,100  )
	oPrn:Say( 2730+nAjust3+70, 1730, "(+) Outros Acréscimos"  ,oFont13,100  )
	
	IF SE1->E1_ACRESC>0
		oPrn:Say( 2745+nAjust3+70, 1975, TRANSF(SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF
	
	oPrn:Say( 2805+nAjust3+70, 1730, "(=) Valor Cobrado "     ,oFont13,100  )
	IF (SE1->E1_DECRESC+nAbatim+SE1->E1_ACRESC)>0
		oPrn:Say( 2835+nAjust3+70, 1975, TRANSF(SE1->E1_SALDO-SE1->E1_DECRESC-nAbatim+SE1->E1_ACRESC,"@E 999,999.99") , oFont12,100  )
	ENDIF


	oPrn:Say( 2870+nAjust3+140, 0070, "Pagador "                 ,oFont13,100  )
	oPrn:Say( 2910+nAjust3+140, 0090, ALLTRIM(SE1->E1_CLIENTE) + " - " + ALLTRIM(cNome)+" - " +cCgc, oFont12,100  )
	IF  Empty(SA1->A1_ENDCOB) 
		oPrn:Say( 2945+nAjust3+140, 0090, ALLTRIM(SA1->A1_END), oFont12,100)
		oPrn:Say( 2985+nAjust3+140, 0090, TRANSFORM(SA1->A1_CEP,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRRO)+" - "+ALLTRIM(SA1->A1_MUN)+" - "+SA1->A1_EST, oFont12,100  )
	ELSE
		oPrn:Say( 2945+nAjust3+140, 0090, ALLTRIM(SA1->A1_ENDCOB), oFont12,100)
		oPrn:Say( 2985+nAjust3+140, 0090, TRANSFORM(SA1->A1_CEPC,"@R 99999-999")+" - "+ALLTRIM(SA1->A1_BAIRROC)+" - "+ALLTRIM(SA1->A1_MUNC)+" - "+SA1->A1_ESTC, oFont12,100  )
	ENDIF
	
	oPrn:Say( 3040+nAjust3+140, 0070, "Sacador / Avalista: "      ,oFont13,100 )
	oPrn:Say( 3250+nAjust3+120, 1450, "Autenticação Mecânica"   ,oFont4,100  )  
	oPrn:Say( 3250+nAjust3+120, 1950, "Ficha de Compensação"    ,oFont4,100  ) 


	oPrn:FWMsBar("INT25", 62.5, 1.0 ,cbarraFim, oPrn, .F., NIL,.T.,0.025,1.0,.F.,NIL,NIL,LPRINT)
	oPrn:Line(2520+200-30+170, 0050, 2520+200-30+170, 2380)

	oPrn:Say( 2540+200-30+170, 1950, "Cortar Aqui"    ,oFont13,100  ) //nAjuste3
	oPrn:Say( 1620,1950, "Cortar Aqui"    ,oFont13,100  ) //nAjuste2   
	oPrn:Say( 0570,1950, "Cortar Aqui"    ,oFont13,100  ) //nAjuste1
	

oPrn:EndPage()

RETURN(.t.)     


//RadioButton de Escolha do banco
User Function AGR095RA(xCodBanco,xAgencia,xConta,xSubCon,xCarteira)  
    
	Local lRet := .F.                      
	Local cRet := ''
	Default xCodBanco := '000'  
	
	DEFINE DIALOG oDlgRAD TITLE "    Selecione o Banco  " FROM 080,080 TO 200,275 PIXEL    
		nRadio := 0                         
		aItems := {'Banco do Brasil','Sicoob','Bradesco','NYKE'/*,'Santander','Item05'*/}    
		oRadio := TRadMenu():New (10,10,aItems,,oDlgRAD,,,,,,,,100,050,,,,.T.)     
		oRadio:bSetGet := {|u|Iif (PCount()==0,nRadio,nRadio:=u)}
		oRadio:bchange := {|u|oDlgRAD:end()}	  
	ACTIVATE DIALOG oDlgRAD CENTERED 
   
    //Caso selecionou algum banco valida codigo
	If nRadio > 0 
   		lRet := u_XAG0001(xCodBanco,aItems[nRadio],.t.,xAgencia,xConta,xSubCon,xCarteira) 
 		
 		//Se retornar Falso, Grava retorno como ERRO
 		If  !lRet
 			cRet := 'ERRO'
 		Endif
 	Endif   
 	
Return cRet//lRet    
                                                

// Calcula o Digito Verificador do Nosso Numero 
User Function AGR095DV(xbanco,xCarteira)  
******************************  
                         
	Local nNNsemCEDE := 0   
	Default xCarteira := ""
      

	nCont := 'E'
	
	if xbanco == '237' //Bradesco
	  	//Spiller Validar aqui qual a carteira
	  	if xCarteira == '' .or. val(xCarteira) == 2
	  		cCartei := '02'
	  	elseif val(xCarteira) == 9
	  		cCartei := '09'
		else
			cCartei := STRZERO(val(xCarteira),2)
	  	endif
		nSoma1 := val(subs(alltrim(cCartei),01,1))*2  // Como o campo tem 3 posiçoes no parametro considera as duas ultimas 007 = 07
		nSoma2 := val(subs(alltrim(cCartei),02,1))*7  // Como o campo tem 3 posiçoes no parametro considera as duas ultimas 007 = 07
		nSoma3 := val(subs(StrZero(nNossoNum,11),01,1))*6
		nSoma4 := val(subs(StrZero(nNossoNum,11),02,1))*5
		nSoma5 := val(subs(StrZero(nNossoNum,11),03,1))*4
		nSoma6 := val(subs(StrZero(nNossoNum,11),04,1))*3
		nSoma7 := val(subs(StrZero(nNossoNum,11),05,1))*2
		nSoma8 := val(subs(StrZero(nNossoNum,11),06,1))*7
		nSoma9 := val(subs(StrZero(nNossoNum,11),07,1))*6
		nSomaA := val(subs(StrZero(nNossoNum,11),08,1))*5
		nSomaB := val(subs(StrZero(nNossoNum,11),09,1))*4
		nSomaC := val(subs(StrZero(nNossoNum,11),10,1))*3
		nSomaD := val(subs(StrZero(nNossoNum,11),11,1))*2
		
		cDigito := mod((nSoma1+nSoma2+nSoma3+nSoma4+nSoma5+nSoma6+nSoma7+;
		nSoma8+nSoma9+nSomaA+nSomaB+nSomaC+nSomaD),11)
		
		nCont := iif(cDigito == 1, "P", iif(cDigito == 0 , "0", strzero(11-cDigito,1)))   
	
	Elseif xbanco == '001' //BB
	   
 
		   nSoma1 := 0 //val(subs(alltrim(mv_par17),01,1))*2
		   nSoma2 := 0 //val(subs(alltrim(mv_par17),02,1))*7
		   nSoma3 := val(subs(StrZero(nNossoNum,11),01,1))*7
		   nSoma4 := val(subs(StrZero(nNossoNum,11),02,1))*8
		   nSoma5 := val(subs(StrZero(nNossoNum,11),03,1))*9
		   nSoma6 := val(subs(StrZero(nNossoNum,11),04,1))*2
		   nSoma7 := val(subs(StrZero(nNossoNum,11),05,1))*3
		   nSoma8 := val(subs(StrZero(nNossoNum,11),06,1))*4
		   nSoma9 := val(subs(StrZero(nNossoNum,11),07,1))*5
		   nSomaA := val(subs(StrZero(nNossoNum,11),08,1))*6
		   nSomaB := val(subs(StrZero(nNossoNum,11),09,1))*7
		   nSomaC := val(subs(StrZero(nNossoNum,11),10,1))*8
		   nSomaD := val(subs(StrZero(nNossoNum,11),11,1))*9
		
		   cDigito := mod(nSoma1+nSoma2+nSoma3+nSoma4+nSoma5+nSoma6+nSoma7+;
		   nSoma8+nSoma9+nSomaA+nSomaB+nSomaC+nSomaD,11)    
		   nCont := iif(cDigito == 10, "X", iif(cDigito == 0 , "0", strzero(cDigito,1)))
	EndIf

Return nCont  
 


//Valida se Nosso Numero já Existe e Retorna Mensagem de erro 
User Function AGR095NN(xNumBCO,xNumTit,xBanco,xAgencia,xConta,xEmissao)
	
	Local lRet    := .T.
	Local cQuery  := "" 
	Local dMinEmis := xEmissao - 365 //Estipulado verificação em 1 ano
		
	cQuery := " SELECT * FROM "+RetSqlName('SE1')+"(NOLOCK) " 
	cQuery += " WHERE  E1_ZNBANCO = '"+alltrim(xNumBCO)+"' "
	cQuery += " AND D_E_L_E_T_ = '' AND E1_NUM <> '"+alltrim(xNumTit)+"' "
	cQuery += " AND E1_EMISSAO >= '"+dtos(dMinEmis)+"' "
	cQuery += " AND E1_PORTADO = '"+xBanco+"' "
	cQuery += " AND E1_AGEDEP = '"+xAgencia+"' "
	cQuery += " AND E1_CONTA  = '"+xConta+"' "  
	
	If Select("AGR095NN") <> 0
		dbSelectArea("AGR095NN")
   		dbCloseArea()
	Endif    
	
	TCQuery cQuery NEW ALIAS "AGR095NN"  
	
	AGR095NN->(dbgotop())
	If  AGR095NN->(!eof()) 
	     EnvNN(xNumBCO,' Duplicado')
	     ALERT('Campo Nosso Numero Duplicado, Entre em contato com a TI e Não envie o Boleto para o Cliente ! ')   
	     lRet := .F.
	Endif   
	  

Return lRet  
     
//Envia Email de NN Duplicado
Static Function EnvNN(xNumBCO,xMsg)  

	Default xMsg := ""
   		
	oProcess := TWFProcess():New( "EMAILPALM", "Emissao Boleto" )
		
	//Verifica se existe Msg por EMPRESA  
	IF FILE(AllTrim(getmv("MV_WFDIR"))+"\WFBOLETO"+cEmpant+".HTM")
		oProcess:NewTask( "Inicio", AllTrim(getmv("MV_WFDIR"))+"\WFBOLETO"+cEmpant+".HTM" )
	Else
		oProcess:NewTask( "Inicio", AllTrim(getmv("MV_WFDIR"))+"\WFBOLETO.HTM" )
	Endif	                   
		
	oProcess:ClientName(cUsername)
	oProcess:cTo := "spiller@agricopel.com.br;leandrohey@gmail.com"  
	
      		
     _cEmpresa := FWEmpName(cEmpant) 	
		
	Do Case
		Case alltrim(cBanco) == '001'
	          cNomeBanco := 'Banco do Brasil'             
		Case alltrim(cBanco) == '756'
	          cNomeBanco := 'Sicoob'         
		Case alltrim(cBanco) == '237'
	          cNomeBanco := 'Bradesco'         
		Case alltrim(cBanco) == '422'
	         cNomeBanco := 'Safra'       
		Case alltrim(cBanco) == '033'
	          cNomeBanco := 'Santander'          
		Case alltrim(cBanco) == '104'
	         cNomeBanco := 'Caixa' 
	Otherwise
	    	  cNomeBanco := ''      
	EndCase        
		    
	oHtml := oProcess:oHTML
			
	//Variáveis do HTML
	oHtml:ValByName("Nome_Banco",cNomeBanco ) 
	oHtml:ValByName("Nome_Emp",_cEmpresa ) 
		
			       		
	oProcess:cSubject := "ERRO NOSSO NUMERO"+xMsg+" "+xNumBCO+", Usuario "+cUsername+",Empresa "+_cEmpresa
				
	If !Empty(oProcess:Start())
		oProcess:Finish()
	Endif

Return



// Envio de E-mail, alterado para essa funçã devido a poder escolher 
// o campo FROM
Static Function SendMail(cFrom, cTo, cCC, cSubject, cMsg, cAttach)
********************************************************************

	Local cServer    := GetMV("MV_RELSERV"),;
		  cAccount   := GetMV("MV_RELACNT"),;
		  cPassword  := GetMV("MV_RELPSW"),;
		  lAutentica := GetMv("MV_RELAUTH")
	Local lEmOk, cError    
	
	Begin Sequence 
	
	conout('OpenSendMail')
	
	If !Empty(cServer) .and. !Empty(cAccount)
		CONNECT SMTP SERVER cServer ACCOUNT cAccount PASSWORD cPassword Result lEmOk
		If lEmOk
			If lAutentica
				If !MailAuth(cAccount, cPassword)
					DISCONNECT SMTP SERVER
					MsgInfo("Falha na Autenticacao do Usuario","Alerta")
					lEmOk := .F.
					Break
				EndIf
			EndIf
			/*
			SEND MAIL FROM cEnvia;
			TO cRecebe;
			SUBJECT 'Email pelo Protheus' ;
			BODY cMensagem;
			ATTACHMENT aFiles[1], aFiles[2];
			RESULT lEnviado
			*/
			
			If cAttach <> Nil
				SEND MAIL FROM cFrom TO cTo CC cCC SUBJECT cSubject BODY cMsg ATTACHMENT cAttach Result lEmOk
			Else
				SEND MAIL FROM cFrom TO cTo CC cCC SUBJECT cSubject BODY cMsg Result lEmOk
			Endif
			
			
			//SEND MAIL FROM cFrom TO cTo CC cCC SUBJECT cSubject BODY cMsg ATTACHMENT cAttach Result lEmOk
			//SEND MAIL FROM cFrom TO cTo CC cCC SUBJECT cSubject BODY cMsg Result lEmOk
			
			If !lEmOk
				GET MAIL ERROR cError
				Conout("Erro no envio de Email - "+cError+" O e-mail '"+cSubject+"' não pôde ser enviado.", "Alerta")
			Else
				//MsgInfo(STR0046, STR0056)//
				Conout("E-mail enviado com sucesso - "+cTo)
			EndIf
			DISCONNECT SMTP SERVER
		Else
			GET MAIL ERROR cError
			DISCONNECT SMTP SERVER
			Conout("Erro na conexão com o servidor de Email - "+cError+"O e-mail '"+cSubject+"' não pôde ser enviado.","Alerta")
		EndIf
	Else
		Conout("Não foi possível enviar o e-mail porque o as informações de servidor e conta de envio não estão configuradas corretamente.", "Alerta")  
		lEmOk := .F.
	EndIf
	
	End Sequence

Return lEmOk
           

//Busca Email do Projeto Nyke
Static Function EMailNyke(xEmpDe,xCnpj)//(xCodEmp,xEntDes,xEndDes)
            
	Local cQuery   := ""
	Local cMailRet := "" 
	Local cMaiNFE  := ""
	Local oXagCon  := XagConexao():New()

	Default xEmpDe := ""
	Default xCnpj  := ""
	
	oXagCon:ConecDBG()
	
	//_CACAACAC := AdvConnection() 
	//CONOUT('AGR095 3695')
	//CONOUT(_CACAACAC)
	
	cQuery  := " SELECT GEN_ENDENT_EmailNFe,GEN_TABENT_Codigo,GEN_ENDENT_Codigo,GEN_ENDENT_EmailNFe AS EMAIL FROM GEN_ENDENT "
	cQuery  += " WHERE GEN_ENDENT_IF = '"+xCnpj+"' " 
	//CONOUT(cQuery)
	If Select("EMailNyke") <> 0
  		dbSelectArea("EMailNyke")
   		EMailNyke->(dbCloseArea())
  	Endif                     
  	
  	//Só executa TcQuery se O DBGINT consehuir conectar
  	If (TCSQLExec(cQuery) < 0)
		CONOUT('3635 - Erro Execução query DBGINT '+cQuery )
	Else 
		TCQuery cQuery NEW ALIAS ("EMailNyke") 	
	EndIf
      
	//Se não tiver gerado Sql nao seleciona a tabela 
	If Select("EMailNyke") <> 0        
  
		EMailNyke->(dbgotop())  
		If EMailNyke->(!eof())
			cMaiNFE := EMailNyke->EMAIL
		Endif
	
		cQuery  := " SELECT CTE_CLINYK_EmailBoleto as EMAIL " 
		cQuery  += " FROM CTE_CLINYK  "
		cQuery  += " WHERE STG_GEN_TABEMP_CTe_Codigo = '"+alltrim(str(xEmpDe))+"' AND "
		cQuery  += " STG_GEN_TABENT_NYK_Codigo ='"+alltrim(str(EMailNyke->GEN_TABENT_Codigo))+"' AND "
		cQuery  += " STG_GEN_ENDENT_NYK_Codigo ='"+alltrim(str(EMailNyke->GEN_ENDENT_Codigo)) +"' "
		
		//Se não tiver gerado Sql nao seleciona a tabela 
		If Select("EMailNyke") <> 0
	  		dbSelectArea("EMailNyke")
	   		EMailNyke->(dbCloseArea())
	  	Endif      
	  	
  	Endif
    
    	//Só executa TcQuery se O DBGINT consehuir conectar   
    If (TCSQLExec(cQuery) < 0)
		CONOUT('3664 - AGR095: Erro Execução query DBGINT: '+cQuery )
	Else 
    	TCQuery cQuery NEW ALIAS ("EMailNyke") 
 	Endif
	        
	//Se não tiver gerado Sql nao seleciona a tabela 
	If Select("EMailNyke") <> 0     
		EMailNyke->(dbgotop())
		If EMailNyke->(!eof())
			cMailRet := EMailNyke->EMAIL
		Endif   
	Endif
	 
	//Se não achar no E-mail específico, Pega da Tabela de Clientes
	If alltrim(cMailRet) == ''
		cMailRet := cMaiNFE
	Endif     
	
	Conout('AGR095: E-MAIL NYKE: '+cMailRet) 
	
	oXagCon:ConecPRT()

Return cMailRet
                 

//Grava Campo de Email enviado
Static function GravaMailE1(xARecno,xMail)
      
	Local cQryE1 := "" 
	Local _i 
	Local cRecno := ""  
		    
	//Grava String com recnos
	For _i := 1 to len(xARecno)
	    If  _i == 1 
			cRecno += alltrim(str(xARecno[_i]))
	    Else
	   		cRecno += ','+alltrim(str(xARecno[_i]))+'' 
	    Endif     
	Next _i  
	
	Dbselectarea('SE1')
	IF SE1->(FieldPos("E1_XMAILBO")) > 0  .AND. SE1->(FieldPos("E1_XDHENV")) > 0
		//Atualiza Campo XMAILBO
		cQryE1 := " UPDATE "+Retsqlname('SE1')+" " 	
		cQryE1 += " SET E1_XMAILBO = '"+xMail+"',E1_XDHENV = '"+SUBSTR(alltrim(dtos(date()))+'-'+SUBSTR(TIME(), 1, 5)+'-'+cUsername,1,25)+"'" 
		cQryE1 += " WHERE R_E_C_N_O_ IN ("+cRecno+") "  
		TcSqlExec(cQryE1)
	Endif
Return


Static Function NumMes(_cMes)

	Default _cMes := ""
	
	Do Case 
		Case _cMes == "A"
			_cMes := "01"
		Case _cMes == "B"
			_cMes := "02"
		Case _cMes == "C"
			_cMes := "03"
		Case _cMes == "D"
			_cMes := "04"
		Case _cMes == "E"
			_cMes := "05"
		Case _cMes =="F"
			_cMes := "06"
		Case _cMes == "G"
			_cMes := "07"
		Case _cMes == "H"
			_cMes := "08"
		Case _cMes == "I"
			_cMes := "09"
		Case _cMes == "J"
			_cMes := "10"
		Case _cMes == "K"
			_cMes := "11"																		
		Case _cMes == "L"
			_cMes := "12"
	End Case
	
Return _cMes   

    
//Valida prefixo de NN 
Static function ValidaPref(xBanco,xAgencia,xConta,xNossoNumE1)    

	Local  lRet    := .T. 
	Local _cPrefixo := ""
     
	If cempant == '01' 
		If xBanco == '237' .and. alltrim(xConta) == '00277207'   //BRADESCO 
			_cPrefixo := '03562'
			If SUBSTR(alltrim(xNossoNumE1),1,5) <>  _cPrefixo
				EnvNN(xNumBCO,' Prefixo NN incorreto')
		    	ALERT('Problema com o Campo nosso numero, Entre em contato com a TI e Não envie o Boleto para o Cliente ! ')   
		    	lRet := .F.
			Endif 
		Endif				 
   	Endif 
   //	ElseIf xBanco == '001'//BANCO DO BRASIL 
   //     iF Alltrim(xConta) == '4908201'   
   // 	_cPrefixo := '03562'
  //Endif 
	
Return lret
                 

// Busca no cadastro de bancos as contas que Podem gerar Boleto por filial
User Function AGR95SEL()

	Local cQuery 	:= " "
	Local lRet   	:= .F.
	Local aItemsBCO := {}
	Local aREcnoSEE := {}
	Local aREcnoSA6 := {}
	Local nTamWindow := 100 
	
	DbSelectarea('SA6')
	IF SA6->(FieldPos("A6_XGERABO")) < 1 
		Return .F.
	Endif
		
	cQuery := " SELECT EE.R_E_C_N_O_ AS RECNOSEE, A6.R_E_C_N_O_ AS RECNOSA6, * FROM "+RetSqlName('SEE')+"(NOLOCK) EE " 
	cQuery += " INNER JOIN "+RetSqlName('SA6')+"(NOLOCK) A6  ON EE_CODIGO = A6_COD AND EE_CONTA = A6_NUMCON "
	cQuery += " AND A6_AGENCIA = EE_AGENCIA AND A6.D_E_L_E_T_ = '' AND A6_FILIAL = '"+xfilial('SA6')+"'  "	 
	cQuery += " WHERE EE_XGERABO = 'S' AND EE.D_E_L_E_T_ = '' AND A6_XGERABO = 'S' "
	cQuery += " ORDER BY EE_CODIGO "
		
	//Se não tiver gerado Sql nao seleciona a tabela 
	If Select("AGR95SEL") <> 0
  		dbSelectArea("AGR95SEL")
   		AGR95SEL->(dbclosearea())
  	Endif  
	
	TCQuery cQuery NEW ALIAS "AGR95SEL" 
	
	While AGR95SEL->(!eof())
	
		AADD(aItemsBCO,PADR(ALLTRIM(AGR95SEL->A6_NREDUZ),20,'_')+' '+/*AGR95SEL->A6_COD+*/'Ag.: '+AGR95SEL->A6_agencia+' / Conta: '+AGR95SEL->A6_NUMCON )
		AADD(aRecnoSEE,AGR95SEL->RECNOSEE)
		AADD(aRecnoSA6,AGR95SEL->RECNOSA6)
		
		nTamWindow += 25 
		
		AGR95SEL->(DbSkip())
	Enddo 	
	
	
	DEFINE DIALOG oDlgRAD TITLE "  ***  Selecione a Conta para geração de Boletos  ***  " FROM 080,080 TO nTamWindow,400/*200,275*/ PIXEL    
		nRadio := 0                         
		//aItems := {'Banco do Brasil','Sicoob','Bradesco','NYKE'/*,'Santander','Item05'*/} 
		 						//[nRow ], [ nCol ], [ aItems ], [ bSetGet ], [ oWnd ], [ uParam6 ], [ bChange ], [ nClrText ], [ nClrPane ], [ cMsg ], [ uParam11 ], [ bWhen ], [ nWidth ], [ nHeight ], [ bValid ], [ uParam16 ], [ uParam17 ], [ lPixel ], [ lHoriz ], [ lAutoHeight ] )
		oRadio := TRadMenu():New (10     ,       10,aItemsBCO  ,            ,oDlgRAD  ,            ,            ,             ,             ,         ,             ,          ,300        ,150         ,           ,             ,              ,.T.)     
		oRadio:bSetGet := {|u|Iif (PCount()==0,nRadio,nRadio:=u)}
		oRadio:bchange := {|u|oDlgRAD:end()}	  
		
	ACTIVATE DIALOG oDlgRAD CENTERED 
	
	//Se Selecionou - Posiciona na SEE e Mostra Msg de confirmação
	If nRadio > 0   
	    
	    //Posiciona Banco
	    DbSelectarea('SA6')
	    DbSetOrder(1)
	    Dbgoto(aRecnoSA6[nRadio])
	
	 	//Posiciona Parametro Bancario
		DbSelectarea('SEE')
		DbsetOrder(1)
		DbGoto(aREcnoSEE[nRadio])
	    
		lRet := .T.
	    
	Else
		lRet := .F.
	Endif 
	
Return lRet  


// Valida e mostra tela com o Banco escolhido
Static Function ValBanco(xBanco,xAgencia,xConta,xSubconta,xCarteira)  
     
	Local oDlgBco
	Local CONFIRMAR
	Local oBitmap1
	Local oButton1 
	Local oButton2 
	Local oSay0 
	Local oSay1
	Local oSay2
	Local oSay3 
	Local oSay4
	Local cImgBanco := ""  
	Local lRetMSG := .F.    
	Local cQuery 	 := " "
	Local aItemsBCO  := {}
	Local aItemRecno := {}
	Local nTamWindow := 0 
	Local nAjusLin   := 0 
	
	DbSelectarea('SA6')
	IF SA6->(FieldPos("A6_XGERABO")) < 1 .OR. SEE->(FieldPos("EE_XGERABO")) < 1
		Return .F.
	Endif

	cQuery := " SELECT EE.R_E_C_N_O_ AS RECNOSEE, * FROM "+RetSqlName('SEE')+"(NOLOCK) EE " 
	cQuery += " INNER JOIN "+RetSqlName('SA6')+"(NOLOCK) A6  ON EE_CODIGO = A6_COD AND EE_CONTA = A6_NUMCON "
	cQuery += " AND A6_AGENCIA = EE_AGENCIA AND A6.D_E_L_E_T_ = '' AND A6_FILIAL = '"+xfilial('SA6')+"'  "	 
	cQuery += " WHERE EE_XGERABO = 'S' AND EE.D_E_L_E_T_ = '' AND A6_XGERABO = 'S' " 
	cQuery += " AND EE_CODIGO  = '"+xBanco+"' "
	cQuery += " AND EE_AGENCIA = '"+xAgencia+"' "
	cQuery += " AND EE_CONTA   = '"+xConta+"' "
	cQuery += " AND EE_SUBCTA  = '"+xSubconta+"' "   
	cQuery += " AND A6_CART    = '"+xCarteira+"' "
	cQuery += " ORDER BY EE_CODIGO "
		
	//Se não tiver gerado Sql nao seleciona a tabela 
	If Select("AGR95SEL") <> 0
  		dbSelectArea("AGR95SEL")
   		AGR95SEL->(dbclosearea())
  	Endif  
	
	TCQuery cQuery NEW ALIAS "AGR95SEL" 
	
	If AGR95SEL->(eof()) 
		Alert(' Dados Bancários INVÁLIDOS! Verifique os parâmetros! ')
	    Return .F.
	Endif 
	    
	DEFINE FONT oFnt2 NAME "Arial" SIZE 20,30 
	
	//Busca Imagem  da sigaadv
	if xBanco == '756'
		cImgBanco := "logo_sicoob.BMP" 
	Elseif xBanco == '237'
		cImgBanco := "logo_bradesco.BMP"
	Elseif xBanco == '001'
		cImgBanco := "logo_bbrasil.BMP" 
	Elseif xBanco == '422'
		cImgBanco := "logo_safra.BMP" 		
	Endif

    DEFINE MSDIALOG oDlgBco TITLE "" FROM 000, 000  TO 220, 340 COLORS 0, 16777215 PIXEL
        If MV_PAR18 == 2  
	  		@ 003, 005 SAY oSay0 PROMPT "*** ATENÇÃO! MOSTRARÁ APENAS TÍTULOS DO PROJ. NYKE *** " SIZE 170, 007 OF oDlgBco COLORS 0, 16777215 PIXEL 
	  		nAjusLin :=  10
	    Endif
	    @ 004+nAjusLin, 005 SAY oSay1 PROMPT "Você selecionou o banco: " SIZE 100, 007 OF oDlgBco COLORS 0, 16777215 PIXEL    
	    If FILE(cImgBanco)
	    	@ 013+nAjusLin, 011 BITMAP oBitmap1 SIZE 190, 038 OF oDlgBco FILENAME cImgBanco NOBORDER PIXEL 
	    Else
	    	@ 014+nAjusLin, 005 SAY oSay4 PROMPT alltrim(AGR95SEL->A6_NREDUZ) FONT oFnt2 SIZE 100, 00 OF oDlgBco COLORS 0, 16777215 PIXEL
	    Endif
	    @ 050+nAjusLin, 008 SAY oSay2 PROMPT "Conta: " SIZE 022, 007 OF oDlgBco COLORS 0, 16777215 PIXEL
	    @ 060+nAjusLin, 024 SAY oSay3 PROMPT alltrim(xConta) FONT oFnt2  SIZE 100, 00 OF oDlgBco COLORS 0, 16777215 PIXEL
	    //@ 085, 020 BUTTON oButton1 PROMPT "&Cancelar"  SIZE 046, 012 OF oDlgBco PIXEL ACTION(lRetMSG := .F.,oDlgBco:END())
	    @ 085+nAjusLin, 065 BUTTON oButton2 PROMPT "&Confirmar" SIZE 046, 012 OF oDlgBco PIXEL ACTION(lRetMSG := .T.,oDlgBco:END())  
	    
    ACTIVATE MSDIALOG oDlgBco

Return lRetMSG  


Static Function Modulo10(cData)
Local L,D,P := 0
Local B     := .F.
   L := Len(cData)  //TAMANHO DE BYTES DO CARACTER
   B := .T.   
   D := 0     //DIGITO VERIFICADOR
   While L > 0 
      P := Val(SubStr(cData, L, 1))
      If (B) 
         P := P * 2
         If P > 9 
            P := P - 9
         End
      End
      D := D + P
      L := L - 1
      B := !B
   End
   D := 10 - (Mod(D,10))
   If D = 10
      D := 0
   End
Return(D)                                    


Static Function Modulo11(cData,cBanc)
Local L, D, P := 0  

If cBanc == "001"  // Banco do brasil
   L := Len(cdata)
   D := 0
   P := 10
   While L > 0 
      P := P - 1
      D := D + (Val(SubStr(cData, L, 1)) * P)
      If P = 2 
         P := 10
      End
      L := L - 1
   End
   D := mod(D,11)
   If D == 10
      D := "X"
   Else
      D := AllTrim(Str(D))
   End           
ElseIf cBanco == "237" .or. cBanco == "341" .Or. cBanco == "453" .Or. cBanco == "399" //.or. cBanco == "422" // Bradesco/Itau/Mercantil/Rural/HSBC/Safra
   L := Len(cdata)
   D := 0
   P := 1
   While L > 0 
      P := P + 1
      D := D + (Val(SubStr(cData, L, 1)) * P)
      If P = 9 
         P := 1
      End
      L := L - 1
   End
   D := 11 - (mod(D,11))  
   
   If (D == 10 .Or. D == 11) .and. (cBanc == "237" .or. cBanc == "341" .or. cBanc == "422")
      D := 1
   End
   If (D == 1 .Or. D == 0 .Or. D == 10 .Or. D == 11) .and. (cBanc == "289" .Or. cBanc == "453" .Or. cBanc == "399")
      D := 0
   End
   D := AllTrim(Str(D))
ElseIf cBanc == "389" //Mercantil
   L := Len(cdata)
   D := 0
   P := 1
   While L > 0 
      P := P + 1
      D := D + (Val(SubStr(cData, L, 1)) * P)
      If P = 9 
         P := 1
      End
      L := L - 1
   End   
   D := mod(D,11)
   If D == 1 .Or. D == 0
      D := 0
   Else
	   D := 11 - D
   End
   D := AllTrim(Str(D))
ElseIf cBanc == "479"  //BOSTON
   L := Len(cdata)
   D := 0
   P := 1
   While L > 0 
      P := P + 1
      D := D + (Val(SubStr(cData, L, 1)) * P)
      If P = 9 
         P := 1
      End
      L := L - 1
   End
   D := Mod(D*10,11)
   If D == 10
      D := 0
   End
   D := AllTrim(Str(D))
ElseIf cBanc == "409"  //UNIBANCO
   L := Len(cdata)
   D := 0
   P := 1
   While L > 0 
      P := P + 1
      D := D + (Val(SubStr(cData, L, 1)) * P)
      If P = 9 
         P := 1
      End
      L := L - 1
   End
   D := Mod(D*10,11)
   If D == 10 .or. D == 0
      D := 0
   End
   D := AllTrim(Str(D))
ElseIf cBanc == "356"  //Real
   L := Len(cdata)
   D := 0
   P := 1
   While L > 0 
      P := P + 1
      D := D + (Val(SubStr(cData, L, 1)) * P)
      If P = 9 
         P := 1
      End
      L := L - 1
   End
   D := Mod(D*10,11)
   If D == 10 .or. D == 0
      D := 0
   End
   D := AllTrim(Str(D))
ElseIf cBanco == "422"
   L := Len(cdata)
   D := 0
   P := 1
   While L > 0    
      P := P + 1
      D := D + (Val(SubStr(cData, L, 1)) * P)
      If P = 9 
         P := 1
      End
      L := L - 1
   End
   D := 11 - (mod(D,11))
   If (D == 10 .Or. D == 11)
      D := 1
   End
   D := AllTrim(Str(D))
Endif   
Return(D)     


//Relatório de Boletos Enviados 
User function AGR095R()   
     
	Local cQuery := ""
	Local cPerg := "AGR095R"   
	
	aRegistros := {}
	AADD(aRegistros,{cPerg,"01","Filial De         ?","mv_ch1","C",2,0,0,"G","","mv_par01","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"02","filial Ate        ?","mv_ch2","C",2,0,0,"G","","mv_par02","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"03","Emissao De        ?","mv_ch3","D",8,0,0,"G","","mv_par03","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"04","Emissao Ate       ?","mv_ch4","D",8,0,0,"G","","mv_par04","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"05","Serie De          ?","mv_ch5","C",3,0,0,"G","","mv_par05","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"06","Serie Ate         ?","mv_ch6","C",3,0,0,"G","","mv_par06","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"07","Nota De           ?","mv_ch7","C",TamSX3("F2_DOC")[1],0,0,"G","","mv_par07","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"08","Nota Ate          ?","mv_ch8","C",TamSX3("F2_DOC")[1],0,0,"G","","mv_par08","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"09","Cliente De        ?","mv_ch9","C",6,0,0,"G","","mv_par09","","","","","","","","","","","","","","","CLI"})
	AADD(aRegistros,{cPerg,"10","Cliente Ate       ?","mv_cha","C",6,0,0,"G","","mv_par10","","","","","","","","","","","","","","","CLI"})
	AADD(aRegistros,{cPerg,"11","Loja De           ?","mv_chb","C",2,0,0,"G","","mv_par11","","","","","","","","","","","","","","",""})
	AADD(aRegistros,{cPerg,"12","Loja Ate          ?","mv_chc","C",2,0,0,"G","","mv_par12","","","","","","","","","","","","","","",""})
	U_CriaPer(cPerg,aRegistros)
	       
	If !Pergunte(cPerg,.T.)
		Return 
    Endif
    
 	//Gera query com os Boleto a Ser gerado
    cQuery := ""
	cQuery := "SELECT F2_FILIAL,F2_DOC AS DOC, F2_SERIE AS SERIE, F2_CLIENTE AS CLIENTE, F2_LOJA AS LOJA, F2_EMISSAO AS EMISSAO, A1_NOME AS NOMECLI,"
	cQuery += "E1_XMAILBO,E1_PORTADO,E1_CONTA,E1_AGEDEP,E1_XDHENV "
	cQuery += "FROM " + RetSqlName("SF2") + " (NOLOCK) F2 " 
	cQuery += " INNER JOIN " + RetSqlName("SA1") +" (NOLOCK) A1 ON A1_COD = F2_CLIENTE AND A1_LOJA = F2_LOJA AND A1.D_E_L_E_T_ = '' AND "  
	cQuery += " A1_FILIAL = '"+xFilial('SA1')+"' "
	//Spiller - Trava para nao mostrar Títulos de outros portadores
	cQuery += " LEFT JOIN " + RetSqlName("SE1") + " (NOLOCK) E1 ON E1_FILIAL = '' AND "
	cQuery += "						E1_CLIENTE = F2_CLIENTE AND "
	cQuery += "						E1_LOJA   = F2_LOJA AND "
	cQuery += "						E1_PREFIXO = F2_FILIAL+Substring(LTRIM(F2_SERIE),1,1) AND "
	cQuery += "						E1_NUM = F2_DOC AND "
	cQuery += "					 	E1.D_E_L_E_T_ = '' "  
	//Fim
	cQuery += "WHERE F2.D_E_L_E_T_ <> '*' AND F2_COND <> '001' "
	cQuery += "AND F2_FILIAL  >= '" + mv_par01 + "' "
	cQuery += "AND F2_FILIAL  <= '" + mv_par02 + "' "
	cQuery += "AND F2_EMISSAO >= '" + dtos(mv_par03) + "' "
	cQuery += "AND F2_EMISSAO <= '" + dtos(mv_par04)  + "' "
	cQuery += "AND F2_SERIE   >= '" + mv_par05 + "' "
	cQuery += "AND F2_SERIE   <= '" + mv_par06 + "' "
	cQuery += "AND F2_DOC 	  >= '" + mv_par07 + "' "
	cQuery += "AND F2_DOC 	  <= '" + mv_par08 + "' "
	cQuery += "AND F2_CLIENTE >= '" + mv_par09 + "' "
	cQuery += "AND F2_CLIENTE <= '" + mv_par10 + "' "
	cQuery += "AND F2_LOJA 	  >= '" + mv_par11 + "' "
	cQuery += "AND F2_LOJA 	  <= '" + mv_par12 + "' "
	cQuery += "AND F2_XPROJ = '' "//<> '2' "//REMOVE BOLETOS DO PROJETO NYKE E RAIZEN    
	cQuery += "GROUP BY F2_FILIAL, F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA, F2_EMISSAO, A1_NOME,E1_XMAILBO,E1_PORTADO,E1_CONTA,E1_AGEDEP,E1_XDHENV "
	cQuery += "ORDER BY F2_FILIAL, F2_SERIE, F2_DOC, F2_CLIENTE, F2_LOJA, A1_NOME,E1_XMAILBO,E1_PORTADO,E1_CONTA,E1_AGEDEP "
	
	If Select("AGR095R") <> 0
		dbSelectArea("AGR095R")
		AGR095R->(dbCloseArea())
	Endif
	
	TCQuery cQuery NEW ALIAS "AGR095R"
	AGR095R->(DbGotop())     
	
	If AGR095R->(!eof())
		Processa({|lEnd| GeraCSV()})
	Else
		alert('Não há dados com os parâmetros informados!')
    Endif

Return


Static Function GeraCSV()
      
    Local cMSgRel      := ""  
	Local lPrimeiro    := .T. 
	Local nQtdReg      := 0 
	  
    //DbSelectArea('AGR095R')
   	Count To nQtdReg
   	AGR095R->(dbgotop())  
	
	ProcRegua(nQtdReg)

    //Varre a query
	While AGR095R->(!eof()) 
	    
		If lEnd
		   Return
		Endif
	      
		cMsgInc := " >>> Imprimindo Registro "+alltrim(AGR095R->DOC)+" ..."
		Incproc(cMsgInc)	      
	  	
	  	//se for Primeiro registro Gera Cabeçalho
	  	If lPrimeiro 
	  	      cMSgRel += 'Filial ;'
	  	      cMSgRel += 'Banco ;'
	  	      cMSgRel += 'Agencia ;'  
	  	      cMSgRel += 'Conta ;' 
		      cMSgRel += 'Documento ;'
		      cMSgRel += 'Serie ; '
		      cMSgRel += 'Cliente; '
		      cMSgRel += 'Loja.; '
		      cMSgRel += 'Emissao.; '
		      cMSgRel += 'Nome.Cliente; ' 
		      cMSgRel += 'Data-Hora-User de Envio; '
		      cMSgRel += 'E-Mail Enviado; ' +chr(13)
	  	   
	  		lPrimeiro := .F.
	  	Endif  

   		//F2_FILIAL,F2_DOC AS DOC, F2_SERIE AS SERIE, F2_CLIENTE AS CLIENTE, F2_LOJA AS LOJA, F2_EMISSAO AS EMISSAO, A1_NOME AS NOMECLI,E1_XMAILBO
       	cMSgRel += "'"+alltrim(AGR095R->F2_FILIAL)+"'"+";"  
       	cMSgRel += "'"+alltrim(AGR095R->E1_PORTADO)+"'"+";"//'Banco ;'
	  	cMSgRel += "'"+alltrim(AGR095R->E1_AGEDEP)+"'"+";"//'Agencia ;'  
	  	cMSgRel += "'"+alltrim(AGR095R->E1_CONTA)+"'"+";"//'Conta ;' 
      	cMSgRel += "'"+alltrim(AGR095R->DOC)+"'"+";"
      	cMSgRel += "'"+AGR095R->SERIE+"'"+";"
      	cMSgRel += "'"+AGR095R->CLIENTE+"'"+";"
      	cMSgRel += "'"+AGR095R->LOJA+"'"+";"
      	cMSgRel += DTOC(STOD(AGR095R->EMISSAO))+";"
      	cMSgRel += AGR095R->NOMECLI+";" 
      	cMSgRel += AGR095R->E1_XDHENV+";" 
      	cMSgRel += alltrim(AGR095R->E1_XMAILBO)+chr(13) 
    
    	AGR095R->(dbskip())  	
    
    Enddo
	
	cArq := 'AGR095R'+dtos(ddatabase)+''+SubStr( Time(), 1, 2 )+SubStr( Time(), 4, 2 )+SubStr( Time(), 7, 2 )+'.csv'
		
	//Grava Arquivo
	MEMOWRITE(cArq,cMSgRel)
	
	Incproc('Salvando Arquivo ...') 
	    
	If !ApOleClient("MsExcel")                     	
	 	MsgStop("Microsoft Excel nao instalado.")  //"Microsoft Excel nao instalado."
		Return	
	EndIf
		
	//Copia para temp e Abre no Excel
	__CopyFIle(cArq , AllTrim(GetTempPath())+cArq)             
		
	oExcelApp:= MsExcel():New()
	oExcelApp:WorkBooks:Open(AllTrim(GetTempPath())+cArq)//cArqTrbex+".XLS")
	oExcelApp:SetVisible(.T.)                       
				                 
	fErase(cArq) //Deletando arquivo de trabalho	

Return

//Busca Banco 
Static Function BuscaMail()
              
    Local cQuery   := ""
    Local aEmpBol  := {}
    Local cMailRet := ""    
    
    cQuery := " SELECT * FROM EMPRESAS "
	cQuery += " WHERE EMP_COD = '"+cEmpAnt+"' AND  EMP_FIL = '"+cFilAnt+"'  "   
	
	If Select("BUSCAMAIL") <> 0
		dbSelectArea("BUSCAMAIL")
		dbCloseArea()
	Endif
	
	TCQuery cQuery NEW ALIAS "BUSCAMAIL"

	BUSCAMAIL->(dbgotop())     
    
	If BUSCAMAIL->(!eof())
	    cMailRet := BUSCAMAIL->BOLETO_EMAIL 
	Endif 
	
Return cMailRet




/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ³AGR095Grava?Autor ?Wagner Xavier         ?Data ?26/05/92 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ³Rotina de Geracao do Arquivo de Remessa de Comunicacao      ³±?
±±?         ³Bancaria Banco Brasil                                       ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ³ExpL1:=AGR095Grava(ExpN1,ExpN2,ExpC1)                        ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?AGR095                                                    ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/
/*STATIC Function A095Grava( nTam,nDec,cConteudo,aBordero,lTrailler,lFinCnab2)
Local nRetorno := 1
Local cTecla   := ""
Local nX       := 1

lTrailler := IIF( lTrailler==NIL, .F., lTrailler ) // Para imprimir o trailler
                                                   // caso se deseje abandonar
                                                   // a geraÆo do arquivo
                                                   // de envio pela metade

lFinCnab2 := Iif( lFinCnab2 == Nil, .F., lFinCnab2 )

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?O retorno podera' ser :                                  ?
//?1 - Grava Ok                                             ?
//?2 - Ignora bordero                                       ?
//?3 - Abandona rotina                                      ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
While .T.

    //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
    //?Verifica se titulo ja' foi enviado                       ?
    //ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
    dbSelectArea("SEA")
    If (dbSeek(xFilial("SEA")+SE1->E1_NUMBOR+SE1->E1_PREFIXO+SE1->E1_NUM+SE1->E1_PARCELA+SE1->E1_TIPO))
        If SEA->EA_TRANSF == "S"
            nX := ASCAN(aBordero,SubStr(SE1->E1_NUMBOR,1,TamSX3("E1_NUMBOR")[1]))
            If nX == 0
					nOpc  := 0
					nTipo := 1
					aTipo := {OemToAnsi("Gera com esse bordero"),OemToAnsi("Ignora esse bordero")}

					@ 35,37 TO 188,383 Dialog oDialogos Title OemToAnsi("Bordero Existente")
					@ 11,07 SAY OemToAnsi("O borderO numero:") SIZE 58, 7 // "O border?n£mero:"
					@ 11,68 GET SE1->E1_NUMBOR When .F. SIZE 37, 10
					@ 24,07 SAY OemToAnsi("j?foi enviado ao banco.") SIZE 82, 7 // "j?foi enviado ao banco."
					@ 37,06 SAY OemToAnsi("Para prosseguir escolha uma das opäes")  //"Para prosseguir escolha uma das opäes"

					@ 45, 11 RADIO aTipo VAR nTipo // "Gera com esse border?###"Ignora esse border?

					DEFINE SBUTTON FROM 11, 140 TYPE 1 ENABLE OF oDialogos Action (nOpc:=1,oDialogos:End())
					DEFINE SBUTTON FROM 24, 140 TYPE 2 ENABLE OF oDialogos Action (nopc:=0,oDialogos:End())
					Activate Dialog oDialogos Centered

					If nOpc == 1
						If nTipo == 1
							nRetorno := 1
							nBorderos++
						Else
							nRetorno := 2
						EndIf
					Else
						nRetorno := 3
					EndIf				
            Else
                nRetorno := Int(Val(SubStr(aBordero[nX],7,1)))
            End
        End
    End
    If nRetorno == 1 .or. ( lTrailler .and. nBorderos > 0 )
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//?Analisa conteudo                                         ?
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF Empty(cConteudo)
			cCampo:=Space(nTam)
		Else
			lConteudo := A095Orig( cConteudo )
			IF !lConteudo
				Exit
			Else
				IF ValType(xConteudo)="D"
					cCampo := GravaData(xConteudo,.F.)
				Elseif ValType(xConteudo)="N"
					cCampo:=Substr(Strzero(xConteudo,nTam,nDec),1,nTam)
				Elseif ValType(xConteudo)="C"
					cCampo:=Substr(xConteudo,1,nTam)
				Else
					cCampo:= Iif(xConteudo,"S","N")
				End
			End
		End
		If Len(cCampo) < nTam  //Preenche campo a ser gravado, caso menor
			cCampo:=cCampo+Space(nTam-Len(cCampo))
		End
		Fwrite( nHdlSaida,cCampo,nTam )
	 EndIf
    If nX == 0
        Aadd(aBordero,Substr(SE1->E1_NUMBOR,1,TamSX3("E1_NUMBOR")[1])+Str(nRetorno,1))
    End
    Exit
End
Return nRetorno
*/
/*

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ³AbrePar   ?Autor ?Wagner Xavier         ?Data ?26/11/03 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ³Abre arquivo de Parametros Banco Brasil                     ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ³AbrePar()                                                   ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ³AGR095                                                     ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/ /*
Static Function AbrePar()
LOCAL cArqEnt:=mv_par11,cArqSaida

IF AT(".",mv_par12)>0
	cArqSaida:=SubStr(TRIM(mv_par12),1,AT(".",mv_par12)-1)+"."+TRIM(SEE->EE_EXTEN)
Else
	cArqSaida:=TRIM(mv_par12)+"."+TRIM(SEE->EE_EXTEN)
EndIF

IF !FILE(cArqEnt)
	Help(" ",1,"NOARQPAR")
	Return .F.
Else
	nHdlBco:=FOPEN(cArqEnt,0+64)
EndIF

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//?Cria Arquivo Saida                                       ?
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nHdlSaida:=MSFCREATE(cArqSaida,0)
Return .T.
*/
/*
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ³AGR095Orig ?Autor ?Wagner Xavier         ?Data ?10/11/92 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ³Verifica se expressao e' valida para Remessa CNAB.          ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ³AGR095                                                     ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/ /*
Static Function A095Orig( cForm )
Local bBlock:=ErrorBlock(),bErro := ErrorBlock( { |e| ChecErr260(e,cForm) } )
Private lRet := .T.

BEGIN SEQUENCE
	xConteudo := &cForm
END SEQUENCE
ErrorBlock(bBlock)
Return lRet */
/*
/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±?
±±³Funo    ?SomaValor?Autor ?Vinicius Barreira     ?Data ?09/01/95 ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±?
±±³Descrio ?Retorna o valor total dos titulos remetidos                ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±³Sintaxe   ?SomaValor()                                                ³±?
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±?
±±?Uso      ?Generico                                                   ³±?
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±?
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±?
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß?
/*/ /*
Static Function SomaValor()
Return nSomaValor * 100

Static Function A095Process(oDlg,oMeter)
Local ni
oMeter:nTotal := 1000
oMeter:Set(0)
For ni:= 1 to 1000
	oMeter:Set(ni)
	SysRefresh(.t.)
Next
oDlg:End()
Return Nil */
