SELECT M0_NOMECOM Empresa, M0_ESTENT UF_Empresa, FT_FILIAL Filial, FT_TIPOMOV Tipo_Mov, FT_TIPO Tipo_Doc, FT_ESTADO UF_Cli_For, FT_CFOP CFOP, CF.X5_DESCRI Descr_CFOP, FT_POSIPI NCM, FT_AGREG Agrega_Valor, COALESCE(A1_PESSOA, A2_TIPO) Tipo_Pessoa, COALESCE(A1_TIPO, A2_TPESSOA) Tipo, COALESCE(A1_TPJ, A2_TPJ) Tipo_Jur, COALESCE(A1_CONTRIB, A2_CONTRIB) Contrib, COALESCE(A1_SIMPNAC, A2_SIMPNAC) Optante_SN, COALESCE(A1_GRPTRIB,A2_GRPTRIB) Grupo_Trib, FT_CTIPI Cod_IPI, UPPER( CIPI.X5_DESCRI ) Descr_IPI, FT_ALIQIPI Aliq_IPI, SUBSTRING(FT_CLASFIS,1,1) Origem, SUBSTRING(FT_CLASFIS,2,2) Cod_ICMS, UPPER( CICM.X5_DESCRI ) Descr_ICMS, CASE WHEN FT_BASEICM = FT_VALCONT THEN 'S' ELSE 'N' END Bs_ICMS_Ctb, FT_ALIQICM Aliq_ICMS, ROUND( FT_BASEICM / CASE WHEN (FT_VALCONT - FT_VALIPI) = 0 THEN 1 ELSE (FT_VALCONT - FT_VALIPI) END, 4 ) Red_Bs_ICMS, FT_MARGEM Margem_Pres, FT_ALIQTST Aliq_Transp, FT_CSTPIS Cod_PIS, UPPER( CPIS.X5_DESCRI ) Descr_PIS, FT_ALIQPIS Aliq_PIS, FT_CSTCOF Cod_COF, UPPER( CCOF.X5_DESCRI ) Descr_COF, FT_ALIQCOF Aliq_COFINS, FT_TNATREC Tab_Rec, FT_CNATREC Cod_Rec, FT_MALQPIS Aliq_Maj_PIS, FT_MVALPIS Val_Maj_PIS, FT_MALQCOF Aliq_Maj_COFINS, FT_MVALCOF Val_Maj_COFINS, FT_CSTISS Cod_ISS, UPPER( COALESCE(CISS.X5_DESCRI,'') ) Descr_ISS, FT_CODISS Cod_Serv_ISS, FT_CNAE CNAE, FT_TRIBMUN Cod_Trib_Munic, MAX( FT_ENTRADA ) Ultima_Mov, COUNT(*) Ocorrencias FROM SFT010 SFT INNER JOIN SYS_COMPANY SM0 ON SM0.D_E_L_E_T_ = ' ' AND M0_CODIGO = '01' AND M0_CODFIL = FT_FILIAL LEFT JOIN SX5010 CF ON CF.D_E_L_E_T_ = ' ' AND CF.X5_FILIAL = '  ' AND CF.X5_TABELA = '13' AND CF.X5_CHAVE = FT_CFOP LEFT JOIN SX5010 CICM ON CICM.D_E_L_E_T_ = ' ' AND CICM.X5_FILIAL = '  ' AND CICM.X5_TABELA = 'S2' AND SUBSTRING(CICM.X5_CHAVE,1,2) = SUBSTRING(FT_CLASFIS,2,2) LEFT JOIN SX5010 CIPI ON CIPI.D_E_L_E_T_ = ' ' AND CIPI.X5_FILIAL = '  ' AND CIPI.X5_TABELA = 'S3' AND SUBSTRING(CIPI.X5_CHAVE,1,2) = FT_CTIPI LEFT JOIN SX5010 CPIS ON CPIS.D_E_L_E_T_ = ' ' AND CPIS.X5_FILIAL = '  ' AND CPIS.X5_TABELA = 'SX' AND SUBSTRING(CPIS.X5_CHAVE,1,2) = FT_CSTPIS LEFT JOIN SX5010 CCOF ON CCOF.D_E_L_E_T_ = ' ' AND CCOF.X5_FILIAL = '  ' AND CCOF.X5_TABELA = 'SX' AND SUBSTRING(CCOF.X5_CHAVE,1,2) = FT_CSTCOF LEFT JOIN SX5010 CISS ON CISS.D_E_L_E_T_ = ' ' AND CISS.X5_FILIAL = '  ' AND CISS.X5_TABELA = 'S9' AND SUBSTRING(CISS.X5_CHAVE,1,2) = FT_CSTISS LEFT JOIN SD1010 SD1 ON SD1.D_E_L_E_T_ = ' ' AND D1_FILIAL = FT_FILIAL AND D1_DOC = FT_NFISCAL AND D1_SERIE = FT_SERIE AND D1_FORNECE = FT_CLIEFOR AND D1_LOJA = FT_LOJA AND D1_ITEM = FT_ITEM AND FT_TIPOMOV = 'E' LEFT JOIN SD2010 SD2 ON SD2.D_E_L_E_T_ = ' ' AND D2_FILIAL = FT_FILIAL AND D2_DOC = FT_NFISCAL AND D2_SERIE = FT_SERIE AND D2_CLIENTE = FT_CLIEFOR AND D2_LOJA = FT_LOJA AND D2_ITEM = FT_ITEM AND FT_TIPOMOV = 'S' LEFT JOIN SF4010 SF4 ON SF4.D_E_L_E_T_ = ' ' AND F4_FILIAL = '  ' AND ( ( FT_TIPOMOV = 'E' AND F4_CODIGO = D1_TES ) OR ( FT_TIPOMOV = 'S' AND F4_CODIGO = D2_TES ) ) LEFT JOIN SA1010 SA1 ON SA1.D_E_L_E_T_ = ' ' AND    A1_FILIAL = ' '  AND A1_COD = FT_CLIEFOR AND A1_LOJA = FT_LOJA AND ( ( FT_TIPOMOV = 'S' AND D2_TIPO NOT IN ('D','B') ) OR ( FT_TIPOMOV = 'E' AND D1_TIPO IN ('D','B') ) ) LEFT JOIN SA2010 SA2 ON SA2.D_E_L_E_T_ = ' ' AND    A2_FILIAL = ' '  AND A2_COD = FT_CLIEFOR AND A2_LOJA = FT_LOJA AND ( ( FT_TIPOMOV = 'E' AND D1_TIPO NOT IN ('D','B') ) OR ( FT_TIPOMOV = 'S' AND D2_TIPO IN ('D','B') ) ) WHERE SFT.D_E_L_E_T_ = ' ' AND FT_DTCANC = ' ' AND FT_ENTRADA BETWEEN  '20230901' AND  '20250831' GROUP BY M0_NOMECOM, M0_ESTENT, FT_FILIAL, FT_TIPOMOV, FT_TIPO, FT_ESTADO, FT_CFOP, CF.X5_DESCRI, FT_POSIPI, FT_AGREG, COALESCE(A1_PESSOA, A2_TIPO), COALESCE(A1_TIPO, A2_TPESSOA), COALESCE(A1_TPJ, A2_TPJ), COALESCE(A1_CONTRIB, A2_CONTRIB), COALESCE(A1_SIMPNAC, A2_SIMPNAC), COALESCE(A1_GRPTRIB,A2_GRPTRIB), FT_CTIPI, CIPI.X5_DESCRI, FT_ALIQIPI, SUBSTRING(FT_CLASFIS,1,1), SUBSTRING(FT_CLASFIS,2,2), CICM.X5_DESCRI, CASE WHEN FT_BASEICM = FT_VALCONT THEN 'S' ELSE 'N' END, FT_ALIQICM, ROUND( FT_BASEICM / CASE WHEN (FT_VALCONT - FT_VALIPI) = 0 THEN 1 ELSE (FT_VALCONT - FT_VALIPI) END, 4 ), FT_MARGEM, FT_ALIQTST, FT_CSTPIS, CPIS.X5_DESCRI, FT_ALIQPIS, FT_CSTCOF, CCOF.X5_DESCRI, FT_ALIQCOF, FT_TNATREC, FT_CNATREC, FT_MALQPIS, FT_MVALPIS, FT_MALQCOF, FT_MVALCOF, FT_CSTISS, CISS.X5_DESCRI, FT_CODISS, FT_CNAE, FT_TRIBMUN ORDER BY 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
 